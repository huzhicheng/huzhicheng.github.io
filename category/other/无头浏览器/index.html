<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage><head><meta name=generator content="Hugo 0.119.0"><meta charset=utf-8><title>剑走偏锋，无头浏览器是什么神奇的家伙 · 古时的风筝</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="浏览器是再熟悉不过的东西了，几乎每个人用过，比如 Chrome、FireFox、Safari，尤其是我们程序员，可谓开发最强辅助，摸鱼最好的伴"><meta name=360-site-verification content="e75339f1cfcde17f66f71aaf8b6983e9"><meta name=keywords content="Hugo,theme,编程,java,ChatGPT,程序员,开发"><link rel=canonical href=https://www.moonkite.cn/category/other/%E6%97%A0%E5%A4%B4%E6%B5%8F%E8%A7%88%E5%99%A8/><link rel=icon href=https://www.moonkite.cn/images/photo.png><link rel=stylesheet href=https://cdn.staticfile.org/twitter-bootstrap/4.1.3/css/bootstrap.min.css><link rel=stylesheet href=https://www.moonkite.cn/css/den.css><link href=https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/lxgwwenkaiscreen.min.css rel=stylesheet><meta property="og:title" content="剑走偏锋，无头浏览器是什么神奇的家伙"><meta property="og:description" content="浏览器是再熟悉不过的东西了，几乎每个人用过，比如 Chrome、FireFox、Safari，尤其是我们程序员，可谓开发最强辅助，摸鱼最好的伴"><meta property="og:type" content="article"><meta property="og:url" content="https://www.moonkite.cn/category/other/%E6%97%A0%E5%A4%B4%E6%B5%8F%E8%A7%88%E5%99%A8/"><meta property="article:section" content="category"><meta property="article:published_time" content="2023-07-13T08:56:23+08:00"><meta property="article:modified_time" content="2023-07-13T08:56:23+08:00"><meta itemprop=name content="剑走偏锋，无头浏览器是什么神奇的家伙"><meta itemprop=description content="浏览器是再熟悉不过的东西了，几乎每个人用过，比如 Chrome、FireFox、Safari，尤其是我们程序员，可谓开发最强辅助，摸鱼最好的伴"><meta itemprop=datePublished content="2023-07-13T08:56:23+08:00"><meta itemprop=dateModified content="2023-07-13T08:56:23+08:00"><meta itemprop=wordCount content="4294"><meta itemprop=keywords content="无头浏览器,Embedding,"><meta name=twitter:card content="summary"><meta name=twitter:title content="剑走偏锋，无头浏览器是什么神奇的家伙"><meta name=twitter:description content="浏览器是再熟悉不过的东西了，几乎每个人用过，比如 Chrome、FireFox、Safari，尤其是我们程序员，可谓开发最强辅助，摸鱼最好的伴"></head><body><div class=header-container style=background:linear-gradient(rgba(0,0,0,.2),rgba(0,0,0,.2)),url(https://hexo.moonkite.cn/blog/background.png);background-position:top;background-size:cover><div class=container><nav class="header-nav navbar navbar-expand-md navbar-dark light-dark"><div class="header-logo navbar-brand"><a class=float-left href=https://www.moonkite.cn/></a></div><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="nav-menu collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a href=https://www.moonkite.cn/ class=nav-link><i class="fas fad fa-h-square"></i>主页</a></li><li class=nav-item><a href=https://www.moonkite.cn/category/notes class=nav-link><i class='fas fa-yin-yang'></i>生活随笔</a></li><li class=nav-item><a href=javascript:void(0) class=nav-link><i class='fas fa-laptop-code'></i>技术文章</a><div class=sub-dropdown-menu><a class=sub-nav-link href=https://www.moonkite.cn/category/java><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"><path fill="#f44336" d="M23.65 24.898c-.998-1.609-1.722-2.943-2.725-5.455C19.229 15.2 31.24 11.366 26.37 3.999c2.111 5.089-7.577 8.235-8.477 12.473-.823 3.898 5.752 8.426 5.757 8.426z"/><path fill="#f44336" d="M23.878 17.27c-.192 2.516 2.229 3.857 2.299 5.695.056 1.496-1.447 2.743-1.447 2.743s2.728-.536 3.579-2.818c.945-2.534-1.834-4.269-1.548-6.298.267-1.938 6.031-5.543 6.031-5.543S24.311 11.611 23.878 17.27z"/><g><path fill="#1565c0" d="M32.084 25.055c1.754-.394 3.233.723 3.233 2.01.0 2.901-4.021 5.643-4.021 5.643s6.225-.742 6.225-5.505c0-3.15-3.057-3.937-5.437-2.148zm-2.955 2.34s1.941-1.383 2.458-1.902c-4.763 1.011-15.638 1.147-15.638.269.0-.809 3.507-1.638 3.507-1.638s-7.773-.112-7.773 2.181C11.683 28.695 21.858 28.866 29.129 27.395z"/><path fill="#1565c0" d="M27.935 29.571c-4.509 1.499-12.814 1.02-10.354-.993-1.198.0-2.974.963-2.974 1.889.0 1.857 8.982 3.291 15.63.572l-2.302-1.468z"/><path fill="#1565c0" d="M18.686 32.739c-1.636.0-2.695 1.054-2.695 1.822.0 2.391 9.76 2.632 13.627.205l-2.458-1.632C24.271 34.404 17.014 34.579 18.686 32.739z"/><path fill="#1565c0" d="M36.281 36.632c0-.936-1.055-1.377-1.433-1.588 2.228 5.373-22.317 4.956-22.317 1.784.0-.721 1.807-1.427 3.477-1.093l-1.42-.839C11.26 34.374 9 35.837 9 37.017 9 42.52 36.281 42.255 36.281 36.632z"/><path fill="#1565c0" d="M39 38.604c-4.146 4.095-14.659 5.587-25.231 3.057C24.341 46.164 38.95 43.628 39 38.604z"/></g></svg>&nbsp;可爱的 Java</a>
<a class=sub-nav-link href=https://www.moonkite.cn/category/SpringCloud><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48"><path fill="#8bc34a" d="M43.982 23.635c.069-4.261-.891-9.328-2.891-15.273L39.523 3.7l-2.13 4.433c-.114.237-.244.469-.38.698C33.514 5.827 28.974 4 24 4 12.954 4 4 12.954 4 24s8.954 20 20 20 20-8.954 20-20C44 23.877 43.984 23.758 43.982 23.635z"/><path fill="#fff" d="M39.385 32.558C36.262 36.86 30.734 37.091 25.531 37H18.75h-1.938c4.428-1.593 7.063-1.972 9.754-3.4 5.068-2.665 10.078-8.496 11.121-14.562-1.93 5.836-7.779 10.85-13.109 12.889-3.652 1.393-10.248 2.745-10.248 2.745l-.267-.145C9.573 32.268 9.437 22.214 17.6 18.968c3.574-1.423 6.993-.641 10.854-1.593 4.122-1.012 8.89-4.208 10.83-8.375C41.456 15.667 44.07 26.106 39.385 32.558zM15.668 38.445C15.386 38.795 14.955 39 14.505 39c-.823.0-1.495-.677-1.495-1.5s.677-1.5 1.495-1.5c.341.0.677.118.941.336C16.086 36.855 16.186 37.805 15.668 38.445z"/></svg>&nbsp; Spring Cloud 系列</a>
<a class=sub-nav-link href=https://www.moonkite.cn/category/other><img width=20 height=20 src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAADWElEQVR4nO2X30tTYRjH9xd4X2Dsol1EEtJdEFiSF10pldlVaVHEjiFFkKQVQeV0kfSTHdfW1pzKlpZtzXJuzp2pmzPFTdmUTdLJlEAvNKyB8MYzPG/visHZ2jxrnQc+8PCc85zz/e592XkfkUgIIYT4v2OoTVrtVFDTjILaYmgK8YqC2oproalzKZlwKqga3sXTSeFuZts9ykWcNOXnbITcTj67IRQcG1rlE5/dECK3GXcjxC8ADwqMuxGfBMeGVklNaRmZ83z0L3+ZR3ywMBfInJHQqGl07esKAmYjK6hnJoph64Ar/KsOOXmNK6HOTszKtD9uJitGQGSRcQFDiqh1RHAd8nSMWMQSDJgRjLAhrIgxta3lDvaiRlMpxvKvbi3BCNfI+xVRehdRIT2DIUWdejeH65BzMWKd1KO6jqOYLrEE46fp7Bm5bgki0Q0bhhS1t3UM1yHnYuS1XY5Oy0swD8USjPNmQ2aNfO6WO0KjphHgbrc9XNjsirGwdeAY7Vpl65CT15LRYb4VltLHYyzKAwcxgw3Xwr5BQ9D9ll53dz9d+msjfNLfWoO6GstR7/0zCXXBCJMPKxLMl3kkmC9GQsTf706znK3vyKLdhtznL2ISPm5TaqQdro8DeTJxm4EHKDZRGQfy308HtdvAcJY1I3BsII8RpAgwwB41IE9mBAwgR0EcyMlrRcTxB45DgpFUV+RbSIMxuq4kXRFyFl+3VuTeiqBtQYCDqUxqhOyJPCsTjDDCitB5urW8zS2oTSzBxNS7MB3tpeiC4kicO8azCQLJnkB9Me750Xs44b4CmQcjc4SzZwSGHXL42Xy0B6NTHMIDUp36RIJAsmeS2od7vuuKE+4TEUMbDHGZMLLBNrlUV/3u9sYRwH7vkq/nZFmUJaotwfRoK5bk6qoooNRUh9kegOyZkpUtsT3zuvKE+6qev4myKF899nkNTeMTJuWsu6spTBjZ4GzESUv7+R6qmCQ4aeoTZyPDLy4XMTS1xrdo5k/WmDbpflEq4XpJ7XbS1O0+bYvnve7JLNCnkXkZWmrYCfo0Mi9+r7bFA1pAkyjd0Ov1EZVKhQDI034Q3++1mM39H8xmBECeEZV8vNdmtRptAwMojtVqzIjKHH6vEEIIIcrt+AnU4LBcH67z1wAAAABJRU5ErkJggg=="> &nbsp; 杂七杂八</a></div></li><li class=nav-item><a href=https://www.moonkite.cn/category/network class=nav-link><i class="fas fa-network-wired"></i>轻解计算机网络</a></li><li class=nav-item><a href=https://www.moonkite.cn/category/product class=nav-link><i class="fas fab fa-medapps"></i>我的产品</a></li></ul></div></nav></div><div class="container header-wrapper"><div class=row><div class=col-lg-12><div class=header-content><h1 class=header-title>剑走偏锋，无头浏览器是什么神奇的家伙</h1><p class=header-date>作者：
风筝 /
2023-07-13<div class=header-underline></div><div class=clearfix></div><p class="float-right header-tags"><i class="fas fa-tags" aria-hidden=true></i>
<a href=https://www.moonkite.cn/tag/Embedding/>Embedding</a>,
<a href=https://www.moonkite.cn/tag/%E6%97%A0%E5%A4%B4%E6%B5%8F%E8%A7%88%E5%99%A8/>无头浏览器</a></p></div></div></div></div></div><main><div class="container content"><article><p><img src=https://hexo.moonkite.cn/blog/%E6%97%A0%E5%A4%B4%E6%B5%8F%E8%A7%88%E5%99%A8.png alt></p><p>浏览器是再熟悉不过的东西了，几乎每个人用过，比如 Chrome、FireFox、Safari，尤其是我们程序员，可谓开发最强辅助，摸鱼最好的伴侣。</p><p>浏览器能干的事儿，无头浏览器都能干，而且很多时候比标准浏览器还要更好用，而且能实现一些很好玩儿的功能，我们能借助无头浏览器比肩标准浏览器强大的功能，而且又能灵活的用程序控制的特性，做出一些很有意思的产品功能来，稍后我们细说。</p><h2 id=什么是浏览器>什么是浏览器</h2><p>关于浏览器还有一个很好玩儿的梗，对于一些对计算机、对互联网不太了解的同学，你跟他说浏览器，他/她就默认是百度了，因为好多小白的浏览器都设置了百度为默认页面。所以很多小白将浏览器和搜索引擎（99%是百度）划等号了。</p><p><img src=https://hexo.moonkite.cn/blog/image-20230606155021528.png alt></p><p>浏览器里我百分之99的时间都是用 Chrome，不过有一说一，这玩意是真耗内存，我基本上是十几、二十几个的 tab 开着，再加上几个 IDEA 进程，16G 的内存根本就不够耗的。</p><p>以 Chrome 浏览器为例，Chrome 由以下几部分组成：</p><ol><li>渲染引擎（Rendering Engine）：Chromium使用的渲染引擎主要有两个选项：WebKit和Blink。WebKit是最初由苹果开发的渲染引擎，后来被Google采用并继续开发。Blink则是Google从WebKit分支出来并进行独立开发的渲染引擎，目前Chromium主要使用Blink作为其默认的渲染引擎。</li><li>JavaScript引擎（JavaScript Engine）：Chromium使用V8引擎作为其JavaScript引擎。V8是由Google开发的高性能JavaScript引擎，它负责解析和执行网页中的JavaScript代码。</li><li>网络栈（Network Stack）：Chromium的网络栈负责处理网络通信。它支持各种网络协议，包括HTTP、HTTPS、WebSocket等，并提供了网络请求、响应处理和数据传输等功能。</li><li>布局引擎（Layout Engine）：Chromium使用布局引擎来计算网页中元素的位置和大小，并确定它们在屏幕上的布局。布局引擎将CSS样式应用于DOM元素，并计算它们的几何属性。</li><li>绘制引擎（Painting Engine）：绘制引擎负责将网页内容绘制到屏幕上，生成最终的图像。它使用图形库和硬件加速技术来高效地进行绘制操作。</li><li>用户界面（User Interface）：Chromium提供了用户界面的支持，包括地址栏、标签页、书签管理、设置等功能。它还提供了扩展和插件系统，允许用户根据自己的需求进行个性化定制。</li><li>其他组件：除了上述主要组件外，Chromium还包括其他一些辅助组件，如存储系统、安全模块、媒体处理、数据库支持等，以提供更全面的浏览器功能。</li></ol><p>Chrome 浏览器光源码就有十几个G，2000多万行代码，可见，要实现一个功能完善的浏览器是一项浩大的工程。</p><h2 id=什么是无头浏览器>什么是无头浏览器</h2><p>无头浏览器（Headless Browser）是一种浏览器程序，没有图形用户界面（GUI），但能够执行与普通浏览器相似的功能。无头浏览器能够加载和解析网页，执行JavaScript代码，处理网页事件，并提供对DOM（文档对象模型）的访问和操作能力。</p><p>与传统浏览器相比，无头浏览器的主要区别在于其没有可见的窗口或用户界面。这使得它在后台运行时，不会显示实际的浏览器窗口，从而节省了系统资源，并且可以更高效地执行自动化任务。</p><p>常见的无头浏览器包括Headless Chrome（Chrome的无头模式）、PhantomJS、Puppeteer（基于Chrome的无头浏览器库）等。它们提供了编程接口，使开发者能够通过代码自动化控制和操作浏览器行为。</p><p>无头浏览器其实就是看不见的浏览器，所有的操作都要通过代码调用 API 来控制，所以浏览器能干的事儿，无头浏览器都能干，而且很多事儿做起来比标准的浏览器更简单。</p><p>我举几个常用的功能来说明一下无头浏览器的主要使用场景</p><ol><li><strong>自动化测试：</strong> 无头浏览器可以模拟用户行为，执行自动化测试任务，例如对网页进行加载、表单填写、点击按钮、检查页面元素等。</li><li><strong>数据抓取：</strong> 无头浏览器可用于爬取网页数据，自动访问网站并提取所需的信息，用于数据分析、搜索引擎优化等。</li><li><strong>屏幕截图：</strong> 无头浏览器可以加载网页并生成网页的截图，用于生成快照、生成预览图像等。</li><li><strong>服务器端渲染：</strong> 无头浏览器可以用于服务器端渲染（Server-side Rendering），将动态生成的页面渲染为静态HTML，提供更好的性能和搜索引擎优化效果。</li><li>生成 PDF 文件：使用浏览器自带的生成 PDF 功能，将目标页面转换成 PDF 。</li></ol><h2 id=使用无头浏览器做一些好玩的功能>使用无头浏览器做一些好玩的功能</h2><p>开篇就说了使用无头浏览器可以实现一些好玩儿的功能，这些功能别看不大，但是使用场景还是很多的，有些开发者就是抓住这些小功能，开发出好用的产品，运气好的话还能赚到钱，尤其是在国外市场。（在国内做收费的产品确实不容易赚到钱）</p><p>下面我们就来介绍两个好玩儿而且有用的功能。</p><p>前面的自动化测试、服务端渲染就不说了。</p><p>自动化测试太专业了，一般用户用不到，只有开发者或者测试工程师用。</p><p>服务端渲染使用无头浏览器确实没必要，因为有太多成熟的方案了，连 React 都有服务端渲染的能力(RSC)。</p><h3 id=网页截图功能>网页截图功能</h3><p>我们可能见过一些网站提供下载文字卡片或者图文卡片的功能。比如读到一段想要分享的内容，选中之后将文本端所在的区域生成一张图片。</p><p><img src=https://hexo.moonkite.cn/blog/image-20230606114154145.png alt></p><p>其实就是通过调用浏览器自身的 API <code>page.screenshot</code>，可以对整个页面或者选定的区域生成图片。</p><p>通过这个方法，我们可以做一个浏览器插件，用户选定某个区域后，直接生成对应的图片。这类功能在手机APP上很常见，在浏览器上一搬的网站都不提供。</p><p>说到这儿好像和无头浏览器都没什么关系吧，这都是标准浏览器中做的事儿，用户已经打开了页面，在浏览器上操作自己看到的内容，顺理成章。</p><p>但是如果这个操作是批量的呢，或者是在后台静默完成的情况呢？</p><p>那就需要无头浏览器来出手了，无头浏览器虽然没有操作界面，但是也具备绘制引擎的完整功能，仍然可以生成图像，利用这个功能，就可以批量的、静默生成图像了，并且可以截取完整的网页或者部分区域。</p><p>Puppeteer 是无头浏览器中的佼佼者，提供了简单好用的 API ，不过是 nodejs 版的。</p><p>如果是用 Java 开发的话，有一个替代品，叫做 Jvppeteer，提供了和 Puppeteer 几乎一模一样的 API。</p><p>下面这段代码就展示了如何用 Jvppeteer 来实现网页的截图。</p><p>下面这个方法是对整个网页进行截图，只需要给定网页 url 和 最终的图片路径就可以了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>screenShotWx</span><span class=o>(</span><span class=n>String</span> <span class=n>url</span><span class=o>,</span> <span class=n>String</span> <span class=n>path</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span><span class=o>,</span> <span class=n>ExecutionException</span><span class=o>,</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>BrowserFetcher</span><span class=o>.</span><span class=na>downloadIfNotExist</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>arrayList</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// MacOS 要这样写，指定Chrome的位置
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>String</span> <span class=n>executablePath</span> <span class=o>=</span> <span class=s>&#34;/Applications/Google Chrome.app/Contents/MacOS/Google Chrome&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>LaunchOptions</span> <span class=n>options</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LaunchOptionsBuilder</span><span class=o>().</span><span class=na>withExecutablePath</span><span class=o>(</span><span class=n>executablePath</span><span class=o>).</span><span class=na>withArgs</span><span class=o>(</span><span class=n>arrayList</span><span class=o>).</span><span class=na>withHeadless</span><span class=o>(</span><span class=kc>true</span><span class=o>).</span><span class=na>withIgnoreHTTPSErrors</span><span class=o>(</span><span class=kc>true</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Windows 和 Linux 这样就可以，不用指定 Chrome 的安装位置
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>//LaunchOptions options = new LaunchOptionsBuilder().withArgs(arrayList).withHeadless(true).withIgnoreHTTPSErrors(true).build();
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--no-sandbox&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--disable-setuid-sandbox&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--ignore-certificate-errors&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--disable-gpu&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--disable-web-security&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--disable-infobars&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--disable-extensions&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--disable-bundled-ppapi-flash&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--allow-running-insecure-content&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--mute-audio&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Browser</span> <span class=n>browser</span> <span class=o>=</span> <span class=n>Puppeteer</span><span class=o>.</span><span class=na>launch</span><span class=o>(</span><span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Page</span> <span class=n>page</span> <span class=o>=</span> <span class=n>browser</span><span class=o>.</span><span class=na>newPage</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>page</span><span class=o>.</span><span class=na>setJavaScriptEnabled</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>page</span><span class=o>.</span><span class=na>setUserAgent</span><span class=o>(</span><span class=s>&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36 Edg/83.0.478.37&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>page</span><span class=o>.</span><span class=na>setCacheEnabled</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>page</span><span class=o>.</span><span class=na>onConsole</span><span class=o>((</span><span class=n>msg</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;==&gt; {}&#34;</span><span class=o>,</span> <span class=n>msg</span><span class=o>.</span><span class=na>text</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>PageNavigateOptions</span> <span class=n>pageNavigateOptions</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PageNavigateOptions</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>pageNavigateOptions</span><span class=o>.</span><span class=na>setTimeout</span><span class=o>(</span><span class=mi>1000000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>//dom加载完毕就算导航完成
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>pageNavigateOptions</span><span class=o>.</span><span class=na>setWaitUntil</span><span class=o>(</span><span class=n>Collections</span><span class=o>.</span><span class=na>singletonList</span><span class=o>(</span><span class=s>&#34;domcontentloaded&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=n>page</span><span class=o>.</span><span class=na>goTo</span><span class=o>(</span><span class=n>url</span><span class=o>,</span> <span class=n>pageNavigateOptions</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>autoScroll</span><span class=o>(</span><span class=n>page</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>ElementHandle</span> <span class=n>body</span> <span class=o>=</span> <span class=n>page</span><span class=o>.</span><span class=na>$</span><span class=o>(</span><span class=s>&#34;body&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>double</span> <span class=n>width</span> <span class=o>=</span> <span class=n>body</span><span class=o>.</span><span class=na>boundingBox</span><span class=o>().</span><span class=na>getWidth</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=kt>double</span> <span class=n>height</span> <span class=o>=</span> <span class=n>body</span><span class=o>.</span><span class=na>boundingBox</span><span class=o>().</span><span class=na>getHeight</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>Viewport</span> <span class=n>viewport</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Viewport</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>viewport</span><span class=o>.</span><span class=na>setWidth</span><span class=o>((</span><span class=kt>int</span><span class=o>)</span> <span class=n>width</span><span class=o>);</span> <span class=c1>// 设置视口宽度
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>viewport</span><span class=o>.</span><span class=na>setHeight</span><span class=o>((</span><span class=kt>int</span><span class=o>)</span> <span class=n>height</span> <span class=o>+</span> <span class=mi>100</span><span class=o>);</span> <span class=c1>// 设置视口高度
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>page</span><span class=o>.</span><span class=na>setViewport</span><span class=o>(</span><span class=n>viewport</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>ScreenshotOptions</span> <span class=n>screenshotOptions</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ScreenshotOptions</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>screenshotOptions</span><span class=o>.</span><span class=na>setType</span><span class=o>(</span><span class=s>&#34;jpeg&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>screenshotOptions</span><span class=o>.</span><span class=na>setFullPage</span><span class=o>(</span><span class=n>Boolean</span><span class=o>.</span><span class=na>FALSE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>//screenshotOptions.setClip(clip);
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>screenshotOptions</span><span class=o>.</span><span class=na>setPath</span><span class=o>(</span><span class=n>path</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>screenshotOptions</span><span class=o>.</span><span class=na>setQuality</span><span class=o>(</span><span class=mi>100</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 或者转换为 base64
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>//String base64Str = page.screenshot(screenshotOptions);
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>//System.out.println(base64Str);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>browser</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>一个自动滚屏的方法。</p><p>虽然可以监听页面上的事件通知，比如 <code>domcontentloaded</code>，文档加载完成的通知，但是很多时候并不能监听到网页上的所有元素都加载完成了。对于那些滚动加载的页面，可以用这种方式模拟完全加载，加载完成之后再进行操作就可以了。</p><p>使用自动滚屏的操作，可以模拟我们人为的在界面上下拉滚动条的操作，随着滚动条的下拉，页面上的元素会自然的加载，不管是同步的还有延迟异步的，比如图片、图表等。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>autoScroll</span><span class=o>(</span><span class=n>Page</span> <span class=n>page</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>(</span><span class=n>page</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>page</span><span class=o>.</span><span class=na>evaluate</span><span class=o>(</span><span class=s>&#34;() =&gt; {\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;   return new Promise((resolve, reject) =&gt; {\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;            //滚动的总高度\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;            let totalHeight = 0;\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;            //每次向下滚动的高度 500 px\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;            let distance = 500;\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;            let k = 0;\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;            let timeout = 1000;\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;            let url = window.location.href;\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;            let timer = setInterval(() =&gt; {\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;                //滚动条向下滚动 distance\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;                window.scrollBy(0, distance);\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;                totalHeight += distance;\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;                k++;\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;                console.log(`当前第${k}次滚动，页面高度: ${totalHeight}`);\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;                //页面的高度 包含滚动高度\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;                let scrollHeight = document.body.scrollHeight;\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;                //当滚动的总高度 大于 页面高度 说明滚到底了。也就是说到滚动条滚到底时，以上还会继续累加，直到超过页面高度\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;                if (totalHeight &gt;= scrollHeight || k &gt;= 200) {\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;                    clearInterval(timer);\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;                    resolve();\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;                    window.scrollTo(0, 0);\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;                }\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;            }, timeout);\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;        })\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;  }&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>调用截图方法截图，这里是对一篇公众号文章进行整个网页的截图。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>screenShotWx</span><span class=o>(</span><span class=s>&#34;https://mp.weixin.qq.com/s/MzCyWqcH1TCytpnHI8dVjA&#34;</span><span class=o>,</span> <span class=s>&#34;/Users/fengzheng/Desktop/PICTURE/wx.jpeg&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>或者也可以截取页面中的部分区域，比如某篇文章的正文部分，下面这个方法是截图一个博客文章的正文部分。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>screenShotJueJin</span><span class=o>(</span><span class=n>String</span> <span class=n>url</span><span class=o>,</span> <span class=n>String</span> <span class=n>path</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span><span class=o>,</span> <span class=n>ExecutionException</span><span class=o>,</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>BrowserFetcher</span><span class=o>.</span><span class=na>downloadIfNotExist</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>arrayList</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>  <span class=n>String</span> <span class=n>executablePath</span> <span class=o>=</span> <span class=s>&#34;/Applications/Google Chrome.app/Contents/MacOS/Google Chrome&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>LaunchOptions</span> <span class=n>options</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LaunchOptionsBuilder</span><span class=o>().</span><span class=na>withExecutablePath</span><span class=o>(</span><span class=n>executablePath</span><span class=o>).</span><span class=na>withArgs</span><span class=o>(</span><span class=n>arrayList</span><span class=o>).</span><span class=na>withHeadless</span><span class=o>(</span><span class=kc>true</span><span class=o>).</span><span class=na>withIgnoreHTTPSErrors</span><span class=o>(</span><span class=kc>true</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>//LaunchOptions options = new LaunchOptionsBuilder().withArgs(arrayList).withHeadless(true).withIgnoreHTTPSErrors(true).build();
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--no-sandbox&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--disable-setuid-sandbox&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Browser</span> <span class=n>browser</span> <span class=o>=</span> <span class=n>Puppeteer</span><span class=o>.</span><span class=na>launch</span><span class=o>(</span><span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Page</span> <span class=n>page</span> <span class=o>=</span> <span class=n>browser</span><span class=o>.</span><span class=na>newPage</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>PageNavigateOptions</span> <span class=n>pageNavigateOptions</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PageNavigateOptions</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>pageNavigateOptions</span><span class=o>.</span><span class=na>setTimeout</span><span class=o>(</span><span class=mi>1000000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>//dom加载完毕就算导航完成
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>pageNavigateOptions</span><span class=o>.</span><span class=na>setWaitUntil</span><span class=o>(</span><span class=n>Collections</span><span class=o>.</span><span class=na>singletonList</span><span class=o>(</span><span class=s>&#34;domcontentloaded&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=n>page</span><span class=o>.</span><span class=na>goTo</span><span class=o>(</span><span class=n>url</span><span class=o>,</span> <span class=n>pageNavigateOptions</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>WaitForSelectorOptions</span> <span class=n>waitForSelectorOptions</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WaitForSelectorOptions</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>waitForSelectorOptions</span><span class=o>.</span><span class=na>setTimeout</span><span class=o>(</span><span class=mi>1000</span> <span class=o>*</span> <span class=mi>15</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>waitForSelectorOptions</span><span class=o>.</span><span class=na>setVisible</span><span class=o>(</span><span class=n>Boolean</span><span class=o>.</span><span class=na>TRUE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 指定截图的区域
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>ElementHandle</span> <span class=n>elementHandle</span> <span class=o>=</span> <span class=n>page</span><span class=o>.</span><span class=na>waitForSelector</span><span class=o>(</span><span class=s>&#34;article.article&#34;</span><span class=o>,</span> <span class=n>waitForSelectorOptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Clip</span> <span class=n>clip</span> <span class=o>=</span> <span class=n>elementHandle</span><span class=o>.</span><span class=na>boundingBox</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>Viewport</span> <span class=n>viewport</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Viewport</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>ElementHandle</span> <span class=n>body</span> <span class=o>=</span> <span class=n>page</span><span class=o>.</span><span class=na>$</span><span class=o>(</span><span class=s>&#34;body&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>double</span> <span class=n>width</span> <span class=o>=</span> <span class=n>body</span><span class=o>.</span><span class=na>boundingBox</span><span class=o>().</span><span class=na>getWidth</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>viewport</span><span class=o>.</span><span class=na>setWidth</span><span class=o>((</span><span class=kt>int</span><span class=o>)</span> <span class=n>width</span><span class=o>);</span> <span class=c1>// 设置视口宽度
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>viewport</span><span class=o>.</span><span class=na>setHeight</span><span class=o>((</span><span class=kt>int</span><span class=o>)</span> <span class=n>clip</span><span class=o>.</span><span class=na>getHeight</span><span class=o>()</span> <span class=o>+</span> <span class=mi>100</span><span class=o>);</span> <span class=c1>// 设置视口高度
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>page</span><span class=o>.</span><span class=na>setViewport</span><span class=o>(</span><span class=n>viewport</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>ScreenshotOptions</span> <span class=n>screenshotOptions</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ScreenshotOptions</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>screenshotOptions</span><span class=o>.</span><span class=na>setType</span><span class=o>(</span><span class=s>&#34;jpeg&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>screenshotOptions</span><span class=o>.</span><span class=na>setFullPage</span><span class=o>(</span><span class=n>Boolean</span><span class=o>.</span><span class=na>FALSE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>screenshotOptions</span><span class=o>.</span><span class=na>setClip</span><span class=o>(</span><span class=n>clip</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>screenshotOptions</span><span class=o>.</span><span class=na>setPath</span><span class=o>(</span><span class=n>path</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>screenshotOptions</span><span class=o>.</span><span class=na>setQuality</span><span class=o>(</span><span class=mi>100</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 或者生成图片的 base64编码
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>String</span> <span class=n>base64Str</span> <span class=o>=</span> <span class=n>page</span><span class=o>.</span><span class=na>screenshot</span><span class=o>(</span><span class=n>screenshotOptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>base64Str</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>调用方式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>screenShotJueJin</span><span class=o>(</span><span class=s>&#34;https://juejin.cn/post/7239715628172902437&#34;</span><span class=o>,</span> <span class=s>&#34;/Users/fengzheng/Desktop/PICTURE/juejin.jpeg&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>最后的效果是这样的，可以达到很清晰的效果。</p><p><img src=https://hexo.moonkite.cn/blog/image-20230606143425476.png alt></p><h3 id=网页生成-pdf-功能>网页生成 PDF 功能</h3><p>这个功能可太有用了，可以把一些网页转成离线版的文档。有人说直接保存网页不就行了，除了程序员，大部分人还是更能直接读 PDF ，而不会用离线存储的网页。</p><p>我们可以在浏览器上使用浏览器的「打印」功能，用来将网页转换成 PDF 格式。</p><p><img src=https://hexo.moonkite.cn/blog/image-20230606144145679.png alt></p><p>但这是直接在页面上操作，如果是批量操作呢，比如想把一个专栏的所有文章都生成 PDF呢，就可以用无头浏览器来做了。</p><p>有的同学说，用其他的库也可以呀，Java 里面有很多生成 PDF 的开源库，可以把 HTML 转成 PDF，比如Apache PDFBox、IText 等，但是这些库应对一般的场景还行，对于那种页面上有延迟加载的图表啊、图片啊、脚本之类的就束手无策了。</p><p>而无头浏览器就可以，你可以监听页面加载完成的事件，可以模拟操作，主动触发页面加载，甚至还可以在页面中添加自定义的样式、脚本等，让生成的 PDF 更加完整、美观。</p><p>下面这个方法演示了如何将一个网页转成 PDF 。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>pdf</span><span class=o>(</span><span class=n>String</span> <span class=n>url</span><span class=o>,</span> <span class=n>String</span> <span class=n>savePath</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Browser</span> <span class=n>browser</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Page</span> <span class=n>page</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//自动下载，第一次下载后不会再下载
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>BrowserFetcher</span><span class=o>.</span><span class=na>downloadIfNotExist</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>arrayList</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// MacOS
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>String</span> <span class=n>executablePath</span> <span class=o>=</span> <span class=s>&#34;/Applications/Google Chrome.app/Contents/MacOS/Google Chrome&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>LaunchOptions</span> <span class=n>options</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LaunchOptionsBuilder</span><span class=o>().</span><span class=na>withExecutablePath</span><span class=o>(</span><span class=n>executablePath</span><span class=o>).</span><span class=na>withArgs</span><span class=o>(</span><span class=n>arrayList</span><span class=o>).</span><span class=na>withHeadless</span><span class=o>(</span><span class=kc>true</span><span class=o>).</span><span class=na>withIgnoreHTTPSErrors</span><span class=o>(</span><span class=kc>true</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=c1>// windows 或 linux
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//LaunchOptions options = new LaunchOptionsBuilder().withArgs(arrayList).withHeadless(true).withIgnoreHTTPSErrors(true).build();
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--no-sandbox&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--disable-setuid-sandbox&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--ignore-certificate-errors&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--disable-gpu&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--disable-web-security&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--disable-infobars&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--disable-extensions&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--disable-bundled-ppapi-flash&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--allow-running-insecure-content&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;--mute-audio&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>browser</span> <span class=o>=</span> <span class=n>Puppeteer</span><span class=o>.</span><span class=na>launch</span><span class=o>(</span><span class=n>options</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>page</span> <span class=o>=</span> <span class=n>browser</span><span class=o>.</span><span class=na>newPage</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>page</span><span class=o>.</span><span class=na>onConsole</span><span class=o>((</span><span class=n>msg</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;==&gt; {}&#34;</span><span class=o>,</span> <span class=n>msg</span><span class=o>.</span><span class=na>text</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>page</span><span class=o>.</span><span class=na>setViewport</span><span class=o>(</span><span class=n>viewport</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>page</span><span class=o>.</span><span class=na>setJavaScriptEnabled</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>page</span><span class=o>.</span><span class=na>setUserAgent</span><span class=o>(</span><span class=s>&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36 Edg/83.0.478.37&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>page</span><span class=o>.</span><span class=na>setCacheEnabled</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//设置参数防止检测
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>page</span><span class=o>.</span><span class=na>evaluateOnNewDocument</span><span class=o>(</span><span class=s>&#34;() =&gt;{ Object.defineProperties(navigator,{ webdriver:{ get: () =&gt; undefined } }) }&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>page</span><span class=o>.</span><span class=na>evaluateOnNewDocument</span><span class=o>(</span><span class=s>&#34;() =&gt;{ window.navigator.chrome = { runtime: {},  }; }&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>page</span><span class=o>.</span><span class=na>evaluateOnNewDocument</span><span class=o>(</span><span class=s>&#34;() =&gt;{ Object.defineProperty(navigator, &#39;languages&#39;, { get: () =&gt; [&#39;en-US&#39;, &#39;en&#39;] }); }&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>page</span><span class=o>.</span><span class=na>evaluateOnNewDocument</span><span class=o>(</span><span class=s>&#34;() =&gt;{ Object.defineProperty(navigator, &#39;plugins&#39;, { get: () =&gt; [1, 2, 3, 4, 5,6], }); }&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>PageNavigateOptions</span> <span class=n>pageNavigateOptions</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PageNavigateOptions</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>pageNavigateOptions</span><span class=o>.</span><span class=na>setTimeout</span><span class=o>(</span><span class=mi>1000000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>//dom加载完毕就算导航完成
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=n>pageNavigateOptions</span><span class=o>.</span><span class=na>setWaitUntil</span><span class=o>(</span><span class=n>Collections</span><span class=o>.</span><span class=na>singletonList</span><span class=o>(</span><span class=s>&#34;domcontentloaded&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>page</span><span class=o>.</span><span class=na>goTo</span><span class=o>(</span><span class=n>url</span><span class=o>,</span> <span class=n>pageNavigateOptions</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 添加自定义演示
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>StyleTagOptions</span> <span class=n>styleTagOptions1</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StyleTagOptions</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>styleTagOptions1</span><span class=o>.</span><span class=na>setContent</span><span class=o>(</span><span class=s>&#34;html {-webkit-print-color-adjust: exact} .table &gt; table &gt; tr:nth-child(1),.table &gt; table &gt; tr:nth-child(2) {background: #4074b0;} #tableB td:nth-child(2) {width:60%;}&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>page</span><span class=o>.</span><span class=na>addStyleTag</span><span class=o>(</span><span class=n>styleTagOptions1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//滚屏
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>autoScroll</span><span class=o>(</span><span class=n>page</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>1000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>PDFOptions</span> <span class=n>pdfOptions</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PDFOptions</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>//            pdfOptions.setHeight(&#34;5200&#34;);
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>pdfOptions</span><span class=o>.</span><span class=na>setPath</span><span class=o>(</span><span class=n>savePath</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>page</span><span class=o>.</span><span class=na>pdf</span><span class=o>(</span><span class=n>pdfOptions</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;生成pdf异常：{}&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>page</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>page</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>browser</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>browser</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>调用生成 PDF 的方法，将一个微信公众号文章转成 PDF。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>pdfPath</span> <span class=o>=</span> <span class=s>&#34;/Users/fengzheng/Desktop/PDF&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>filePath</span> <span class=o>=</span> <span class=n>pdfPath</span> <span class=o>+</span> <span class=s>&#34;/hello.pdf&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>			 <span class=n>JvppeteerUtils</span><span class=o>.</span><span class=na>pdf</span><span class=o>(</span><span class=s>&#34;https://mp.weixin.qq.com/s/MzCyWqcH1TCytpnHI8dVjA&#34;</span><span class=o>,</span> <span class=n>filePath</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></div><p>最终的效果，很清晰，样式都在，基本和页面一模一样。</p><p><img src=https://hexo.moonkite.cn/blog/image-20230606150457020.png alt></p></article><div class=toc><h2>文章目录</h2><nav id=TableOfContents><ul><li><a href=#什么是浏览器>什么是浏览器</a></li><li><a href=#什么是无头浏览器>什么是无头浏览器</a></li><li><a href=#使用无头浏览器做一些好玩的功能>使用无头浏览器做一些好玩的功能</a><ul><li><a href=#网页截图功能>网页截图功能</a></li><li><a href=#网页生成-pdf-功能>网页生成 PDF 功能</a></li></ul></li></ul></nav></div><script>window.addEventListener("scroll",function(){var e=document.querySelector(".toc"),t=window.pageYOffset||document.documentElement.scrollTop,n=window.innerWidth||document.documentElement.clientWidth;t<360?e.style.top=380-t+"px":e.style.top="20px"})</script><h4>相关文章</h4><dl class=row><dd class=col-md-9><a href=/category/other/%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E6%98%AF%E4%BB%80%E4%B9%88/>向量数据库是什么</a></dd><dd class=col-md-9><a href=/category/java/RPC-%E6%A6%82%E8%A7%88/>RPC框架的核心是什么？</a></dd><dd class=col-md-9><a href=/category/SpringCloud/0-Srping-Cloud-%E5%BC%80%E7%AF%87/>0. Spring Cloud 是什么</a></dd><dd class=col-md-9><a href=/category/SpringCloud/1-Spring-Cloud-Eureka-%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0/>1. Spring Cloud Eureka 实现服务注册与发现</a></dd><dd class=col-md-9><a href=/category/SpringCloud/2-Spring-Cloud-Eureka-%E5%AE%9E%E7%8E%B0%E5%AE%89%E5%85%A8%E6%8E%A7%E5%88%B6/>2. Spring Cloud Eureka 实现安全控制</a></dd></dl><div class=author-card><div class=underline></div><div class=author-box><div class=qr-author-image><a href=/><img src=/images/person.jpg alt=风筝></a></div><div class=author-content><p class=author-title>作者</p><p class=author-name>风筝</p><p class=author-desc>古时的风筝，一个平庸的程序员，主语言 Java，第二语言 Python，其实学 Python 的时间比 Java 还要早。喜欢写博客，写博客的过程能加深自己对一个知识点的理解，同时还可以分享给他人。喜欢做一些小东西，所以也会一些前端的东西，React、JavaScript、CSS 都会一些，做一些小工具还够用。</p></div></div></div><script src=https://utteranc.es/client.js repo=huzhicheng/blog-comment issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></main><div class="footer gradient-2"><div class="container footer-container"><div class=row><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>网站地图</div><ul class=list-unstyled><li><a href=https://www.moonkite.cn/tags/>标签</a></li><li><a href=https://www.moonkite.cn/categories/>分类</a></li><li><a rel=alternate type=application/rss+xml href=https://www.moonkite.cn/index.xml><i class="fas fa-rss-square"></i> RSS订阅</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>社群</div><ul class=list-unstyled><li><a href=https://github.com/huzhicheng rel=noopener target=_blank>GitHub</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>友链</div><ul class=list-unstyled><li><a href=https://github.com/huzhicheng rel=noopener target=_blank>关于我</a></li></ul></div><div class="col-xs-12 col-sm-3 col-md-3 col-lg-3"><p class="pull-right text-right"><small><em>Proudly powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo</a></em></small><br><small><em>Theme - <a href=https://github.com/shaform/hugo-theme-den rel=noopener target=_blank>Den</a></em></small><br><small>&copy;
风筝
2023</small></p></div></div><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?e417ddf834c7bb7411207e1fa09815aa",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></div></div><script src=https://cdn.staticfile.org/jquery/3.3.1/jquery.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script>
<script src=https://cdn.staticfile.org/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=https://cdn.staticfile.org/twitter-bootstrap/4.1.3/js/bootstrap.js></script>
<script>$(document).ready(function(){$("#load_disqus").length&&$(window).scroll(function(){if($("#load_disqus").length){var e=$("#load_disqus").offset().top,t=$(window).scrollTop(),n=t+$(window).height();t<e&&e<n&&load_disqus()}})})</script></body></html>