<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage><head><meta name=generator content="Hugo 0.119.0"><meta charset=utf-8><title>6. Spring Cloud 系列之 Spring Cloud Stream · 古时的风筝</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="Spring Cloud Stream 是消息中间件组件，它集成了 kafka 和 rabbitmq 。本篇文章以 Rabbit MQ 为消息中间件系统为基础，介绍 Spring Cloud Stream 的使用。如果你没有用过消息中间件，可以到 RabbitMQ 的官网看一"><meta name=360-site-verification content="e75339f1cfcde17f66f71aaf8b6983e9"><meta name=keywords content="Hugo,theme,编程,java,ChatGPT,程序员,开发"><meta name=google-site-verification content="google57680cd58c46e2f3.html"><link rel=canonical href=https://www.moonkite.cn/category/SpringCloud/6-Spring-Cloud-%E7%B3%BB%E5%88%97%E4%B9%8B-Spring-Cloud-Stream/><link rel=icon href=https://www.moonkite.cn/images/photo.png><link rel=stylesheet href=https://cdn.usebootstrap.com/bootstrap/4.1.3/css/bootstrap.min.css><link rel=stylesheet href=https://www.moonkite.cn/css/den.css><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-tc-webfont@1.0.0/style.css><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="6. Spring Cloud 系列之 Spring Cloud Stream"><meta property="og:description" content="Spring Cloud Stream 是消息中间件组件，它集成了 kafka 和 rabbitmq 。本篇文章以 Rabbit MQ 为消息中间件系统为基础，介绍 Spring Cloud Stream 的使用。如果你没有用过消息中间件，可以到 RabbitMQ 的官网看一"><meta property="og:type" content="article"><meta property="og:url" content="https://www.moonkite.cn/category/SpringCloud/6-Spring-Cloud-%E7%B3%BB%E5%88%97%E4%B9%8B-Spring-Cloud-Stream/"><meta property="article:section" content="category"><meta property="article:published_time" content="2023-06-02T08:56:23+08:00"><meta property="article:modified_time" content="2023-06-02T08:56:23+08:00"><meta itemprop=name content="6. Spring Cloud 系列之 Spring Cloud Stream"><meta itemprop=description content="Spring Cloud Stream 是消息中间件组件，它集成了 kafka 和 rabbitmq 。本篇文章以 Rabbit MQ 为消息中间件系统为基础，介绍 Spring Cloud Stream 的使用。如果你没有用过消息中间件，可以到 RabbitMQ 的官网看一"><meta itemprop=datePublished content="2023-06-02T08:56:23+08:00"><meta itemprop=dateModified content="2023-06-02T08:56:23+08:00"><meta itemprop=wordCount content="3393"><meta itemprop=keywords content="Java,JDK,Spring Cloud,Spring Cloud Stream,配置中心,"><meta name=twitter:card content="summary"><meta name=twitter:title content="6. Spring Cloud 系列之 Spring Cloud Stream"><meta name=twitter:description content="Spring Cloud Stream 是消息中间件组件，它集成了 kafka 和 rabbitmq 。本篇文章以 Rabbit MQ 为消息中间件系统为基础，介绍 Spring Cloud Stream 的使用。如果你没有用过消息中间件，可以到 RabbitMQ 的官网看一"></head><body><div class=header-container style=background:linear-gradient(rgba(0,0,0,.2),rgba(0,0,0,.2)),url(https://hexo.moonkite.cn/blog/background.png);background-position:top;background-size:cover><div class=container><nav class="header-nav navbar navbar-expand-md navbar-dark light-dark"><div class="header-logo navbar-brand"><a class=float-left href=https://www.moonkite.cn/></a></div><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="nav-menu collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a href=https://www.moonkite.cn/ class=nav-link><i class="fas fad fa-h-square"></i>主页</a></li><li class=nav-item><a href=https://www.moonkite.cn/category/notes class=nav-link><i class='fas fa-yin-yang'></i>生活随笔</a></li><li class=nav-item><a href=javascript:void(0) class=nav-link><i class='fas fa-laptop-code'></i>技术文章</a><div class=sub-dropdown-menu><a class=sub-nav-link href=https://www.moonkite.cn/category/java><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"><path fill="#f44336" d="M23.65 24.898c-.998-1.609-1.722-2.943-2.725-5.455C19.229 15.2 31.24 11.366 26.37 3.999c2.111 5.089-7.577 8.235-8.477 12.473-.823 3.898 5.752 8.426 5.757 8.426z"/><path fill="#f44336" d="M23.878 17.27c-.192 2.516 2.229 3.857 2.299 5.695.056 1.496-1.447 2.743-1.447 2.743s2.728-.536 3.579-2.818c.945-2.534-1.834-4.269-1.548-6.298.267-1.938 6.031-5.543 6.031-5.543S24.311 11.611 23.878 17.27z"/><g><path fill="#1565c0" d="M32.084 25.055c1.754-.394 3.233.723 3.233 2.01.0 2.901-4.021 5.643-4.021 5.643s6.225-.742 6.225-5.505c0-3.15-3.057-3.937-5.437-2.148zm-2.955 2.34s1.941-1.383 2.458-1.902c-4.763 1.011-15.638 1.147-15.638.269.0-.809 3.507-1.638 3.507-1.638s-7.773-.112-7.773 2.181C11.683 28.695 21.858 28.866 29.129 27.395z"/><path fill="#1565c0" d="M27.935 29.571c-4.509 1.499-12.814 1.02-10.354-.993-1.198.0-2.974.963-2.974 1.889.0 1.857 8.982 3.291 15.63.572l-2.302-1.468z"/><path fill="#1565c0" d="M18.686 32.739c-1.636.0-2.695 1.054-2.695 1.822.0 2.391 9.76 2.632 13.627.205l-2.458-1.632C24.271 34.404 17.014 34.579 18.686 32.739z"/><path fill="#1565c0" d="M36.281 36.632c0-.936-1.055-1.377-1.433-1.588 2.228 5.373-22.317 4.956-22.317 1.784.0-.721 1.807-1.427 3.477-1.093l-1.42-.839C11.26 34.374 9 35.837 9 37.017 9 42.52 36.281 42.255 36.281 36.632z"/><path fill="#1565c0" d="M39 38.604c-4.146 4.095-14.659 5.587-25.231 3.057C24.341 46.164 38.95 43.628 39 38.604z"/></g></svg>&nbsp;可爱的 Java</a>
<a class=sub-nav-link href=https://www.moonkite.cn/category/SpringCloud><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48"><path fill="#8bc34a" d="M43.982 23.635c.069-4.261-.891-9.328-2.891-15.273L39.523 3.7l-2.13 4.433c-.114.237-.244.469-.38.698C33.514 5.827 28.974 4 24 4 12.954 4 4 12.954 4 24s8.954 20 20 20 20-8.954 20-20C44 23.877 43.984 23.758 43.982 23.635z"/><path fill="#fff" d="M39.385 32.558C36.262 36.86 30.734 37.091 25.531 37H18.75h-1.938c4.428-1.593 7.063-1.972 9.754-3.4 5.068-2.665 10.078-8.496 11.121-14.562-1.93 5.836-7.779 10.85-13.109 12.889-3.652 1.393-10.248 2.745-10.248 2.745l-.267-.145C9.573 32.268 9.437 22.214 17.6 18.968c3.574-1.423 6.993-.641 10.854-1.593 4.122-1.012 8.89-4.208 10.83-8.375C41.456 15.667 44.07 26.106 39.385 32.558zM15.668 38.445C15.386 38.795 14.955 39 14.505 39c-.823.0-1.495-.677-1.495-1.5s.677-1.5 1.495-1.5c.341.0.677.118.941.336C16.086 36.855 16.186 37.805 15.668 38.445z"/></svg>&nbsp; Spring Cloud 系列</a>
<a class=sub-nav-link href=https://www.moonkite.cn/category/other><img width=20 height=20 src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAADWElEQVR4nO2X30tTYRjH9xd4X2Dsol1EEtJdEFiSF10pldlVaVHEjiFFkKQVQeV0kfSTHdfW1pzKlpZtzXJuzp2pmzPFTdmUTdLJlEAvNKyB8MYzPG/visHZ2jxrnQc+8PCc85zz/e592XkfkUgIIYT4v2OoTVrtVFDTjILaYmgK8YqC2oproalzKZlwKqga3sXTSeFuZts9ykWcNOXnbITcTj67IRQcG1rlE5/dECK3GXcjxC8ADwqMuxGfBMeGVklNaRmZ83z0L3+ZR3ywMBfInJHQqGl07esKAmYjK6hnJoph64Ar/KsOOXmNK6HOTszKtD9uJitGQGSRcQFDiqh1RHAd8nSMWMQSDJgRjLAhrIgxta3lDvaiRlMpxvKvbi3BCNfI+xVRehdRIT2DIUWdejeH65BzMWKd1KO6jqOYLrEE46fp7Bm5bgki0Q0bhhS1t3UM1yHnYuS1XY5Oy0swD8USjPNmQ2aNfO6WO0KjphHgbrc9XNjsirGwdeAY7Vpl65CT15LRYb4VltLHYyzKAwcxgw3Xwr5BQ9D9ll53dz9d+msjfNLfWoO6GstR7/0zCXXBCJMPKxLMl3kkmC9GQsTf706znK3vyKLdhtznL2ISPm5TaqQdro8DeTJxm4EHKDZRGQfy308HtdvAcJY1I3BsII8RpAgwwB41IE9mBAwgR0EcyMlrRcTxB45DgpFUV+RbSIMxuq4kXRFyFl+3VuTeiqBtQYCDqUxqhOyJPCsTjDDCitB5urW8zS2oTSzBxNS7MB3tpeiC4kicO8azCQLJnkB9Me750Xs44b4CmQcjc4SzZwSGHXL42Xy0B6NTHMIDUp36RIJAsmeS2od7vuuKE+4TEUMbDHGZMLLBNrlUV/3u9sYRwH7vkq/nZFmUJaotwfRoK5bk6qoooNRUh9kegOyZkpUtsT3zuvKE+6qev4myKF899nkNTeMTJuWsu6spTBjZ4GzESUv7+R6qmCQ4aeoTZyPDLy4XMTS1xrdo5k/WmDbpflEq4XpJ7XbS1O0+bYvnve7JLNCnkXkZWmrYCfo0Mi9+r7bFA1pAkyjd0Ov1EZVKhQDI034Q3++1mM39H8xmBECeEZV8vNdmtRptAwMojtVqzIjKHH6vEEIIIcrt+AnU4LBcH67z1wAAAABJRU5ErkJggg=="> &nbsp; 杂七杂八</a></div></li><li class=nav-item><a href=https://www.moonkite.cn/category/network class=nav-link><i class="fas fa-network-wired"></i>轻解计算机网络</a></li><li class=nav-item><a href=https://www.moonkite.cn/category/product class=nav-link><i class="fas fab fa-medapps"></i>我的产品</a></li></ul></div></nav></div><div class="container header-wrapper"><div class=row><div class=col-lg-12><div class=header-content><h1 class=header-title>6. Spring Cloud 系列之 Spring Cloud Stream</h1><p class=header-date>作者：
风筝 /
2023-06-02<div class=header-underline></div><div class=header-date>&nbsp·&nbsp
  <span id=busuanzi_container_page_pv>本文被阅读<span id=busuanzi_value_page_pv></span>次</span></div><div class=clearfix></div><p class="float-right header-tags"><i class="fas fa-tags" aria-hidden=true></i>
<a href=https://www.moonkite.cn/tag/Java/>Java</a>,
<a href=https://www.moonkite.cn/tag/JDK/>JDK</a>,
<a href=https://www.moonkite.cn/tag/Spring-Cloud/>Spring Cloud</a>,
<a href=https://www.moonkite.cn/tag/Spring-Cloud-Stream/>Spring Cloud Stream</a>,
<a href=https://www.moonkite.cn/tag/%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/>配置中心</a></p></div></div></div></div></div><main><div class="container content"><article><blockquote><p>Spring Cloud Stream 是消息中间件组件，它集成了 kafka 和 rabbitmq 。本篇文章以 Rabbit MQ 为消息中间件系统为基础，介绍 Spring Cloud Stream 的使用。如果你没有用过消息中间件，可以到 RabbitMQ 的官网看一下，或者参考这个 <a href=http://rabbitmq.mr-ping.com/>http://rabbitmq.mr-ping.com/</a>。理解了消息中间件的设计，才能更好的使用它。</p></blockquote><h2 id=消息中间的几大应用场景><strong>消息中间的几大应用场景</strong></h2><p>1、异步处理</p><p>比如用户在电商网站下单，下单完成后会给用户推送短信或邮件，发短信和邮件的过程就可以异步完成。因为下单付款是核心业务，发邮件和短信并不属于核心功能，并且可能耗时较长，所以针对这种业务场景可以选择先放到消息队列中，有其他服务来异步处理。</p><p>2、应用解耦：</p><p>假设公司有几个不同的系统，各系统在某些业务有联动关系，比如 A 系统完成了某些操作，需要触发 B 系统及 C 系统。如果 A 系统完成操作，主动调用 B 系统的接口或 C 系统的接口，可以完成功能，但是各个系统之间就产生了耦合。用消息中间件就可以完成解耦，当 A 系统完成操作将数据放进消息队列，B 和 C 系统去订阅消息就可以了。这样各系统只要约定好消息的格式就好了。</p><p>3、流量削峰</p><p>比如秒杀活动，一下子进来好多请求，有的服务可能承受不住瞬时高并发而崩溃，所以针对这种瞬时高并发的场景，在中间加一层消息队列，把请求先入队列，然后再把队列中的请求平滑的推送给服务，或者让服务去队列拉取。</p><p>4、日志处理</p><p>kafka 最开始就是专门为了处理日志产生的。</p><p>当碰到上面的几种情况的时候，就要考虑用消息队列了。如果你碰巧使用的是 RabbitMQ 或者 kafka ，而且同样也是在使用 Spring Cloud ，那可以考虑下用 Spring Cloud Stream。</p><h2 id=使用-spring-cloud-stream--rabbitmq><strong>使用 Spring Cloud Stream && RabbitMQ</strong></h2><p>介绍下面的例子之前，假定你已经对 RabbitMQ 有一定的了解。</p><p>首先来认识一下 Spring Cloud Stream 中的几个重要概念。</p><p><em>Destination Binders</em>：目标绑定器，目标指的是 kafka 还是 RabbitMQ，绑定器就是封装了目标中间件的包。如果操作的是 kafka 就使用 kafka binder ，如果操作的是 RabbitMQ 就使用 rabbitmq binder。</p><p><em>Destination Bindings</em>：外部消息传递系统和应用程序之间的桥梁，提供消息的“生产者”和“消费者”（由目标绑定器创建）</p><p><em>Message</em>：一种规范化的数据结构，生产者和消费者基于这个数据结构通过外部消息系统与目标绑定器和其他应用程序通信。</p><p><img src=https://hexo.moonkite.cn/blog/273364-20190924095629304-2092960942.png alt></p><p>可能看完了上面的三个概念仍然是一头雾水，没有关系，实践过程中自然就明白了。</p><h2 id=先来一个最简单的例子><strong>先来一个最简单的例子</strong></h2><p>因为用到的是 rabbitmq，所以在本地搭好 rabbitmq 环境，然后装好 rabbitmq-management 插件，这样就可以访问 web UI 界面了，默认是 15672 端口。</p><p>1、引用对应 rabbitmq 的 stream 包</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span> 
</span></span><span class=line><span class=cl>  <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>  
</span></span><span class=line><span class=cl>  <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-stream-rabbit<span class=nt>&lt;/artifactId&gt;</span> 
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>2、在 application.yml 中增加配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>profiles</span><span class=p>:</span><span class=w> </span><span class=l>stream-rabbit-customer-group1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cloud</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>stream</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>bindings</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>input</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>destination</span><span class=p>:</span><span class=w> </span><span class=l>default.messages</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>binder</span><span class=p>:</span><span class=w> </span><span class=l>local_rabbit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>output</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>destination</span><span class=p>:</span><span class=w> </span><span class=l>default.messages</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>binder</span><span class=p>:</span><span class=w> </span><span class=l>local_rabbit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>binders</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>local_rabbit</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>rabbit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>rabbitmq</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>32775</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>guest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>guest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8201</span><span class=w>
</span></span></span></code></pre></div><p>理解配置文件很重要，基本上理解清楚了配置，也就明白 spring cloud stream 是怎么回事了。</p><p><code>spring.cloud.stream.binders</code>，上面提到了 stream 的 3 个重要概念的第一个 「Destination binders」。上面的配置文件中就配置了一个 binder，命名为 local_rabbit，指定 type 为 rabbit ，表示使用的是 rabbitmq 消息中间件，如果用的是 kafka ，则 type 设置为 kafka。environment 就是设置使用的消息中间件的配置信息，包括 host、port、用户名、密码等。可以设置多了个 binder，适配不同的场景。</p><p><code>spring.cloud.stream.bindings</code> ，对应上面提到到 「Destination Bindings」。这里面可以配置多个 input 或者 output，分别表示消息的接收通道和发送通道，对应到 rabbitmq 上就是不同的 exchange。这个配置文件里定义了两个input 、两个output，名称分别为 input、log_input、output、log_output。这个名称不是乱起的，在我们的程序代码中会用到，用来标示某个方法接收哪个 exchange 或者发送到哪个 exchange 。</p><p>每个通道下的 destination 属性指 exchange 的名称，binder 指定在 binders 里设置的 binder，上面配置中指定了 local_rabbit 。</p><p>可以看到 input、output 对应的 destination 是相同的，log_input、log_output 对应的 destination 也相同， 也就是对应相同的 exchange。一个表示消息来源，一个表示消息去向。</p><p>另外还可以设置 group 。因为服务很可能不止一个实例，如果启动多个实例，那么没必要每个实例都消费同一个消息，只要把功能相同的实例的 group 设置为同一个，那么就会只有一个实例来消费消息，避免重复消费的情况。如果设置了 group，那么 group 名称就会成为 queue 的名称，如果没有设置 group ，那么 queue 就会根据 destination + 随机字符串的方式命名。</p><p>3、接下来做一个最简单的例子，来演示如何接收消息。</p><p>首先来介绍一下 stream 内置的简单消息通道（消息通道也就是指消息的来源和去向）接口定义，一个 Source 和 一个 Sink 。</p><p><strong>Source.java</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.cloud.stream.annotation.Output</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.messaging.MessageChannel</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>Source</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>OUTPUT</span> <span class=o>=</span> <span class=s>&#34;output&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Output</span><span class=o>(</span><span class=s>&#34;output&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>MessageChannel</span> <span class=nf>output</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>消息发送通道定义，定义了一个 MessageChannel 类型的 output() 方法，用 <code>@Output</code> 注解标示，并指定了 binding 的名称为 output。</p><p><strong>Sink.java</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.cloud.stream.annotation.Input</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.messaging.SubscribableChannel</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>Sink</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>INPUT</span> <span class=o>=</span> <span class=s>&#34;input&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Input</span><span class=o>(</span><span class=s>&#34;input&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>SubscribableChannel</span> <span class=nf>input</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>消息接收通道定义，定义了一个 SubscribableChannel 类型的 input() 方法，表示订阅一个消息的方法，并用 <code>@Input</code> 注解标识，并且指定了 binging 的名称为 input 。</p><p>创建一个简单的消息接收方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SpringBootApplication</span>
</span></span><span class=line><span class=cl><span class=nd>@EnableBinding</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=o>{</span><span class=n>Processor</span><span class=o>.</span><span class=na>class</span><span class=o>})</span>
</span></span><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DefaultApplication</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>SpringApplication</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>DefaultApplication</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>在项目启动类上加上注解 <code>@EnableBinding(value = {Processor.class})</code> ，表明启用 stream ，并指定定义的 Channel 定义接口类。</p><p>然后，创建一个 service 服务类，用来订阅消息，并对消息进行处理。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@Component</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DefaultMessageListener</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@StreamListener</span><span class=o>(</span><span class=n>Processor</span><span class=o>.</span><span class=na>INPUT</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>processMyMessage</span><span class=o>(</span><span class=n>String</span> <span class=n>message</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;接收到消息：&#34;</span> <span class=o>+</span> <span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>在方法 <code>processMyMessage()</code> 上使用 <code>@StreamListener</code> 注解，表示对消息进行订阅监控，指定 binding 的名称，其中 Processor.INPUT 就是 Sink 的 input ，也就是字符串 <code>input</code> ,对应的上面的配置文件，就是 spring.cloud.stream.bindings.input。</p><p>启动 DefaultApplication ，可以在 rabbitmq 管理控制台的 exchanges 中看到增加的这几个 bindings 。</p><p><img src=https://hexo.moonkite.cn/blog/273364-20190924095714758-1384799908.png alt></p><p>可以看到 exchange 的名称对应的就是 bindings 的两个 input 和 两个 output 的 destination 的值。</p><p><strong>用 rabbitmq UI 控制台发送消息测试</strong></p><p>点击上图的 default.input.messages 进入 exchange 详请页面，在 publish message 部分填写上 Payload ，然后点击 Publish message 按钮。</p><p><img src=https://hexo.moonkite.cn/blog/273364-20190924095740025-1689503088.png alt></p><p>之后回到 DefaultApplication 的输出控制台，会看到消息已经被接收。
<img src=https://hexo.moonkite.cn/blog/273364-20190924095756361-682131929.png alt></p><h2 id=模拟一个日志处理><strong>模拟一个日志处理</strong></h2><p>接下来模拟生产者和消费者处理消息的过程，模拟一个日志处理的过程。</p><ul><li>原始日志发送到 kite.log.messages exchange</li><li>接收器在 kite.log.messages exchange 接收原始日志，经过处理格式化，发送到 kite.log.format.messages exchange</li><li>接收器在 kite.log.format.messages exchange 接收格式化后的日志</li></ul><p>1、自定义消息通道接口，上面介绍了 stream 自带的 Sink 和 Source，也仅仅能做个演示，真正的业务中还是需要自己定义更加灵活的接口。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>MyProcessor</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>MESSAGE_INPUT</span> <span class=o>=</span> <span class=s>&#34;log_input&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>MESSAGE_OUTPUT</span> <span class=o>=</span> <span class=s>&#34;log_output&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>LOG_FORMAT_INPUT</span> <span class=o>=</span> <span class=s>&#34;log_format_input&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>LOG_FORMAT_OUTPUT</span> <span class=o>=</span> <span class=s>&#34;log_format_output&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Input</span><span class=o>(</span><span class=n>MESSAGE_INPUT</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>SubscribableChannel</span> <span class=nf>logInput</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Output</span><span class=o>(</span><span class=n>MESSAGE_OUTPUT</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>MessageChannel</span> <span class=nf>logOutput</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Input</span><span class=o>(</span><span class=n>LOG_FORMAT_INPUT</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>SubscribableChannel</span> <span class=nf>logFormatInput</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Output</span><span class=o>(</span><span class=n>LOG_FORMAT_OUTPUT</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>MessageChannel</span> <span class=nf>logFormatOutput</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>2、创建消费者应用</p><p>**配置文件如下 **：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>profiles</span><span class=p>:</span><span class=w> </span><span class=l>stream-rabbit-customer-group1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cloud</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>stream</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>bindings</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>log_input</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>destination</span><span class=p>:</span><span class=w> </span><span class=l>kite.log.messages</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>binder</span><span class=p>:</span><span class=w> </span><span class=l>local_rabbit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=l>logConsumer-group1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>log_output</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>destination</span><span class=p>:</span><span class=w> </span><span class=l>kite.log.messages</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>binder</span><span class=p>:</span><span class=w> </span><span class=l>local_rabbit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=l>logConsumer-group1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>log_format_input</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>destination</span><span class=p>:</span><span class=w> </span><span class=l>kite.log.format.messages</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>binder</span><span class=p>:</span><span class=w> </span><span class=l>local_rabbit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=l>logFormat-group1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>log_format_input</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>destination</span><span class=p>:</span><span class=w> </span><span class=l>kite.log.format.messages</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>binder</span><span class=p>:</span><span class=w> </span><span class=l>local_rabbit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=l>logFormat-group1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>binders</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>local_rabbit</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>rabbit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>rabbitmq</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>32775</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>guest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>guest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8201</span><span class=w>
</span></span></span></code></pre></div><p>此配置文件要参照 MyProcessor 接口查看，定义了 4 个 binding，但是 destination 两两相同，也就是两个 exchange。</p><p><strong>创建 spring boot 启动类</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SpringBootApplication</span>
</span></span><span class=line><span class=cl><span class=nd>@EnableBinding</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=o>{</span><span class=n>MyProcessor</span><span class=o>.</span><span class=na>class</span><span class=o>})</span>
</span></span><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CustomerApplication</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>SpringApplication</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>CustomerApplication</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>用 @EnableBinding(value = {MyProcessor.class}) 注解引入 MyProcessor</p><p><strong>创建消息接收处理服务</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@Component</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LogMessageListener</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 通过 MyProcessor.MESSAGE_INPUT 接收消息
</span></span></span><span class=line><span class=cl><span class=cm>     * 然后通过 SendTo 将处理后的消息发送到 MyProcessor.LOG_FORMAT_OUTPUT
</span></span></span><span class=line><span class=cl><span class=cm>     * @param message
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@StreamListener</span><span class=o>(</span><span class=n>MyProcessor</span><span class=o>.</span><span class=na>MESSAGE_INPUT</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nd>@SendTo</span><span class=o>(</span><span class=n>MyProcessor</span><span class=o>.</span><span class=na>LOG_FORMAT_OUTPUT</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>String</span> <span class=nf>processLogMessage</span><span class=o>(</span><span class=n>String</span> <span class=n>message</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;接收到原始消息：&#34;</span> <span class=o>+</span> <span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s>&#34;「&#34;</span> <span class=o>+</span> <span class=n>message</span> <span class=o>+</span><span class=s>&#34;」&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 接收来自 MyProcessor.LOG_FORMAT_INPUT 的消息
</span></span></span><span class=line><span class=cl><span class=cm>     * 也就是加工后的消息，也就是通过上面的 SendTo 发送来的
</span></span></span><span class=line><span class=cl><span class=cm>     * 因为 MyProcessor.LOG_FORMAT_OUTPUT 和 MyProcessor.LOG_FORMAT_INPUT 是指向同一 exchange
</span></span></span><span class=line><span class=cl><span class=cm>     * @param message
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@StreamListener</span><span class=o>(</span><span class=n>MyProcessor</span><span class=o>.</span><span class=na>LOG_FORMAT_INPUT</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>processFormatLogMessage</span><span class=o>(</span><span class=n>String</span> <span class=n>message</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;接收到格式化后的消息：&#34;</span> <span class=o>+</span> <span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>3、创建一个消息生产者，用于发送原始日志消息</p><p><strong>配置文件</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cloud</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>stream</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>bindings</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>log_output</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>destination</span><span class=p>:</span><span class=w> </span><span class=l>kite.log.messages</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>binder</span><span class=p>:</span><span class=w> </span><span class=l>local_rabbit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=l>logConsumer-group1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>binders</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>local_rabbit</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>rabbit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>rabbitmq</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>32775</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>guest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>guest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8202</span><span class=w>
</span></span></span></code></pre></div><p>仅仅指定了一个 binding log_output，用来发送消息，如果只做生产者就不要指定 log_input，如果指定了 log_input ，应用就会认为这个生产者服务也会消费消息，如果这时没有在此服务中订阅消息，当消息被发送到这个服务时，因为并没有订阅消息，也就是没有 @StreamListener 注解的方法，就会出现如下异常：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>org.springframework.messaging.MessageDeliveryException: Dispatcher has no subscribers <span class=k>for</span> channel
</span></span></code></pre></div><p><strong>创建 spring boot 启动类</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@RestController</span>
</span></span><span class=line><span class=cl><span class=nd>@EnableBinding</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=o>{</span><span class=n>MyProcessor</span><span class=o>.</span><span class=na>class</span><span class=o>})</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MyMessageController</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>MyProcessor</span> <span class=n>myProcessor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@GetMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;sendLogMessage&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>sendLogMessage</span><span class=o>(</span><span class=n>String</span> <span class=n>message</span><span class=o>){</span>
</span></span><span class=line><span class=cl>        <span class=n>Message</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>stringMessage</span> <span class=o>=</span> <span class=n>org</span><span class=o>.</span><span class=na>springframework</span><span class=o>.</span><span class=na>messaging</span><span class=o>.</span><span class=na>support</span><span class=o>.</span><span class=na>MessageBuilder</span><span class=o>.</span><span class=na>withPayload</span><span class=o>(</span><span class=n>message</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>myProcessor</span><span class=o>.</span><span class=na>logOutput</span><span class=o>().</span><span class=na>send</span><span class=o>(</span><span class=n>stringMessage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>同样的引入 @EnableBinding(value = {MyProcessor.class})</p><p><strong>创建一个 Controller 用来发送消息</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@RestController</span>
</span></span><span class=line><span class=cl><span class=nd>@EnableBinding</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=o>{</span><span class=n>MyProcessor</span><span class=o>.</span><span class=na>class</span><span class=o>})</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MyMessageController</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>MyProcessor</span> <span class=n>myProcessor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@GetMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;sendLogMessage&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>sendLogMessage</span><span class=o>(</span><span class=n>String</span> <span class=n>message</span><span class=o>){</span>
</span></span><span class=line><span class=cl>        <span class=n>Message</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>stringMessage</span> <span class=o>=</span> <span class=n>org</span><span class=o>.</span><span class=na>springframework</span><span class=o>.</span><span class=na>messaging</span><span class=o>.</span><span class=na>support</span><span class=o>.</span><span class=na>MessageBuilder</span><span class=o>.</span><span class=na>withPayload</span><span class=o>(</span><span class=n>message</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>myProcessor</span><span class=o>.</span><span class=na>logOutput</span><span class=o>().</span><span class=na>send</span><span class=o>(</span><span class=n>stringMessage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>之后，访问链接：</p><p>http://localhost:8202/sendLogMessage?message=原始日志</p><p>可以在消费服务端看到如下输出：
<img src=https://hexo.moonkite.cn/blog/273364-20190924095820387-1315301053.png alt></p><h2 id=其他><strong>其他</strong></h2><p>消息除了可以是字符串类型，还可以是其他类型，也可以是实体类型，例如</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;sendObjectLogMessage&#34;</span><span class=o>)</span> 
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>sendObjectLogMessage</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>LogInfo</span> <span class=n>logInfo</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LogInfo</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>logInfo</span><span class=o>.</span><span class=na>setClientIp</span><span class=o>(</span><span class=s>&#34;192.168.1.111&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>logInfo</span><span class=o>.</span><span class=na>setClientVersion</span><span class=o>(</span><span class=s>&#34;1.0&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>logInfo</span><span class=o>.</span><span class=na>setUserId</span><span class=o>(</span><span class=s>&#34;198663383837434&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>logInfo</span><span class=o>.</span><span class=na>setTime</span><span class=o>(</span><span class=n>Date</span><span class=o>.</span><span class=na>from</span><span class=o>(</span><span class=n>Instant</span><span class=o>.</span><span class=na>now</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>    <span class=n>Message</span> <span class=o>&lt;</span> <span class=n>LogInfo</span> <span class=o>&gt;</span> <span class=n>stringMessage</span> <span class=o>=</span> <span class=n>org</span><span class=o>.</span><span class=na>springframework</span><span class=o>.</span><span class=na>messaging</span><span class=o>.</span><span class=na>support</span><span class=o>.</span><span class=na>MessageBuilder</span><span class=o>.</span><span class=na>withPayload</span><span class=o>(</span><span class=n>logInfo</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>myProcessor</span><span class=o>.</span><span class=na>logOutput</span><span class=o>().</span><span class=na>send</span><span class=o>(</span><span class=n>stringMessage</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>上面代码发送了一个 LogInfo 实体对象，在消费者端依然可以用字符串类型接收，因为 @StreamListener 注解会默认把实体转为 json 字符串。</p><p>另外，可以试着启动两个消费者端，把 group 设置成相同的，这时，发送的消息只会被一个消费者接收。</p><p>如果把 group 设置成不一样的，那么发送的消息会被两个消费者接收。</p></article><div class=toc><h2>文章目录</h2><nav id=TableOfContents><ul><li><a href=#消息中间的几大应用场景><strong>消息中间的几大应用场景</strong></a></li><li><a href=#使用-spring-cloud-stream--rabbitmq><strong>使用 Spring Cloud Stream && RabbitMQ</strong></a></li><li><a href=#先来一个最简单的例子><strong>先来一个最简单的例子</strong></a></li><li><a href=#模拟一个日志处理><strong>模拟一个日志处理</strong></a></li><li><a href=#其他><strong>其他</strong></a></li></ul></nav></div><script>window.addEventListener("scroll",function(){var e=document.querySelector(".toc"),t=window.pageYOffset||document.documentElement.scrollTop,n=window.innerWidth||document.documentElement.clientWidth;t<360?e.style.top=380-t+"px":e.style.top="20px"})</script><h4>相关文章</h4><dl class=row><dd class=col-md-9><a href=/category/SpringCloud/4.-Spring-Cloud-Config-%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/>4. Spring Cloud Config 实现配置中心，看这一篇就够了</a></dd><dd class=col-md-9><a href=/category/SpringCloud/5-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%8F%91%E7%8E%B0%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E9%9B%86%E4%B8%80%E4%BD%93%E7%9A%84-Spring-Cloud-Consul/>5. 服务注册发现、配置中心集一体的 Spring Cloud Consul</a></dd><dd class=col-md-9><a href=/category/SpringCloud/0-Srping-Cloud-%E5%BC%80%E7%AF%87/>0. Spring Cloud 是什么</a></dd><dd class=col-md-9><a href=/category/SpringCloud/1-Spring-Cloud-Eureka-%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0/>1. Spring Cloud Eureka 实现服务注册与发现</a></dd><dd class=col-md-9><a href=/category/SpringCloud/2-Spring-Cloud-Eureka-%E5%AE%9E%E7%8E%B0%E5%AE%89%E5%85%A8%E6%8E%A7%E5%88%B6/>2. Spring Cloud Eureka 实现安全控制</a></dd></dl><div class=author-card><div class=underline></div><div class=author-box><div class=qr-author-image><a href=/><img src=/images/person.jpg alt=风筝></a></div><div class=author-content><p class=author-title>作者</p><p class=author-name>风筝</p><p class=author-desc>古时的风筝，一个平庸的程序员，主语言 Java，第二语言 Python，其实学 Python 的时间比 Java 还要早。喜欢写博客，写博客的过程能加深自己对一个知识点的理解，同时还可以分享给他人。喜欢做一些小东西，所以也会一些前端的东西，React、JavaScript、CSS 都会一些，做一些小工具还够用。</p></div></div></div><script src=https://utteranc.es/client.js repo=huzhicheng/blog-comment issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></main><div class="footer gradient-2"><div class="container footer-container"><div class=row><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>网站地图</div><ul class=list-unstyled><li><a href=https://www.moonkite.cn/tags/>标签</a></li><li><a href=https://www.moonkite.cn/categories/>分类</a></li><li><a rel=alternate type=application/rss+xml href=https://www.moonkite.cn/index.xml><i class="fas fa-rss-square"></i> RSS订阅</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>社群</div><ul class=list-unstyled><li><a href=https://github.com/huzhicheng rel=noopener target=_blank>GitHub</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>友链</div><ul class=list-unstyled><li><a href=https://github.com/huzhicheng rel=noopener target=_blank>关于我</a></li></ul></div><div class="col-xs-12 col-sm-3 col-md-3 col-lg-3"><p class="pull-right text-right"><small><em>Proudly powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo</a></em></small><br><small><em>Theme - <a href=https://github.com/shaform/hugo-theme-den rel=noopener target=_blank>Den</a></em></small><br><small>&copy;
风筝
2023</small></p></div></div><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?e417ddf834c7bb7411207e1fa09815aa",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-C714TFXRD4"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-C714TFXRD4")</script><div class=busuanzi-footer><span id=busuanzi_container_site_pv>本站总访问量<span id=busuanzi_value_site_pv></span>次</span>
<span id=busuanzi_container_site_uv>本站访客数<span id=busuanzi_value_site_uv></span>人次</span></div></div></div><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap_4.1.3_js_bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script>$(document).ready(function(){$("#load_disqus").length&&$(window).scroll(function(){if($("#load_disqus").length){var e=$("#load_disqus").offset().top,t=$(window).scrollTop(),n=t+$(window).height();t<e&&e<n&&load_disqus()}})})</script></body></html>