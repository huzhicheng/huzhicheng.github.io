<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage><head><meta name=generator content="Hugo 0.113.0"><meta charset=utf-8><title>7. 网关我选 Spring Cloud Gateway · 古时的风筝</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="网关可提供请求路由与组合、协议转换、安全认证、服务鉴权、流量控制与日志监控等服务。可选的网关有不少，比如 Nginx、高性能网关 OpenRes"><meta name=keywords content="Hugo,theme,编程,java,ChatGPT,程序员,开发"><link rel=canonical href=https://moonkite.cn/category/SpringCloud/7-Spring-Cloud-Gateway-%E7%BD%91%E5%85%B3%E7%9A%84%E4%BD%BF%E7%94%A8/><link rel=icon href=https://moonkite.cn/images/photo.png><link rel=stylesheet href=https://cdn.usebootstrap.com/bootstrap/4.1.3/css/bootstrap.min.css><link rel=stylesheet href=https://moonkite.cn/css/den.css><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="7. 网关我选 Spring Cloud Gateway"><meta property="og:description" content="网关可提供请求路由与组合、协议转换、安全认证、服务鉴权、流量控制与日志监控等服务。可选的网关有不少，比如 Nginx、高性能网关 OpenRes"><meta property="og:type" content="article"><meta property="og:url" content="https://moonkite.cn/category/SpringCloud/7-Spring-Cloud-Gateway-%E7%BD%91%E5%85%B3%E7%9A%84%E4%BD%BF%E7%94%A8/"><meta property="article:section" content="category"><meta property="article:published_time" content="2023-06-02T08:56:23+08:00"><meta property="article:modified_time" content="2023-06-02T08:56:23+08:00"><meta itemprop=name content="7. 网关我选 Spring Cloud Gateway"><meta itemprop=description content="网关可提供请求路由与组合、协议转换、安全认证、服务鉴权、流量控制与日志监控等服务。可选的网关有不少，比如 Nginx、高性能网关 OpenRes"><meta itemprop=datePublished content="2023-06-02T08:56:23+08:00"><meta itemprop=dateModified content="2023-06-02T08:56:23+08:00"><meta itemprop=wordCount content="2330"><meta itemprop=keywords content="Java,JDK,Spring Cloud,Spring Cloud Gateway,gateway,网关,"><meta name=twitter:card content="summary"><meta name=twitter:title content="7. 网关我选 Spring Cloud Gateway"><meta name=twitter:description content="网关可提供请求路由与组合、协议转换、安全认证、服务鉴权、流量控制与日志监控等服务。可选的网关有不少，比如 Nginx、高性能网关 OpenRes"></head><body><div class=header-container style=background:linear-gradient(rgba(0,0,0,.2),rgba(0,0,0,.2)),url(https://moonkite.cn/images/background.png);background-position:top;background-size:cover><div class=container><nav class="header-nav navbar navbar-expand-md navbar-dark light-dark"><div class="header-logo navbar-brand"><a class=float-left href=https://moonkite.cn/></a></div><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="nav-menu collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a href=https://moonkite.cn/ class=nav-link><i class="fas fad fa-h-square"></i>主页</a></li><li class=nav-item><a href=https://moonkite.cn/category/notes/ class=nav-link><i class='fas fa-yin-yang'></i>生活随笔</a></li><li class=nav-item><a href=javascript:void(0) class=nav-link><i class='fas fa-laptop-code'></i>技术文章</a><div class=sub-dropdown-menu><a class=sub-nav-link href=https://moonkite.cn/category/java><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"><path fill="#f44336" d="M23.65 24.898c-.998-1.609-1.722-2.943-2.725-5.455C19.229 15.2 31.24 11.366 26.37 3.999c2.111 5.089-7.577 8.235-8.477 12.473-.823 3.898 5.752 8.426 5.757 8.426z"/><path fill="#f44336" d="M23.878 17.27c-.192 2.516 2.229 3.857 2.299 5.695.056 1.496-1.447 2.743-1.447 2.743s2.728-.536 3.579-2.818c.945-2.534-1.834-4.269-1.548-6.298.267-1.938 6.031-5.543 6.031-5.543S24.311 11.611 23.878 17.27z"/><g><path fill="#1565c0" d="M32.084 25.055c1.754-.394 3.233.723 3.233 2.01.0 2.901-4.021 5.643-4.021 5.643s6.225-.742 6.225-5.505c0-3.15-3.057-3.937-5.437-2.148zm-2.955 2.34s1.941-1.383 2.458-1.902c-4.763 1.011-15.638 1.147-15.638.269.0-.809 3.507-1.638 3.507-1.638s-7.773-.112-7.773 2.181C11.683 28.695 21.858 28.866 29.129 27.395z"/><path fill="#1565c0" d="M27.935 29.571c-4.509 1.499-12.814 1.02-10.354-.993-1.198.0-2.974.963-2.974 1.889.0 1.857 8.982 3.291 15.63.572l-2.302-1.468z"/><path fill="#1565c0" d="M18.686 32.739c-1.636.0-2.695 1.054-2.695 1.822.0 2.391 9.76 2.632 13.627.205l-2.458-1.632C24.271 34.404 17.014 34.579 18.686 32.739z"/><path fill="#1565c0" d="M36.281 36.632c0-.936-1.055-1.377-1.433-1.588 2.228 5.373-22.317 4.956-22.317 1.784.0-.721 1.807-1.427 3.477-1.093l-1.42-.839C11.26 34.374 9 35.837 9 37.017 9 42.52 36.281 42.255 36.281 36.632z"/><path fill="#1565c0" d="M39 38.604c-4.146 4.095-14.659 5.587-25.231 3.057C24.341 46.164 38.95 43.628 39 38.604z"/></g></svg>&nbsp;可爱的 Java</a>
<a class=sub-nav-link href=https://moonkite.cn/category/SpringCloud><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48"><path fill="#8bc34a" d="M43.982 23.635c.069-4.261-.891-9.328-2.891-15.273L39.523 3.7l-2.13 4.433c-.114.237-.244.469-.38.698C33.514 5.827 28.974 4 24 4 12.954 4 4 12.954 4 24s8.954 20 20 20 20-8.954 20-20C44 23.877 43.984 23.758 43.982 23.635z"/><path fill="#fff" d="M39.385 32.558C36.262 36.86 30.734 37.091 25.531 37H18.75h-1.938c4.428-1.593 7.063-1.972 9.754-3.4 5.068-2.665 10.078-8.496 11.121-14.562-1.93 5.836-7.779 10.85-13.109 12.889-3.652 1.393-10.248 2.745-10.248 2.745l-.267-.145C9.573 32.268 9.437 22.214 17.6 18.968c3.574-1.423 6.993-.641 10.854-1.593 4.122-1.012 8.89-4.208 10.83-8.375C41.456 15.667 44.07 26.106 39.385 32.558zM15.668 38.445C15.386 38.795 14.955 39 14.505 39c-.823.0-1.495-.677-1.495-1.5s.677-1.5 1.495-1.5c.341.0.677.118.941.336C16.086 36.855 16.186 37.805 15.668 38.445z"/></svg>&nbsp; Spring Cloud 系列</a></div></li><li class=nav-item><a href=https://moonkite.cn/category/network class=nav-link><i class="fas fa-network-wired"></i>轻解计算机网络</a></li><li class=nav-item><a href=https://moonkite.cn/category/product class=nav-link><i class="fas fab fa-medapps"></i>我的产品</a></li></ul></div></nav></div><div class="container header-wrapper"><div class=row><div class=col-lg-12><div class=header-content><h1 class=header-title>7. 网关我选 Spring Cloud Gateway</h1><p class=header-date>作者：
风筝 /
2023-06-02<div class=header-underline></div><div class=header-date>&nbsp·&nbsp
  <span id=busuanzi_container_page_pv>本文被阅读<span id=busuanzi_value_page_pv></span>次</span></div><div class=clearfix></div><p class="float-right header-tags"><i class="fas fa-tags" aria-hidden=true></i>
<a href=https://moonkite.cn/tag/gateway/>gateway</a>,
<a href=https://moonkite.cn/tag/Java/>Java</a>,
<a href=https://moonkite.cn/tag/JDK/>JDK</a>,
<a href=https://moonkite.cn/tag/Spring-Cloud/>Spring Cloud</a>,
<a href=https://moonkite.cn/tag/Spring-Cloud-Gateway/>Spring Cloud Gateway</a>,
<a href=https://moonkite.cn/tag/%E7%BD%91%E5%85%B3/>网关</a></p></div></div></div></div></div><main><div class="container content"><article><p>网关可提供<strong>请求路由与组合</strong>、<strong>协议转换</strong>、<strong>安全认证</strong>、<strong>服务鉴权</strong>、<strong>流量控制</strong>与<strong>日志监控</strong>等服务。可选的网关有不少，比如 Nginx、高性能网关 OpenResty、Linkerd 以及 Spring Cloud Gateway。</p><p>如果是真的追求高性能，那肯定是选择 Nginx 或者 OpenResty 无疑了， 但是对性能要求不是很高的话，并且又在用 Spring Cloud 系列，那当然就要选择 Spring Cloud Gateway 了。</p><p>网关的基础就是路由功能，通俗解释就是地址转发，将一个请求地址转发到实际的服务地址。比如请求的是 <a href=http://xxx.com/api>http://xxx.com/api</a> 的路由地址，实际上会被转发到 <a href=http://xxx.com:8888>http://xxx.com:8888</a> 上来，这就是个最简单的路由方式。</p><p>我们可以理解为 Spring Cloud Gateway 就是针对进来的请求做各种判断和处理，比如说判断请求的合法性、权限验证，请求地址改写，请求参数、头信息、cookie 信息的分析和改写，请求速率控制，日志留存等。而这些都可以方便的通过 Predicate 和 GatewayFilter 来组合实现。</p><h3 id=创建-spring-cloud-gateway-项目>创建 Spring Cloud Gateway 项目</h3><p>Spring Cloud 版本是 Greenwich.SR2，Spring Boot 版本 2.1.6.RELEASE，JDK 1.8。</p><p>接下来正式创建一个 Gateway 项目。</p><p><em>首先做两个微服务，当做路由转发的目标服务</em></p><p>两个微服务是以 consul 作为服务注册中心的，可以看这篇文章<a href=https://mp.weixin.qq.com/s/HKhzKT4oMX8S_Jg1nLtxNA>服务注册发现、配置中心集一体的 Spring Cloud Consul</a></p><p>1、创建 consul-order 服务，具体可以去 github 上看<a href=https://github.com/huzhicheng/spring-cloud-study/tree/master/consul/consul-order>代码</a>，很简单的一个服务。创建的 RESTful Controller 如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span>
</span></span><span class=line><span class=cl><span class=nd>@RequestMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;order&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>OrderController</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Value</span><span class=o>(</span><span class=s>&#34;${spring.application.name}&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>applicationName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@GetMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;get&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>CustomerOrder</span> <span class=nf>getOrder</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>        <span class=n>CustomerOrder</span> <span class=n>customerOrder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CustomerOrder</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>customerOrder</span><span class=o>.</span><span class=na>setOrderId</span><span class=o>(</span><span class=s>&#34;9999&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>customerOrder</span><span class=o>.</span><span class=na>setProductName</span><span class=o>(</span><span class=s>&#34;MacBook Pro&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>customerOrder</span><span class=o>.</span><span class=na>setClient</span><span class=o>(</span><span class=n>applicationName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>customerOrder</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>总之，最后直接访问这个接口的地址为 <a href=http://localhost:5006/order/get>http://localhost:5006/order/get</a></p><p>2、创建 consul-user 服务，具体代码可以到<a href=https://github.com/huzhicheng/spring-cloud-study/tree/master/consul/consul-user> github 上查看</a>。</p><p>创建的 RESTful Controller 内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span>
</span></span><span class=line><span class=cl><span class=nd>@RequestMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;user&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>UserController</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@GetMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;get&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>User</span> <span class=nf>getUserInfo</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>        <span class=n>User</span> <span class=n>user</span> <span class=o>=</span> <span class=k>new</span> <span class=n>User</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>user</span><span class=o>.</span><span class=na>setName</span><span class=o>(</span><span class=s>&#34;古时的风筝&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>user</span><span class=o>.</span><span class=na>setAge</span><span class=o>(</span><span class=mi>8</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>user</span><span class=o>.</span><span class=na>setLocation</span><span class=o>(</span><span class=s>&#34;北京&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>user</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>和上面的微服务有点区别的就是设置了 context-path</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>5005</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>servlet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>context-path</span><span class=p>:</span><span class=w> </span><span class=l>/user-service</span><span class=w>
</span></span></span></code></pre></div><p>之所以这样不同的设置，是因为下面要验证一个 filter。总之，最后上述接口的访问地址为：<a href=http://localhost:5005/user-service/user/get>http://localhost:5005/user-service/user/get</a></p><p><em>创建一个项目，并引入 maven 包</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-gateway<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-webflux<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p><em>配置简单的路由转发</em></p><p>路由配置有两种方式。一种是配置文件，另外一种是代码方式配置，WebFlux 的反应式编程方式。所以我们 pom 文件中要引入 WebFlux 的包。这是 Spring 5 的新特性。</p><p>1、先看第一种配置文件方式配置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>10000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>application</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cloud</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>gateway</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>discovery</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>locator</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>lower-case-service-id</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># 是否将服务id转换为小写</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>routes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>userServiceRouter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uri</span><span class=p>:</span><span class=w> </span><span class=l>lb://consul-user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>predicates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>Path=/user-service/**</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>orderServiceRouter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uri</span><span class=p>:</span><span class=w> </span><span class=l>lb://consul-order</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>predicates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>Path=/order-service/**</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>filters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>StripPrefix=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>consul</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w> </span><span class=c>#注册gateway网关到consul</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8500</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>discovery</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>service-name</span><span class=p>:</span><span class=w> </span><span class=l>service-gateway</span><span class=w>
</span></span></span></code></pre></div><p>其中包括 Spring Boot 项目的基本配置，name、port ，还有关于 consul 的配置，要将网关服务注册到注册中心。</p><p>上面配置中创建了两条路由规则，路由规则名称通过 id 设置，分别是 userServiceRouter 和 orderServiceRouter，通过 predicates.Path 设置待转发的 url，通过 uri 设置转发后的目标地址。上面配置将以<code> /user-service/</code>开头的地址转发到 <code>lb://consul-user </code>,固定格式 lb + 服务id，在有注册中心的情况下要这样写，如过没有注册中心，可以直接写目标 url。</p><p>下面的路由规则中多了一个 StripPrefix 的 filter ，这个是 Gateway 的内置 filter，作用就是去掉 Path 中的指定部分，StripPrefix=1，就是以 / 分隔，去掉第一部分，比如 /a/b/c 这个地址，在 StripPrefix=1 的作用下，就会转发到 /b/c/，当 StripPrefix=2 的时候，就会转发到 /c/。</p><p>配置好上述接口，然后启动网关服务。访问规则就会有如下对应关系:</p><p><a href=http://localhost:10000/user-service/user/get>http://localhost:10000/user-service/user/get</a>-><a href=http://localhost:5005/user-service/user/get>http://localhost:5005/user-service/user/get</a></p><p><a href=http://localhost:10000/order-service/order/get>http://localhost:10000/order-service/order/get</a>-><a href=http://localhost:5006/order/get>http://localhost:5006/order/get</a></p><p>当然这只是针对每一个目标服务只有一个实例的情况，如果有多个实例，就会按照负载策略落到对应的实例中。</p><p>2、代码方式的路由配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>RouteLocator</span> <span class=nf>kiteRouteLocator</span><span class=o>(</span><span class=n>RouteLocatorBuilder</span> <span class=n>builder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>builder</span><span class=o>.</span><span class=na>routes</span><span class=o>()</span>
</span></span><span class=line><span class=cl>		<span class=o>.</span><span class=na>route</span><span class=o>(</span><span class=s>&#34;userRouter&#34;</span><span class=o>,</span> <span class=n>r</span> <span class=o>-&gt;</span> <span class=n>r</span><span class=o>.</span><span class=na>path</span><span class=o>(</span><span class=s>&#34;/user-service/**&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>			<span class=o>.</span><span class=na>filters</span><span class=o>(</span><span class=n>f</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>				<span class=n>f</span><span class=o>.</span><span class=na>addResponseHeader</span><span class=o>(</span><span class=s>&#34;X-CustomerHeader&#34;</span><span class=o>,</span> <span class=s>&#34;kite&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>			<span class=o>.</span><span class=na>uri</span><span class=o>(</span><span class=s>&#34;lb://consul-user&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>		<span class=o>)</span>
</span></span><span class=line><span class=cl>		<span class=o>.</span><span class=na>route</span><span class=o>(</span><span class=s>&#34;orderRouter&#34;</span><span class=o>,</span> <span class=n>r</span> <span class=o>-&gt;</span> <span class=n>r</span><span class=o>.</span><span class=na>path</span><span class=o>(</span><span class=s>&#34;/order-service/**&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>			<span class=o>.</span><span class=na>filters</span><span class=o>(</span><span class=n>f</span> <span class=o>-&gt;</span> <span class=n>f</span><span class=o>.</span><span class=na>stripPrefix</span><span class=o>(</span><span class=mi>1</span><span class=o>)).</span><span class=na>uri</span><span class=o>(</span><span class=s>&#34;lb://consul-order&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>		<span class=o>)</span>
</span></span><span class=line><span class=cl>		<span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>上面的这段代码和前面的配置文件的内容是同样的作用。只要实现一个返回类型为 <code>RouteLocator</code>，参数为 <code>RouteLocatorBuilder</code>类型的 Bean。</p><p>你看后面那一连串的 r.path().filters().uri() 了吗，用它们就可以简单的配置出路由规则，而且可读性也比较强。另外，Gateway 还套用了 Predicate 的规则来构建更加灵活、复杂的路由规则。Predicate 是 Java 8 增加的逻辑计算库，有 negate()、and()、or()、isEqual()几个方法。具体的代码在 PredicateSpec 和 UriSpec 这两个类里，一目了然。</p><p><img src=https://hexo.moonkite.cn/blog/273364-20191011084336725-1715618532.png alt></p><p>PredicateSpec 里有这么多方法，都可以结合 and、or 组合起来使用。</p><p>接下来就说到 filter，Gateway 内置了很多的 filter，可以在 GatewayFilterSpec 类下找到方法封装，每一个 filter 都由一个 factory 的 apply 实现，都在 <code>org.springframework.cloud.gateway.filter.factory</code>包下，有必要的话可以直接看源码。 比如上面用到的 StripPrefix。还有 addResponseHeader，它的作用是在 Response 对象的 header 中添加请求头。</p><p><em>启动网关服务</em></p><p>启动网关，并访问两个接口测试，接口分别为 http://localhost:10000/user-service/user/get和http://localhost:10000/order-service/order/get，正常返回数据，则说明网关服务配置正常。</p><h3 id=巧用-stripprefix-filter>巧用 StripPrefix filter</h3><p>微服务多了之后，路由的转发规则也就多了，比方说订单相关请求要转发到订单微服务集群，用户相关请求要转发到用户微服务集群，最终开放给终端的接口也要能表明是哪个微服务的，除了接口文档里说明之外，接口本身最好也能明确标识。</p><p>一种方式是在微服务的配置文件中配置上<code>server.servlet.context-path</code>。</p><p>还有一种方式就是在路由规则的 path 中配置，然后加上 StripPrefix 配置，选择性的去掉请求 url 中的某些部分。比如我们请求 Gateway的地址为 order-service/order/get，则经过 StripPrefix(1) 之后，会把请求地址变为 order/get，然后根据路由规则定向到具体的微服务地址或者特定的 url。</p><p>本篇就介绍 Spring Cloud Gateway 的基本用法，后续还会有关于集成安全认证、鉴权、限流、日志等相关内容，敬请关注。</p></article><h4>相关文章</h4><dl class=row><dd class=col-md-9><a href=/category/SpringCloud/0-Srping-Cloud-%E5%BC%80%E7%AF%87/>0. Spring Cloud 是什么</a></dd><dd class=col-md-9><a href=/category/SpringCloud/1-Spring-Cloud-Eureka-%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0/>1. Spring Cloud Eureka 实现服务注册与发现</a></dd><dd class=col-md-9><a href=/category/SpringCloud/2-Spring-Cloud-Eureka-%E5%AE%9E%E7%8E%B0%E5%AE%89%E5%85%A8%E6%8E%A7%E5%88%B6/>2. Spring Cloud Eureka 实现安全控制</a></dd><dd class=col-md-9><a href=/category/SpringCloud/3-Spring-Cloud-Eureka-%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/>3. Spring Cloud Eureka 实现高可用服务发现注册中心</a></dd><dd class=col-md-9><a href=/category/SpringCloud/4.-Spring-Cloud-Config-%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/>4. Spring Cloud Config 实现配置中心，看这一篇就够了</a></dd></dl><div class=author-card><div class=underline></div><div class=author-box><div class=qr-author-image><a href=https://www.moonkite.cn><img src=/images/person.jpg alt=风筝></a></div><div class=author-content><p class=author-title>作者</p><p class=author-name>风筝</p><p class=author-desc>古时的风筝，一个平庸的程序员，主语言 Java，第二语言 Python，其实学 Python 的时间比 Java 还要早。喜欢写博客，写博客的过程能加深自己对一个知识点的理解，同时还可以分享给他人。喜欢做一些小东西，所以也会一些前端的东西，React、JavaScript、CSS 都会一些，做一些小工具还够用。</p></div></div></div><script src=https://utteranc.es/client.js repo=huzhicheng/blog-comment issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></main><div class="footer gradient-2"><div class="container footer-container"><div class=row><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>网站地图</div><ul class=list-unstyled><li><a href=https://moonkite.cn/tags/>标签</a></li><li><a href=https://moonkite.cn/categories/>分类</a></li><li><a rel=alternate type=application/rss+xml href=https://moonkite.cn/index.xml><i class="fas fa-rss-square"></i> RSS订阅</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>社群</div><ul class=list-unstyled><li><a href=https://github.com/huzhicheng rel=noopener target=_blank>GitHub</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>友链</div><ul class=list-unstyled><li><a href=https://github.com/huzhicheng rel=noopener target=_blank>关于我</a></li></ul></div><div class="col-xs-12 col-sm-3 col-md-3 col-lg-3"><p class="pull-right text-right"><small><em>Proudly powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo</a></em></small><br><small><em>Theme - <a href=https://github.com/shaform/hugo-theme-den rel=noopener target=_blank>Den</a></em></small><br><small>&copy;
风筝
2023</small></p></div></div><div class=busuanzi-footer><span id=busuanzi_container_site_pv>本站总访问量<span id=busuanzi_value_site_pv></span>次</span>
<span id=busuanzi_container_site_uv>本站访客数<span id=busuanzi_value_site_uv></span>人次</span></div></div></div><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap_4.1.3_js_bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script>$(document).ready(function(){$("#load_disqus").length&&$(window).scroll(function(){if($("#load_disqus").length){var e=$("#load_disqus").offset().top,t=$(window).scrollTop(),n=t+$(window).height();t<e&&e<n&&load_disqus()}})})</script></body></html>