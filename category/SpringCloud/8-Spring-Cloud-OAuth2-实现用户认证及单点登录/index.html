<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage><head><meta name=generator content="Hugo 0.118.2"><meta charset=utf-8><title>8. Spring Cloud OAuth2 实现用户认证及单点登录 · 古时的风筝</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="OAuth 2 有四种授权模式，分别是授权码模式（authorization code）、简化模式（implicit）、密码模式（resource owner password cr"><meta name=360-site-verification content="e75339f1cfcde17f66f71aaf8b6983e9"><meta name=keywords content="Hugo,theme,编程,java,ChatGPT,程序员,开发"><meta name=google-site-verification content="google57680cd58c46e2f3.html"><link rel=canonical href=https://www.moonkite.cn/category/SpringCloud/8-Spring-Cloud-OAuth2-%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/><link rel=icon href=https://www.moonkite.cn/images/photo.png><link rel=stylesheet href=https://cdn.usebootstrap.com/bootstrap/4.1.3/css/bootstrap.min.css><link rel=stylesheet href=https://www.moonkite.cn/css/den.css><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-tc-webfont@1.0.0/style.css><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="8. Spring Cloud OAuth2 实现用户认证及单点登录"><meta property="og:description" content="OAuth 2 有四种授权模式，分别是授权码模式（authorization code）、简化模式（implicit）、密码模式（resource owner password cr"><meta property="og:type" content="article"><meta property="og:url" content="https://www.moonkite.cn/category/SpringCloud/8-Spring-Cloud-OAuth2-%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/"><meta property="article:section" content="category"><meta property="article:published_time" content="2023-06-02T08:56:23+08:00"><meta property="article:modified_time" content="2023-06-02T08:56:23+08:00"><meta itemprop=name content="8. Spring Cloud OAuth2 实现用户认证及单点登录"><meta itemprop=description content="OAuth 2 有四种授权模式，分别是授权码模式（authorization code）、简化模式（implicit）、密码模式（resource owner password cr"><meta itemprop=datePublished content="2023-06-02T08:56:23+08:00"><meta itemprop=dateModified content="2023-06-02T08:56:23+08:00"><meta itemprop=wordCount content="6354"><meta itemprop=keywords content="Java,JDK,Spring Cloud,Spring Cloud OAuth2,OAuth2,用户认证,单点登录,"><meta name=twitter:card content="summary"><meta name=twitter:title content="8. Spring Cloud OAuth2 实现用户认证及单点登录"><meta name=twitter:description content="OAuth 2 有四种授权模式，分别是授权码模式（authorization code）、简化模式（implicit）、密码模式（resource owner password cr"></head><body><div class=header-container style=background:linear-gradient(rgba(0,0,0,.2),rgba(0,0,0,.2)),url(https://www.moonkite.cn/images/background.png);background-position:top;background-size:cover><div class=container><nav class="header-nav navbar navbar-expand-md navbar-dark light-dark"><div class="header-logo navbar-brand"><a class=float-left href=https://www.moonkite.cn/></a></div><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="nav-menu collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a href=https://www.moonkite.cn/ class=nav-link><i class="fas fad fa-h-square"></i>主页</a></li><li class=nav-item><a href=https://www.moonkite.cn/category/notes class=nav-link><i class='fas fa-yin-yang'></i>生活随笔</a></li><li class=nav-item><a href=javascript:void(0) class=nav-link><i class='fas fa-laptop-code'></i>技术文章</a><div class=sub-dropdown-menu><a class=sub-nav-link href=https://www.moonkite.cn/category/java><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"><path fill="#f44336" d="M23.65 24.898c-.998-1.609-1.722-2.943-2.725-5.455C19.229 15.2 31.24 11.366 26.37 3.999c2.111 5.089-7.577 8.235-8.477 12.473-.823 3.898 5.752 8.426 5.757 8.426z"/><path fill="#f44336" d="M23.878 17.27c-.192 2.516 2.229 3.857 2.299 5.695.056 1.496-1.447 2.743-1.447 2.743s2.728-.536 3.579-2.818c.945-2.534-1.834-4.269-1.548-6.298.267-1.938 6.031-5.543 6.031-5.543S24.311 11.611 23.878 17.27z"/><g><path fill="#1565c0" d="M32.084 25.055c1.754-.394 3.233.723 3.233 2.01.0 2.901-4.021 5.643-4.021 5.643s6.225-.742 6.225-5.505c0-3.15-3.057-3.937-5.437-2.148zm-2.955 2.34s1.941-1.383 2.458-1.902c-4.763 1.011-15.638 1.147-15.638.269.0-.809 3.507-1.638 3.507-1.638s-7.773-.112-7.773 2.181C11.683 28.695 21.858 28.866 29.129 27.395z"/><path fill="#1565c0" d="M27.935 29.571c-4.509 1.499-12.814 1.02-10.354-.993-1.198.0-2.974.963-2.974 1.889.0 1.857 8.982 3.291 15.63.572l-2.302-1.468z"/><path fill="#1565c0" d="M18.686 32.739c-1.636.0-2.695 1.054-2.695 1.822.0 2.391 9.76 2.632 13.627.205l-2.458-1.632C24.271 34.404 17.014 34.579 18.686 32.739z"/><path fill="#1565c0" d="M36.281 36.632c0-.936-1.055-1.377-1.433-1.588 2.228 5.373-22.317 4.956-22.317 1.784.0-.721 1.807-1.427 3.477-1.093l-1.42-.839C11.26 34.374 9 35.837 9 37.017 9 42.52 36.281 42.255 36.281 36.632z"/><path fill="#1565c0" d="M39 38.604c-4.146 4.095-14.659 5.587-25.231 3.057C24.341 46.164 38.95 43.628 39 38.604z"/></g></svg>&nbsp;可爱的 Java</a>
<a class=sub-nav-link href=https://www.moonkite.cn/category/SpringCloud><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48"><path fill="#8bc34a" d="M43.982 23.635c.069-4.261-.891-9.328-2.891-15.273L39.523 3.7l-2.13 4.433c-.114.237-.244.469-.38.698C33.514 5.827 28.974 4 24 4 12.954 4 4 12.954 4 24s8.954 20 20 20 20-8.954 20-20C44 23.877 43.984 23.758 43.982 23.635z"/><path fill="#fff" d="M39.385 32.558C36.262 36.86 30.734 37.091 25.531 37H18.75h-1.938c4.428-1.593 7.063-1.972 9.754-3.4 5.068-2.665 10.078-8.496 11.121-14.562-1.93 5.836-7.779 10.85-13.109 12.889-3.652 1.393-10.248 2.745-10.248 2.745l-.267-.145C9.573 32.268 9.437 22.214 17.6 18.968c3.574-1.423 6.993-.641 10.854-1.593 4.122-1.012 8.89-4.208 10.83-8.375C41.456 15.667 44.07 26.106 39.385 32.558zM15.668 38.445C15.386 38.795 14.955 39 14.505 39c-.823.0-1.495-.677-1.495-1.5s.677-1.5 1.495-1.5c.341.0.677.118.941.336C16.086 36.855 16.186 37.805 15.668 38.445z"/></svg>&nbsp; Spring Cloud 系列</a>
<a class=sub-nav-link href=https://www.moonkite.cn/category/other><img width=20 height=20 src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAADWElEQVR4nO2X30tTYRjH9xd4X2Dsol1EEtJdEFiSF10pldlVaVHEjiFFkKQVQeV0kfSTHdfW1pzKlpZtzXJuzp2pmzPFTdmUTdLJlEAvNKyB8MYzPG/visHZ2jxrnQc+8PCc85zz/e592XkfkUgIIYT4v2OoTVrtVFDTjILaYmgK8YqC2oproalzKZlwKqga3sXTSeFuZts9ykWcNOXnbITcTj67IRQcG1rlE5/dECK3GXcjxC8ADwqMuxGfBMeGVklNaRmZ83z0L3+ZR3ywMBfInJHQqGl07esKAmYjK6hnJoph64Ar/KsOOXmNK6HOTszKtD9uJitGQGSRcQFDiqh1RHAd8nSMWMQSDJgRjLAhrIgxta3lDvaiRlMpxvKvbi3BCNfI+xVRehdRIT2DIUWdejeH65BzMWKd1KO6jqOYLrEE46fp7Bm5bgki0Q0bhhS1t3UM1yHnYuS1XY5Oy0swD8USjPNmQ2aNfO6WO0KjphHgbrc9XNjsirGwdeAY7Vpl65CT15LRYb4VltLHYyzKAwcxgw3Xwr5BQ9D9ll53dz9d+msjfNLfWoO6GstR7/0zCXXBCJMPKxLMl3kkmC9GQsTf706znK3vyKLdhtznL2ISPm5TaqQdro8DeTJxm4EHKDZRGQfy308HtdvAcJY1I3BsII8RpAgwwB41IE9mBAwgR0EcyMlrRcTxB45DgpFUV+RbSIMxuq4kXRFyFl+3VuTeiqBtQYCDqUxqhOyJPCsTjDDCitB5urW8zS2oTSzBxNS7MB3tpeiC4kicO8azCQLJnkB9Me750Xs44b4CmQcjc4SzZwSGHXL42Xy0B6NTHMIDUp36RIJAsmeS2od7vuuKE+4TEUMbDHGZMLLBNrlUV/3u9sYRwH7vkq/nZFmUJaotwfRoK5bk6qoooNRUh9kegOyZkpUtsT3zuvKE+6qev4myKF899nkNTeMTJuWsu6spTBjZ4GzESUv7+R6qmCQ4aeoTZyPDLy4XMTS1xrdo5k/WmDbpflEq4XpJ7XbS1O0+bYvnve7JLNCnkXkZWmrYCfo0Mi9+r7bFA1pAkyjd0Ov1EZVKhQDI034Q3++1mM39H8xmBECeEZV8vNdmtRptAwMojtVqzIjKHH6vEEIIIcrt+AnU4LBcH67z1wAAAABJRU5ErkJggg=="> &nbsp; 杂七杂八</a></div></li><li class=nav-item><a href=https://www.moonkite.cn/category/network class=nav-link><i class="fas fa-network-wired"></i>轻解计算机网络</a></li><li class=nav-item><a href=https://www.moonkite.cn/category/product class=nav-link><i class="fas fab fa-medapps"></i>我的产品</a></li></ul></div></nav></div><div class="container header-wrapper"><div class=row><div class=col-lg-12><div class=header-content><h1 class=header-title>8. Spring Cloud OAuth2 实现用户认证及单点登录</h1><p class=header-date>作者：
风筝 /
2023-06-02<div class=header-underline></div><div class=header-date>&nbsp·&nbsp
  <span id=busuanzi_container_page_pv>本文被阅读<span id=busuanzi_value_page_pv></span>次</span></div><div class=clearfix></div><p class="float-right header-tags"><i class="fas fa-tags" aria-hidden=true></i>
<a href=https://www.moonkite.cn/tag/Java/>Java</a>,
<a href=https://www.moonkite.cn/tag/JDK/>JDK</a>,
<a href=https://www.moonkite.cn/tag/OAuth2/>OAuth2</a>,
<a href=https://www.moonkite.cn/tag/Spring-Cloud/>Spring Cloud</a>,
<a href=https://www.moonkite.cn/tag/Spring-Cloud-OAuth2/>Spring Cloud OAuth2</a>,
<a href=https://www.moonkite.cn/tag/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/>单点登录</a>,
<a href=https://www.moonkite.cn/tag/%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81/>用户认证</a></p></div></div></div></div></div><main><div class="container content"><article><p>OAuth 2 有四种授权模式，分别是授权码模式（authorization code）、简化模式（implicit）、密码模式（resource owner password credentials）、客户端模式（client credentials），具体 OAuth2 是什么，可以参考这篇文章。(<a href=http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html>http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html</a>)</p><p><img src=https://hexo.moonkite.cn/blog/bg2014051203.png alt></p><p>本文我们将使用授权码模式和密码模式两种方式来实现用户认证和授权管理。</p><p>OAuth2 其实是一个关于授权的网络标准，它制定了设计思路和运行流程，利用这个标准我们其实是可以自己实现 OAuth2 的认证过程的。今天要介绍的 spring-cloud-starter-oauth2 ，其实是 Spring Cloud 按照 OAuth2 的标准并结合 spring-security 封装好的一个具体实现。</p><h3 id=什么情况下需要用-oauth2>什么情况下需要用 OAuth2</h3><p>首先大家最熟悉的就是几乎每个人都用过的，比如用微信登录、用 QQ 登录、用微博登录、用 Google 账号登录、用 github 授权登录等等，这些都是典型的 OAuth2 使用场景。假设我们做了一个自己的服务平台，如果不使用 OAuth2 登录方式，那么我们需要用户先完成注册，然后用注册号的账号密码或者用手机验证码登录。而使用了 OAuth2 之后，相信很多人使用过、甚至开发过公众号网页服务、小程序，当我们进入网页、小程序界面，第一次使用就无需注册，直接使用微信授权登录即可，大大提高了使用效率。因为每个人都有微信号，有了微信就可以马上使用第三方服务，这体验不要太好了。而对于我们的服务来说，我们也不需要存储用户的密码，只要存储认证平台返回的唯一ID 和用户信息即可。</p><p>以上是使用了 OAuth2 的授权码模式，利用第三方的权威平台实现用户身份的认证。当然了，如果你的公司内部有很多个服务，可以专门提取出一个认证中心，这个认证中心就充当上面所说的权威认证平台的角色，所有的服务都要到这个认证中心做认证。</p><p>这样一说，发现没，这其实就是个单点登录的功能。这就是另外一种使用场景，对于多服务的平台，可以使用 OAuth2 实现服务的单点登录，只做一次登录，就可以在多个服务中自由穿行，当然仅限于授权范围内的服务和接口。</p><h3 id=实现统一认证功能>实现统一认证功能</h3><p>本篇先介绍密码模式实现的单点登录，下一篇再继续说授权码模式。</p><p>在微服务横行的今天，谁敢说自己手上没几个微服务。微服务减少了服务间的耦合，同时也在某些方面增加了系统的复杂度，比如说用户认证。假设我们这里实现了一个电商平台，用户看到的就是一个 APP 或者一个 web 站点，实际上背后是由多个独立的服务构成的，比如用户服务、订单服务、产品服务等。用户只要第一次输入用户名、密码完成登录后，一段时间内，都可以任意访问各个页面，比如产品列表页面、我的订单页面、我的关注等页面。</p><p>我们可以想象一下，自然能够想到，在请求各个服务、各个接口的时候，一定携带着什么凭证，然后各个服务才知道请求接口的用户是哪个，不然肯定有问题，那其实这里面的凭证简单来说就是一个 Token，标识用户身份的 Token。</p><h4 id=系统架构说明>系统架构说明</h4><p>认证中心：oauth2-auth-server，OAuth2 主要实现端，Token 的生成、刷新、验证都在认证中心完成。</p><p>订单服务：oauth2-client-order-server，微服务之一，接收到请求后会到认证中心验证。</p><p>用户服务：oauth2-client-user-server，微服务之二，接收到请求后会到认证中心验证。</p><p>客户端：例如 APP 端、web 端 等终端</p><p><img src=https://hexo.moonkite.cn/blog/273364-20191023100717630-187909841.png alt></p><p>上图描述了使用了 OAuth2 的客户端与微服务间的请求过程。大致的过程就是客户端用用户名和密码到认证服务端换取 token，返回给客户端，客户端拿着 token 去各个微服务请求数据接口，一般这个 token 是放到 header 中的。当微服务接到请求后，先要拿着 token 去认证服务端检查 token 的合法性，如果合法，再根据用户所属的角色及具有的权限动态的返回数据。</p><h5 id=创建并配置认证服务端>创建并配置认证服务端</h5><p>配置最多的就是认证服务端，验证账号、密码，存储 token，检查 token ,刷新 token 等都是认证服务端的工作。</p><p><em>1、引入需要的 maven 包</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-web<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p><code>spring-cloud-starter-oauth2</code>包含了 <code>spring-cloud-starter-security</code>，所以不用再单独引入了。之所以引入 redis 包，是因为下面会介绍一种用 redis 存储 token 的方式。</p><p><em>2、配置好 application.yml</em></p><p>将项目基本配置设置好，并加入有关 redis 的配置，稍后会用到。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>application</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>auth-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>database</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>32768</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>1qaz@WSX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>jedis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pool</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-active</span><span class=p>:</span><span class=w> </span><span class=m>8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-idle</span><span class=p>:</span><span class=w> </span><span class=m>8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>min-idle</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>100ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6001</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>management</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>endpoint</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>health</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p><em>3、spring security 基础配置</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@EnableWebSecurity</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>WebSecurityConfig</span> <span class=kd>extends</span> <span class=n>WebSecurityConfigurerAdapter</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>PasswordEncoder</span> <span class=nf>passwordEncoder</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>BCryptPasswordEncoder</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>AuthenticationManager</span> <span class=nf>authenticationManagerBean</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kd>super</span><span class=o>.</span><span class=na>authenticationManagerBean</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 允许匿名访问所有接口 主要是 oauth 接口
</span></span></span><span class=line><span class=cl><span class=cm>     * @param http
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws Exception
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>HttpSecurity</span> <span class=n>http</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>http</span><span class=o>.</span><span class=na>authorizeRequests</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>antMatchers</span><span class=o>(</span><span class=s>&#34;/**&#34;</span><span class=o>).</span><span class=na>permitAll</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>使用<code>@EnableWebSecurity</code>注解修饰，并继承自<code>WebSecurityConfigurerAdapter</code>类。</p><p>这个类的重点就是声明 <code>PasswordEncoder</code> 和 <code>AuthenticationManager</code>两个 Bean。稍后会用到。其中 <code>BCryptPasswordEncoder</code>是一个密码加密工具类，它可以实现不可逆的加密，<code>AuthenticationManager</code>是为了实现 OAuth2 的 password 模式必须要指定的授权管理 Bean。</p><p><em>4、实现 UserDetailsService</em></p><p>如果你之前用过 Security 的话，那肯定对这个类很熟悉，它是实现用户身份验证的一种方式，也是最简单方便的一种。另外还有结合 <code>AuthenticationProvider</code>的方式，有机会讲 Security 的时候再展开来讲吧。</p><p><code>UserDetailsService</code>的核心就是 <code>loadUserByUsername</code>方法，它要接收一个字符串参数，也就是传过来的用户名，返回一个 <code>UserDetails</code>对象。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@Component</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;kiteUserDetailsService&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>KiteUserDetailsService</span> <span class=kd>implements</span> <span class=n>UserDetailsService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>PasswordEncoder</span> <span class=n>passwordEncoder</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>UserDetails</span> <span class=nf>loadUserByUsername</span><span class=o>(</span><span class=n>String</span> <span class=n>username</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>UsernameNotFoundException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;usernameis:&#34;</span> <span class=o>+</span> <span class=n>username</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 查询数据库操作
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span><span class=o>(!</span><span class=n>username</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;admin&#34;</span><span class=o>)){</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>UsernameNotFoundException</span><span class=o>(</span><span class=s>&#34;the user is not found&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span><span class=k>else</span><span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 用户角色也应在数据库中获取
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>String</span> <span class=n>role</span> <span class=o>=</span> <span class=s>&#34;ROLE_ADMIN&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>List</span><span class=o>&lt;</span><span class=n>SimpleGrantedAuthority</span><span class=o>&gt;</span> <span class=n>authorities</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>            <span class=n>authorities</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>SimpleGrantedAuthority</span><span class=o>(</span><span class=n>role</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 线上环境应该通过用户名查询数据库获取加密后的密码
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>String</span> <span class=n>password</span> <span class=o>=</span> <span class=n>passwordEncoder</span><span class=o>.</span><span class=na>encode</span><span class=o>(</span><span class=s>&#34;123456&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=n>org</span><span class=o>.</span><span class=na>springframework</span><span class=o>.</span><span class=na>security</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>userdetails</span><span class=o>.</span><span class=na>User</span><span class=o>(</span><span class=n>username</span><span class=o>,</span><span class=n>password</span><span class=o>,</span> <span class=n>authorities</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>这里为了做演示，把用户名、密码和所属角色都写在代码里了，正式环境中，这里应该是从数据库或者其他地方根据用户名将加密后的密码及所属角色查出来的。账号 admin ，密码 123456，稍后在换取 token 的时候会用到。并且给这个用户设置 &ldquo;ROLE_ADMIN&rdquo; 角色。</p><p><em>5、OAuth2 配置文件</em></p><p>创建一个配置文件继承自 <code>AuthorizationServerConfigurerAdapter</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=nd>@EnableAuthorizationServer</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>OAuth2Config</span> <span class=kd>extends</span> <span class=n>AuthorizationServerConfigurerAdapter</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>PasswordEncoder</span> <span class=n>passwordEncoder</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>UserDetailsService</span> <span class=n>kiteUserDetailsService</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>AuthenticationManager</span> <span class=n>authenticationManager</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>TokenStore</span> <span class=n>redisTokenStore</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=kd>final</span> <span class=n>AuthorizationServerEndpointsConfigurer</span> <span class=n>endpoints</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * redis token 方式
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=n>endpoints</span><span class=o>.</span><span class=na>authenticationManager</span><span class=o>(</span><span class=n>authenticationManager</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>userDetailsService</span><span class=o>(</span><span class=n>kiteUserDetailsService</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>tokenStore</span><span class=o>(</span><span class=n>redisTokenStore</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>ClientDetailsServiceConfigurer</span> <span class=n>clients</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>clients</span><span class=o>.</span><span class=na>inMemory</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>withClient</span><span class=o>(</span><span class=s>&#34;order-client&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>secret</span><span class=o>(</span><span class=n>passwordEncoder</span><span class=o>.</span><span class=na>encode</span><span class=o>(</span><span class=s>&#34;order-secret-8888&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>authorizedGrantTypes</span><span class=o>(</span><span class=s>&#34;refresh_token&#34;</span><span class=o>,</span> <span class=s>&#34;authorization_code&#34;</span><span class=o>,</span> <span class=s>&#34;password&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>accessTokenValiditySeconds</span><span class=o>(</span><span class=n>3600</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>scopes</span><span class=o>(</span><span class=s>&#34;all&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>and</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>withClient</span><span class=o>(</span><span class=s>&#34;user-client&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>secret</span><span class=o>(</span><span class=n>passwordEncoder</span><span class=o>.</span><span class=na>encode</span><span class=o>(</span><span class=s>&#34;user-secret-8888&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>authorizedGrantTypes</span><span class=o>(</span><span class=s>&#34;refresh_token&#34;</span><span class=o>,</span> <span class=s>&#34;authorization_code&#34;</span><span class=o>,</span> <span class=s>&#34;password&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>accessTokenValiditySeconds</span><span class=o>(</span><span class=n>3600</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>scopes</span><span class=o>(</span><span class=s>&#34;all&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>AuthorizationServerSecurityConfigurer</span> <span class=n>security</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>security</span><span class=o>.</span><span class=na>allowFormAuthenticationForClients</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>security</span><span class=o>.</span><span class=na>checkTokenAccess</span><span class=o>(</span><span class=s>&#34;isAuthenticated()&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>security</span><span class=o>.</span><span class=na>tokenKeyAccess</span><span class=o>(</span><span class=s>&#34;isAuthenticated()&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>有三个 configure 方法的重写。</p><p><code>AuthorizationServerEndpointsConfigurer</code>参数的重写</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>endpoints</span><span class=o>.</span><span class=na>authenticationManager</span><span class=o>(</span><span class=n>authenticationManager</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>userDetailsService</span><span class=o>(</span><span class=n>kiteUserDetailsService</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>tokenStore</span><span class=o>(</span><span class=n>redisTokenStore</span><span class=o>);</span>
</span></span></code></pre></div><p><code>authenticationManage()</code> 调用此方法才能支持 password 模式。</p><p><code>userDetailsService()</code> 设置用户验证服务。</p><p><code>tokenStore()</code> 指定 token 的存储方式。</p><p>redisTokenStore Bean 的定义如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RedisTokenStoreConfig</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>RedisConnectionFactory</span> <span class=n>redisConnectionFactory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>TokenStore</span> <span class=nf>redisTokenStore</span> <span class=o>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>RedisTokenStore</span><span class=o>(</span><span class=n>redisConnectionFactory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p><code>ClientDetailsServiceConfigurer</code>参数的重写，在这里定义各个端的约束条件。包括</p><p>ClientId、Client-Secret：这两个参数对应请求端定义的 cleint-id 和 client-secret</p><p>authorizedGrantTypes 可以包括如下几种设置中的一种或多种：</p><ul><li>authorization_code：授权码类型。</li><li>implicit：隐式授权类型。</li><li>password：资源所有者（即用户）密码类型。</li><li>client_credentials：客户端凭据（客户端ID以及Key）类型。</li><li>refresh_token：通过以上授权获得的刷新令牌来获取新的令牌。</li></ul><p>accessTokenValiditySeconds：token 的有效期</p><p>scopes：用来限制客户端访问的权限，在换取的 token 的时候会带上 scope 参数，只有在 scopes 定义内的，才可以正常换取 token。</p><p>上面代码中是使用 inMemory 方式存储的，将配置保存到内存中，相当于硬编码了。正式环境下的做法是持久化到数据库中，比如 mysql 中。</p><p>具体的做法如下：</p><ol><li>在数据库中增加表，并插入数据</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=nf>oauth_client_details</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>client_id</span><span class=w> </span><span class=kt>VARCHAR</span><span class=p>(</span><span class=mi>256</span><span class=p>)</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>resource_ids</span><span class=w> </span><span class=kt>VARCHAR</span><span class=p>(</span><span class=mi>256</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>client_secret</span><span class=w> </span><span class=kt>VARCHAR</span><span class=p>(</span><span class=mi>256</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>scope</span><span class=w> </span><span class=kt>VARCHAR</span><span class=p>(</span><span class=mi>256</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>authorized_grant_types</span><span class=w> </span><span class=kt>VARCHAR</span><span class=p>(</span><span class=mi>256</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>web_server_redirect_uri</span><span class=w> </span><span class=kt>VARCHAR</span><span class=p>(</span><span class=mi>256</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>authorities</span><span class=w> </span><span class=kt>VARCHAR</span><span class=p>(</span><span class=mi>256</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>access_token_validity</span><span class=w> </span><span class=kt>INTEGER</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>refresh_token_validity</span><span class=w> </span><span class=kt>INTEGER</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>additional_information</span><span class=w> </span><span class=kt>VARCHAR</span><span class=p>(</span><span class=mi>4096</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>autoapprove</span><span class=w> </span><span class=kt>VARCHAR</span><span class=p>(</span><span class=mi>256</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=nf>oauth_client_details</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>client_id</span><span class=p>,</span><span class=w> </span><span class=n>client_secret</span><span class=p>,</span><span class=w> </span><span class=n>scope</span><span class=p>,</span><span class=w> </span><span class=n>authorized_grant_types</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>web_server_redirect_uri</span><span class=p>,</span><span class=w> </span><span class=n>authorities</span><span class=p>,</span><span class=w> </span><span class=n>access_token_validity</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>refresh_token_validity</span><span class=p>,</span><span class=w> </span><span class=n>additional_information</span><span class=p>,</span><span class=w> </span><span class=n>autoapprove</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>VALUES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;user-client&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;$2a$10$o2l5kA7z.Caekp72h5kU7uqdTDrlamLq.57M1F6ulJln9tRtOJufq&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;all&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;authorization_code,refresh_token,password&#39;</span><span class=p>,</span><span class=w> </span><span class=no>null</span><span class=p>,</span><span class=w> </span><span class=no>null</span><span class=p>,</span><span class=w> </span><span class=mi>3600</span><span class=p>,</span><span class=w> </span><span class=mi>36000</span><span class=p>,</span><span class=w> </span><span class=no>null</span><span class=p>,</span><span class=w> </span><span class=no>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=nf>oauth_client_details</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>client_id</span><span class=p>,</span><span class=w> </span><span class=n>client_secret</span><span class=p>,</span><span class=w> </span><span class=n>scope</span><span class=p>,</span><span class=w> </span><span class=n>authorized_grant_types</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>web_server_redirect_uri</span><span class=p>,</span><span class=w> </span><span class=n>authorities</span><span class=p>,</span><span class=w> </span><span class=n>access_token_validity</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>refresh_token_validity</span><span class=p>,</span><span class=w> </span><span class=n>additional_information</span><span class=p>,</span><span class=w> </span><span class=n>autoapprove</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>VALUES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;order-client&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;$2a$10$GoIOhjqFKVyrabUNcie8d.ADX.qZSxpYbO6YK4L2gsNzlCIxEUDlW&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;all&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;authorization_code,refresh_token,password&#39;</span><span class=p>,</span><span class=w> </span><span class=no>null</span><span class=p>,</span><span class=w> </span><span class=no>null</span><span class=p>,</span><span class=w> </span><span class=mi>3600</span><span class=p>,</span><span class=w> </span><span class=mi>36000</span><span class=p>,</span><span class=w> </span><span class=no>null</span><span class=p>,</span><span class=w> </span><span class=no>true</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p><em>注意：</em> client_secret 字段不能直接是 secret 的原始值，需要经过加密。因为是用的 <code>BCryptPasswordEncoder</code>，所以最终插入的值应该是经过 <code>BCryptPasswordEncoder.encode()</code>之后的值。</p><ol start=2><li>然后在配置文件 application.yml 中添加关于数据库的配置</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://localhost:3306/spring_cloud?characterEncoding=UTF-8&amp;useSSL=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hikari</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>connection-timeout</span><span class=p>:</span><span class=w> </span><span class=m>30000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>idle-timeout</span><span class=p>:</span><span class=w> </span><span class=m>600000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>max-lifetime</span><span class=p>:</span><span class=w> </span><span class=m>1800000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>maximum-pool-size</span><span class=p>:</span><span class=w> </span><span class=m>9</span><span class=w>   
</span></span></span></code></pre></div><p>Spring Boot 2.0 之后默认使用 hikari 作为数据库连接池。如果使用其他连接池需要引入相关包，然后对应的增加配置。</p><ol start=3><li>在 OAuth2 配置类(OAuth2Config)中增加 DataSource 的注入</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=o>;</span>
</span></span></code></pre></div><ol start=4><li>将 <code>public void configure(ClientDetailsServiceConfigurer clients)</code>重写方法修改为如下：</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>ClientDetailsServiceConfigurer</span> <span class=n>clients</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=n>JdbcClientDetailsServiceBuilder</span> <span class=n>jcsb</span> <span class=o>=</span> <span class=n>clients</span><span class=o>.</span><span class=na>jdbc</span><span class=o>(</span><span class=n>dataSource</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=n>jcsb</span><span class=o>.</span><span class=na>passwordEncoder</span><span class=o>(</span><span class=n>passwordEncoder</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>还有一个重写的方法 <code>public void configure(AuthorizationServerSecurityConfigurer security)</code>，这个方法限制客户端访问认证接口的权限。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>security</span><span class=o>.</span><span class=na>allowFormAuthenticationForClients</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>security</span><span class=o>.</span><span class=na>checkTokenAccess</span><span class=o>(</span><span class=s>&#34;isAuthenticated()&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>security</span><span class=o>.</span><span class=na>tokenKeyAccess</span><span class=o>(</span><span class=s>&#34;isAuthenticated()&#34;</span><span class=o>);</span>
</span></span></code></pre></div><p>第一行代码是允许客户端访问 OAuth2 授权接口，否则请求 token 会返回 401。</p><p>第二行和第三行分别是允许已授权用户访问 checkToken 接口和获取 token 接口。</p><p>完成之后，启动项目，如果你用的是 IDEA 会在下方的 Mapping 窗口中看到 oauth2 相关的 RESTful 接口。
<img src=https://hexo.moonkite.cn/blog/273364-20191023100737268-1008858850.png alt></p><p>主要有如下几个：</p><pre tabindex=0><code>POST /oauth/authorize  授权码模式认证授权接口
GET/POST /oauth/token  获取 token 的接口
POST  /oauth/check_token  检查 token 合法性接口
</code></pre><h5 id=创建用户客户端项目>创建用户客户端项目</h5><p>上面创建完成了认证服务端，下面开始创建一个客户端，对应到我们系统中的业务相关的微服务。我们假设这个微服务项目是管理用户相关数据的，所以叫做用户客户端。</p><p><em>1、引用相关的 maven 包</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-web<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p><em>2、application.yml 配置文件</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>application</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>client-user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>database</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>32768</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>1qaz@WSX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>jedis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pool</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-active</span><span class=p>:</span><span class=w> </span><span class=m>8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-idle</span><span class=p>:</span><span class=w> </span><span class=m>8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>min-idle</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>100ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6101</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>servlet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>context-path</span><span class=p>:</span><span class=w> </span><span class=l>/client-user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>security</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>oauth2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>client</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>client-id</span><span class=p>:</span><span class=w> </span><span class=l>user-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>client-secret</span><span class=p>:</span><span class=w> </span><span class=l>user-secret-8888</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>user-authorization-uri</span><span class=p>:</span><span class=w> </span><span class=l>http://localhost:6001/oauth/authorize</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>access-token-uri</span><span class=p>:</span><span class=w> </span><span class=l>http://localhost:6001/oauth/token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>user-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>user-info-uri</span><span class=p>:</span><span class=w> </span><span class=l>user-info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>authorization</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>check-token-access</span><span class=p>:</span><span class=w> </span><span class=l>http://localhost:6001/oauth/check_token</span><span class=w>
</span></span></span></code></pre></div><p>上面是常规配置信息以及 redis 配置，重点是下面的 security 的配置，这里的配置稍有不注意就会出现 401 或者其他问题。</p><p>client-id、client-secret 要和认证服务中的配置一致，如果是使用 inMemory 还是 jdbc 方式。</p><p>user-authorization-uri 是授权码认证方式需要的，下一篇文章再说。</p><p>access-token-uri 是密码模式需要用到的获取 token 的接口。</p><p>authorization.check-token-access 也是关键信息，当此服务端接收到来自客户端端的请求后，需要拿着请求中的 token 到认证服务端做 token 验证，就是请求的这个接口</p><p><em>3、资源配置文件</em></p><p>在 OAuth2 的概念里，所有的接口都被称为资源，接口的权限也就是资源的权限，所以 Spring Security OAuth2 中提供了关于资源的注解 <code>@EnableResourceServer</code>，和 <code>@EnableWebSecurity</code>的作用类似。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=nd>@EnableResourceServer</span>
</span></span><span class=line><span class=cl><span class=nd>@EnableGlobalMethodSecurity</span><span class=o>(</span><span class=n>prePostEnabled</span> <span class=o>=</span> <span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ResourceServerConfig</span> <span class=kd>extends</span> <span class=n>ResourceServerConfigurerAdapter</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Value</span><span class=o>(</span><span class=s>&#34;${security.oauth2.client.client-id}&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>clientId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Value</span><span class=o>(</span><span class=s>&#34;${security.oauth2.client.client-secret}&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>secret</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Value</span><span class=o>(</span><span class=s>&#34;${security.oauth2.authorization.check-token-access}&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>checkTokenEndpointUrl</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>RedisConnectionFactory</span> <span class=n>redisConnectionFactory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>TokenStore</span> <span class=nf>redisTokenStore</span> <span class=o>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>RedisTokenStore</span><span class=o>(</span><span class=n>redisConnectionFactory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>RemoteTokenServices</span> <span class=nf>tokenService</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>RemoteTokenServices</span> <span class=n>tokenService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RemoteTokenServices</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>tokenService</span><span class=o>.</span><span class=na>setClientId</span><span class=o>(</span><span class=n>clientId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>tokenService</span><span class=o>.</span><span class=na>setClientSecret</span><span class=o>(</span><span class=n>secret</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>tokenService</span><span class=o>.</span><span class=na>setCheckTokenEndpointUrl</span><span class=o>(</span><span class=n>checkTokenEndpointUrl</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>tokenService</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>ResourceServerSecurityConfigurer</span> <span class=n>resources</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>resources</span><span class=o>.</span><span class=na>tokenServices</span><span class=o>(</span><span class=n>tokenService</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>因为使用的是 redis 作为 token 的存储，所以需要特殊配置一下叫做 tokenService 的 Bean，通过这个 Bean 才能实现 token 的验证。</p><p><em>4、最后，添加一个 RESTful 接口</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@RestController</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>UserController</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@GetMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;get&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>//@PreAuthorize(&#34;hasAuthority(&#39;ROLE_ADMIN&#39;)&#34;)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@PreAuthorize</span><span class=o>(</span><span class=s>&#34;hasAnyRole(&#39;ROLE_ADMIN&#39;)&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Object</span> <span class=nf>get</span><span class=o>(</span><span class=n>Authentication</span> <span class=n>authentication</span><span class=o>){</span>
</span></span><span class=line><span class=cl>        <span class=c1>//Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>authentication</span><span class=o>.</span><span class=na>getCredentials</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>OAuth2AuthenticationDetails</span> <span class=n>details</span> <span class=o>=</span> <span class=o>(</span><span class=n>OAuth2AuthenticationDetails</span><span class=o>)</span><span class=n>authentication</span><span class=o>.</span><span class=na>getDetails</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>token</span> <span class=o>=</span> <span class=n>details</span><span class=o>.</span><span class=na>getTokenValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>token</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>一个 RESTful 方法，只有当访问用户具有 ROLE_ADMIN 权限时才能访问，否则返回 401 未授权。</p><p>通过 Authentication 参数或者 <code>SecurityContextHolder.getContext().getAuthentication()</code> 可以拿到授权信息进行查看。</p><h5 id=测试认证功能>测试认证功能</h5><p><em>1、启动认证服务端，启动端口为 6001</em></p><p><em>2、启动用户服务客户端，启动端口为6101</em></p><p><em>3、请求认证服务端获取 token</em></p><p>我是用 REST Client 来做访问请求的，请求格式如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>POST</span> <span class=s>http://localhost:6001/oauth/token?grant_type=password&amp;username=admin&amp;password=123456&amp;scope=all</span>
</span></span><span class=line><span class=cl><span class=na>Accept</span><span class=o>:</span> <span class=s>*/*</span>
</span></span><span class=line><span class=cl><span class=na>Cache-Control</span><span class=o>:</span> <span class=s>no-cache</span>
</span></span><span class=line><span class=cl><span class=na>Authorization</span><span class=o>:</span> <span class=s>Basic dXNlci1jbGllbnQ6dXNlci1zZWNyZXQtODg4OA==</span>
</span></span></code></pre></div><p>假设咱们在一个 web 端使用，grant_type 是 password，表明这是使用 OAuth2 的密码模式。</p><p>username=admin 和 password=123456 就相当于在 web 端登录界面输入的用户名和密码，我们在认证服务端配置中固定了用户名是 admin 、密码是 123456，而线上环境中则应该通过查询数据库获取。</p><p>scope=all 是权限有关的，在认证服务的 OAuthConfig 中指定了 scope 为 all 。</p><p>Authorization 要加在请求头中，格式为 Basic 空格 base64(clientId:clientSecret)，这个微服务客户端的 client-id 是 user-client，client-secret 是 user-secret-8888，将这两个值通过冒号连接，并使用 base64 编码(user-client:user-secret-8888)之后的值为 dXNlci1jbGllbnQ6dXNlci1zZWNyZXQtODg4OA==，可以通过 <a href=https://www.sojson.com/base64.html>https://www.sojson.com/base64.html</a> 在线编码获取。</p><p><img src=https://hexo.moonkite.cn/blog/273364-20191023100753748-945717226.png alt></p><p>运行请求后，如果参数都正确的话，获取到的返回内容如下，是一段 json 格式</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;access_token&#34;</span><span class=p>:</span> <span class=s2>&#34;9f958300-5005-46ea-9061-323c9e6c7a4d&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;token_type&#34;</span><span class=p>:</span> <span class=s2>&#34;bearer&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;refresh_token&#34;</span><span class=p>:</span> <span class=s2>&#34;0f5871f5-98f1-405e-848e-80f641bab72e&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;expires_in&#34;</span><span class=p>:</span> <span class=mi>3599</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scope&#34;</span><span class=p>:</span> <span class=s2>&#34;all&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>access_token :  就是之后请求需要带上的 token，也是本次请求的主要目的
token_type：为 bearer，这是 access token 最常用的一种形式
refresh_token：之后可以用这个值来换取新的 token，而不用输入账号密码
expires_in：token 的过期时间(秒)</p><p><em>4、用获取到的 token 请求资源接口</em></p><p>我们在用户客户端中定义了一个接口 http://localhost:6101/client-user/get，现在就拿着上一步获取的 token 来请求这个接口。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>GET</span> <span class=s>http://localhost:6101/client-user/get</span>
</span></span><span class=line><span class=cl><span class=na>Accept</span><span class=o>:</span> <span class=s>*/*</span>
</span></span><span class=line><span class=cl><span class=na>Cache-Control</span><span class=o>:</span> <span class=s>no-cache</span>
</span></span><span class=line><span class=cl><span class=na>Authorization</span><span class=o>:</span> <span class=s>bearer ce334918-e666-455a-8ecd-8bd680415d84</span>
</span></span></code></pre></div><p>同样需要请求头 Authorization，格式为 bearer + 空格 + token，正常情况下根据接口的逻辑，会把 token 原样返回。</p><p><em>5、token 过期后，用 refresh_token 换取 access_token</em></p><p>一般都会设置 access_token 的过期时间小于 refresh_token 的过期时间，以便在 access_token 过期后，不用用户再次登录的情况下，获取新的 access_token。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=c1>### 换取 access_token</span>
</span></span><span class=line><span class=cl><span class=na>POST</span> <span class=s>http://localhost:6001/oauth/token?grant_type=refresh_token&amp;refresh_token=706dac10-d48e-4795-8379-efe8307a2282</span>
</span></span><span class=line><span class=cl><span class=na>Accept</span><span class=o>:</span> <span class=s>*/*</span>
</span></span><span class=line><span class=cl><span class=na>Cache-Control</span><span class=o>:</span> <span class=s>no-cache</span>
</span></span><span class=line><span class=cl><span class=na>Authorization</span><span class=o>:</span> <span class=s>Basic dXNlci1jbGllbnQ6dXNlci1zZWNyZXQtODg4OA==</span>
</span></span></code></pre></div><p>grant_type 设置为 refresh_token。</p><p>refresh_token 设置为请求 token 时返回的 refresh_token 的值。</p><p>请求头加入 Authorization，格式依然是 Basic + 空格 + base64(client-id:client-secret)</p><p>请求成功后会返回和请求 token 同样的数据格式。</p><h5 id=用-jwt-替换-redistoken>用 JWT 替换 redisToken</h5><p>上面 token 的存储用的是 redis 的方案，Spring Security OAuth2 还提供了 jdbc 和 jwt 的支持，jdbc 的暂不考虑，现在来介绍用 JWT 的方式来实现 token 的存储。</p><p>用 JWT 的方式就不用把 token 再存储到服务端了，JWT 有自己特殊的加密方式，可以有效的防止数据被篡改，只要不把用户密码等关键信息放到 JWT 里就可以保证安全性。</p><p><em>认证服务端改造</em></p><p>先把有关 redis 的配置去掉。</p><h6 id=添加-jwtconfig-配置类>添加 JwtConfig 配置类</h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>JwtTokenConfig</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>TokenStore</span> <span class=nf>jwtTokenStore</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>JwtTokenStore</span><span class=o>(</span><span class=n>jwtAccessTokenConverter</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>JwtAccessTokenConverter</span> <span class=nf>jwtAccessTokenConverter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>JwtAccessTokenConverter</span> <span class=n>accessTokenConverter</span> <span class=o>=</span> <span class=k>new</span> <span class=n>JwtAccessTokenConverter</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>accessTokenConverter</span><span class=o>.</span><span class=na>setSigningKey</span><span class=o>(</span><span class=s>&#34;dev&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>accessTokenConverter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p><code>JwtAccessTokenConverter</code>是为了做 JWT 数据转换，这样做是因为 JWT 有自身独特的数据格式。如果没有了解过 JWT ，可以搜索一下先了解一下。</p><h6 id=更改-oauthconfig-配置类>更改 OAuthConfig 配置类</h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>TokenStore</span> <span class=n>jwtTokenStore</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>JwtAccessTokenConverter</span> <span class=n>jwtAccessTokenConverter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=kd>final</span> <span class=n>AuthorizationServerEndpointsConfigurer</span> <span class=n>endpoints</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 普通 jwt 模式
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>         <span class=n>endpoints</span><span class=o>.</span><span class=na>tokenStore</span><span class=o>(</span><span class=n>jwtTokenStore</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>accessTokenConverter</span><span class=o>(</span><span class=n>jwtAccessTokenConverter</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>userDetailsService</span><span class=o>(</span><span class=n>kiteUserDetailsService</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>                 * 支持 password 模式
</span></span></span><span class=line><span class=cl><span class=cm>                 */</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>authenticationManager</span><span class=o>(</span><span class=n>authenticationManager</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>注入 JWT 相关的 Bean，然后修改 <code>configure(final AuthorizationServerEndpointsConfigurer endpoints)</code> 方法为 JWT 存储模式。</p><p><em>改造用户客户端</em></p><h6 id=修改-applicationyml-配置文件>修改 application.yml 配置文件</h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>security</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>oauth2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>client</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>client-id</span><span class=p>:</span><span class=w> </span><span class=l>user-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>client-secret</span><span class=p>:</span><span class=w> </span><span class=l>user-secret-8888</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>user-authorization-uri</span><span class=p>:</span><span class=w> </span><span class=l>http://localhost:6001/oauth/authorize</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>access-token-uri</span><span class=p>:</span><span class=w> </span><span class=l>http://localhost:6001/oauth/token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>jwt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key-uri</span><span class=p>:</span><span class=w> </span><span class=l>http://localhost:6001/oauth/token_key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key-value</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span></span></span></code></pre></div><p>注意认证服务端 <code>JwtAccessTokenConverter</code>设置的 SigningKey 要和配置文件中的 key-value 相同，不然会导致无法正常解码 JWT ，导致验证不通过。</p><h6 id=resourceserverconfig-类的配置>ResourceServerConfig 类的配置</h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=nd>@EnableResourceServer</span>
</span></span><span class=line><span class=cl><span class=nd>@EnableGlobalMethodSecurity</span><span class=o>(</span><span class=n>prePostEnabled</span> <span class=o>=</span> <span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ResourceServerConfig</span> <span class=kd>extends</span> <span class=n>ResourceServerConfigurerAdapter</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>TokenStore</span> <span class=nf>jwtTokenStore</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>JwtTokenStore</span><span class=o>(</span><span class=n>jwtAccessTokenConverter</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>JwtAccessTokenConverter</span> <span class=nf>jwtAccessTokenConverter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>JwtAccessTokenConverter</span> <span class=n>accessTokenConverter</span> <span class=o>=</span> <span class=k>new</span> <span class=n>JwtAccessTokenConverter</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>accessTokenConverter</span><span class=o>.</span><span class=na>setSigningKey</span><span class=o>(</span><span class=s>&#34;dev&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>accessTokenConverter</span><span class=o>.</span><span class=na>setVerifierKey</span><span class=o>(</span><span class=s>&#34;dev&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>accessTokenConverter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>TokenStore</span> <span class=n>jwtTokenStore</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>ResourceServerSecurityConfigurer</span> <span class=n>resources</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>resources</span><span class=o>.</span><span class=na>tokenStore</span><span class=o>(</span><span class=n>jwtTokenStore</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h6 id=运行请求-token-接口的请求>运行请求 token 接口的请求</h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>POST</span> <span class=s>http://localhost:6001/oauth/token?grant_type=password&amp;username=admin&amp;password=123456&amp;scope=all</span>
</span></span><span class=line><span class=cl><span class=na>Accept</span><span class=o>:</span> <span class=s>*/*</span>
</span></span><span class=line><span class=cl><span class=na>Cache-Control</span><span class=o>:</span> <span class=s>no-cache</span>
</span></span><span class=line><span class=cl><span class=na>Authorization</span><span class=o>:</span> <span class=s>Basic dXNlci1jbGllbnQ6dXNlci1zZWNyZXQtODg4OA==</span>
</span></span></code></pre></div><p>返回结果如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;access_token&#34;</span><span class=p>:</span> <span class=s2>&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1NzE3NDM0OTQsInVzZXJfbmFtZSI6ImFkbWluIiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9BRE1JTiJdLCJqdGkiOiI4Y2NhMjlhZi1lYTc3LTRmZTYtOWZlMS0zMjc0MTVkY2QyMWQiLCJjbGllbnRfaWQiOiJ1c2VyLWNsaWVudCIsInNjb3BlIjpbImFsbCJdfQ.0Ik3UwB1xjX2le5luEdtVAI_MEyu_OloRRYtPOvtvwM&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;token_type&#34;</span><span class=p>:</span> <span class=s2>&#34;bearer&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;refresh_token&#34;</span><span class=p>:</span> <span class=s2>&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsInNjb3BlIjpbImFsbCJdLCJhdGkiOiI4Y2NhMjlhZi1lYTc3LTRmZTYtOWZlMS0zMjc0MTVkY2QyMWQiLCJleHAiOjE1NzE3NzU4OTQsImF1dGhvcml0aWVzIjpbIlJPTEVfQURNSU4iXSwianRpIjoiZjdkMjg4NDUtMmU2ZC00ZmRjLTg1OGYtMWNiY2RlNzI1ZmMyIiwiY2xpZW50X2lkIjoidXNlci1jbGllbnQifQ.vk_msYtbrAr93h5sK4wy6EC2_wRD_cD_UBS8O6eRziw&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;expires_in&#34;</span><span class=p>:</span> <span class=mi>3599</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scope&#34;</span><span class=p>:</span> <span class=s2>&#34;all&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jti&#34;</span><span class=p>:</span> <span class=s2>&#34;8cca29af-ea77-4fe6-9fe1-327415dcd21d&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>我们已经看到返回的 token 是 JWT 格式了，到 JWT 在线解码网站 <a href=https://jwt.io/>https://jwt.io/</a> 或者 <a href=http://jwt.calebb.net/>http://jwt.calebb.net/</a>将 token 解码看一下</p><p><img src=https://hexo.moonkite.cn/blog/273364-20191023100809148-1936501614.png alt></p><p>看到了没，user_name、client_id 等信息都在其中。</p><h6 id=拿着返回的-token-请求用户客户端接口>拿着返回的 token 请求用户客户端接口</h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>GET</span> <span class=s>http://localhost:6101/client-user/get</span>
</span></span><span class=line><span class=cl><span class=na>Accept</span><span class=o>:</span> <span class=s>*/*</span>
</span></span><span class=line><span class=cl><span class=na>Cache-Control</span><span class=o>:</span> <span class=s>no-cache</span>
</span></span><span class=line><span class=cl><span class=na>Authorization</span><span class=o>:</span> <span class=s>bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1NzE3NDM0OTQsInVzZXJfbmFtZSI6ImFkbWluIiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9BRE1JTiJdLCJqdGkiOiI4Y2NhMjlhZi1lYTc3LTRmZTYtOWZlMS0zMjc0MTVkY2QyMWQiLCJjbGllbnRfaWQiOiJ1c2VyLWNsaWVudCIsInNjb3BlIjpbImFsbCJdfQ.0Ik3UwB1xjX2le5luEdtVAI_MEyu_OloRRYtPOvtvwM</span>
</span></span></code></pre></div><p><em>增强 JWT</em></p><p>如果我想在 JWT 中加入额外的字段(比方说用户的其他信息)怎么办呢，当然可以。spring security oauth2 提供了 <code>TokenEnhancer</code> 增强器。其实不光 JWT ，RedisToken 的方式同样可以。</p><h6 id=声明一个增强器>声明一个增强器</h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>JWTokenEnhancer</span> <span class=kd>implements</span> <span class=n>TokenEnhancer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>OAuth2AccessToken</span> <span class=nf>enhance</span><span class=o>(</span><span class=n>OAuth2AccessToken</span> <span class=n>oAuth2AccessToken</span><span class=o>,</span> <span class=n>OAuth2Authentication</span> <span class=n>oAuth2Authentication</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>info</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=n>info</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;jwt-ext&#34;</span><span class=o>,</span> <span class=s>&#34;JWT 扩展信息&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>((</span><span class=n>DefaultOAuth2AccessToken</span><span class=o>)</span> <span class=n>oAuth2AccessToken</span><span class=o>).</span><span class=na>setAdditionalInformation</span><span class=o>(</span><span class=n>info</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>oAuth2AccessToken</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>通过 oAuth2Authentication 可以拿到用户名等信息，通过这些我们可以在这里查询数据库或者缓存获取更多的信息，而这些信息都可以作为 JWT 扩展信息加入其中。</p><h6 id=oauthconfig-配置类修改>OAuthConfig 配置类修改</h6><p>注入增强器</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>TokenEnhancer</span> <span class=n>jwtTokenEnhancer</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Bean</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>TokenEnhancer</span> <span class=nf>jwtTokenEnhancer</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>JWTokenEnhancer</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>修改 <code>configure(final AuthorizationServerEndpointsConfigurer endpoints) </code>方法</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span> <span class=kd>final</span> <span class=n>AuthorizationServerEndpointsConfigurer</span> <span class=n>endpoints</span> <span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * jwt 增强模式
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=n>TokenEnhancerChain</span>	<span class=n>enhancerChain</span>	<span class=o>=</span> <span class=k>new</span> <span class=n>TokenEnhancerChain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>	<span class=n>List</span><span class=o>&lt;</span><span class=n>TokenEnhancer</span><span class=o>&gt;</span>	<span class=n>enhancerList</span>	<span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>	<span class=n>enhancerList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span> <span class=n>jwtTokenEnhancer</span> <span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=n>enhancerList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span> <span class=n>jwtAccessTokenConverter</span> <span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=n>enhancerChain</span><span class=o>.</span><span class=na>setTokenEnhancers</span><span class=o>(</span> <span class=n>enhancerList</span> <span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=n>endpoints</span><span class=o>.</span><span class=na>tokenStore</span><span class=o>(</span> <span class=n>jwtTokenStore</span> <span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=na>userDetailsService</span><span class=o>(</span> <span class=n>kiteUserDetailsService</span> <span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * 支持 password 模式
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=na>authenticationManager</span><span class=o>(</span> <span class=n>authenticationManager</span> <span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=na>tokenEnhancer</span><span class=o>(</span> <span class=n>enhancerChain</span> <span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=na>accessTokenConverter</span><span class=o>(</span> <span class=n>jwtAccessTokenConverter</span> <span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h6 id=再次请求-token-返回内容中多了个刚刚加入的-jwt-ext-字段>再次请求 token ，返回内容中多了个刚刚加入的 jwt-ext 字段</h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;access_token&#34;</span><span class=p>:</span> <span class=s2>&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTU3MTc0NTE3OCwiYXV0aG9yaXRpZXMiOlsiUk9MRV9BRE1JTiJdLCJqdGkiOiJhNDU1MWQ5ZS1iN2VkLTQ3NTktYjJmMS1mMGI5YjIxY2E0MmMiLCJjbGllbnRfaWQiOiJ1c2VyLWNsaWVudCJ9.5j4hNsVpktG2iKxNqR-q1rfcnhlyV3M6HUBx5cd6PiQ&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;token_type&#34;</span><span class=p>:</span> <span class=s2>&#34;bearer&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;refresh_token&#34;</span><span class=p>:</span> <span class=s2>&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYWxsIl0sImF0aSI6ImE0NTUxZDllLWI3ZWQtNDc1OS1iMmYxLWYwYjliMjFjYTQyYyIsImV4cCI6MTU3MTc3NzU3OCwiYXV0aG9yaXRpZXMiOlsiUk9MRV9BRE1JTiJdLCJqdGkiOiJmNTI3ODJlOS0wOGRjLTQ2NGUtYmJhYy03OTMwNzYwYmZiZjciLCJjbGllbnRfaWQiOiJ1c2VyLWNsaWVudCJ9.UQMf140CG8U0eWh08nGlctpIye9iJ7p2i6NYHkGAwhY&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;expires_in&#34;</span><span class=p>:</span> <span class=mi>3599</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scope&#34;</span><span class=p>:</span> <span class=s2>&#34;all&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jwt-ext&#34;</span><span class=p>:</span> <span class=s2>&#34;JWT 扩展信息&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jti&#34;</span><span class=p>:</span> <span class=s2>&#34;a4551d9e-b7ed-4759-b2f1-f0b9b21ca42c&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><em>用户客户端解析 JWT 数据</em></p><p>我们如果在 JWT 中加入了额外信息，这些信息我们可能会用到，而在接收到 JWT 格式的 token 之后，用户客户端要把 JWT 解析出来。</p><h6 id=引入-jwt-包>引入 JWT 包</h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>io.jsonwebtoken<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>jjwt<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>0.9.1<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h6 id=加一个-restful-接口在其中解析-jwt>加一个 RESTful 接口，在其中解析 JWT</h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;jwt&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@PreAuthorize</span><span class=o>(</span><span class=s>&#34;hasAnyRole(&#39;ROLE_ADMIN&#39;)&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Object</span> <span class=nf>jwtParser</span><span class=o>(</span><span class=n>Authentication</span> <span class=n>authentication</span><span class=o>){</span>
</span></span><span class=line><span class=cl>    <span class=n>authentication</span><span class=o>.</span><span class=na>getCredentials</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>OAuth2AuthenticationDetails</span> <span class=n>details</span> <span class=o>=</span> <span class=o>(</span><span class=n>OAuth2AuthenticationDetails</span><span class=o>)</span><span class=n>authentication</span><span class=o>.</span><span class=na>getDetails</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>jwtToken</span> <span class=o>=</span> <span class=n>details</span><span class=o>.</span><span class=na>getTokenValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Claims</span> <span class=n>claims</span> <span class=o>=</span> <span class=n>Jwts</span><span class=o>.</span><span class=na>parser</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>setSigningKey</span><span class=o>(</span><span class=s>&#34;dev&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>(</span><span class=n>StandardCharsets</span><span class=o>.</span><span class=na>UTF_8</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>parseClaimsJws</span><span class=o>(</span><span class=n>jwtToken</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>getBody</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>claims</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>同样注意其中签名的设置要与认证服务端相同。</p><h6 id=用上一步的-token-请求上面的接口>用上一步的 token 请求上面的接口</h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=c1>### 解析 jwt</span>
</span></span><span class=line><span class=cl><span class=na>GET</span> <span class=s>http://localhost:6101/client-user/jwt</span>
</span></span><span class=line><span class=cl><span class=na>Accept</span><span class=o>:</span> <span class=s>*/*</span>
</span></span><span class=line><span class=cl><span class=na>Cache-Control</span><span class=o>:</span> <span class=s>no-cache</span>
</span></span><span class=line><span class=cl><span class=na>Authorization</span><span class=o>:</span> <span class=s>bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTU3MTc0NTE3OCwiYXV0aG9yaXRpZXMiOlsiUk9MRV9BRE1JTiJdLCJqdGkiOiJhNDU1MWQ5ZS1iN2VkLTQ3NTktYjJmMS1mMGI5YjIxY2E0MmMiLCJjbGllbnRfaWQiOiJ1c2VyLWNsaWVudCJ9.5j4hNsVpktG2iKxNqR-q1rfcnhlyV3M6HUBx5cd6PiQ</span>
</span></span></code></pre></div><p>返回内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;user_name&#34;</span><span class=p>:</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jwt-ext&#34;</span><span class=p>:</span> <span class=s2>&#34;JWT 扩展信息&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scope&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;all&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;exp&#34;</span><span class=p>:</span> <span class=mi>1571745178</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;authorities&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ROLE_ADMIN&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jti&#34;</span><span class=p>:</span> <span class=s2>&#34;a4551d9e-b7ed-4759-b2f1-f0b9b21ca42c&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;client_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user-client&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>以上就是 password 模式的完整过程，源码放到了 github 上，有需要的可以去看一下。</p><p><a href=https://github.com/huzhicheng/spring-cloud-study/tree/master/oauth2>源码地址</a></p></article><div class=toc><h2>文章目录</h2><nav id=TableOfContents><ul><li><ul><li><a href=#什么情况下需要用-oauth2>什么情况下需要用 OAuth2</a></li><li><a href=#实现统一认证功能>实现统一认证功能</a></li></ul></li></ul></nav></div><script>window.addEventListener("scroll",function(){var e=document.querySelector(".toc"),t=window.pageYOffset||document.documentElement.scrollTop,n=window.innerWidth||document.documentElement.clientWidth;t<360?e.style.top=380-t+"px":e.style.top="20px"})</script><h4>相关文章</h4><dl class=row><dd class=col-md-9><a href=/category/SpringCloud/9-%E5%BE%AE%E4%BF%A1%E6%8E%88%E6%9D%83%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B8%AA%E5%8E%9F%E7%90%86Spring-Cloud-OAuth2-%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F/>9. 微信授权就是这个原理，Spring Cloud OAuth2 授权码模式</a></dd><dd class=col-md-9><a href=/category/SpringCloud/0-Srping-Cloud-%E5%BC%80%E7%AF%87/>0. Spring Cloud 是什么</a></dd><dd class=col-md-9><a href=/category/SpringCloud/1-Spring-Cloud-Eureka-%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0/>1. Spring Cloud Eureka 实现服务注册与发现</a></dd><dd class=col-md-9><a href=/category/SpringCloud/2-Spring-Cloud-Eureka-%E5%AE%9E%E7%8E%B0%E5%AE%89%E5%85%A8%E6%8E%A7%E5%88%B6/>2. Spring Cloud Eureka 实现安全控制</a></dd><dd class=col-md-9><a href=/category/SpringCloud/3-Spring-Cloud-Eureka-%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/>3. Spring Cloud Eureka 实现高可用服务发现注册中心</a></dd></dl><div class=author-card><div class=underline></div><div class=author-box><div class=qr-author-image><a href=/><img src=/images/person.jpg alt=风筝></a></div><div class=author-content><p class=author-title>作者</p><p class=author-name>风筝</p><p class=author-desc>古时的风筝，一个平庸的程序员，主语言 Java，第二语言 Python，其实学 Python 的时间比 Java 还要早。喜欢写博客，写博客的过程能加深自己对一个知识点的理解，同时还可以分享给他人。喜欢做一些小东西，所以也会一些前端的东西，React、JavaScript、CSS 都会一些，做一些小工具还够用。</p></div></div></div><script src=https://utteranc.es/client.js repo=huzhicheng/blog-comment issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></main><div class="footer gradient-2"><div class="container footer-container"><div class=row><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>网站地图</div><ul class=list-unstyled><li><a href=https://www.moonkite.cn/tags/>标签</a></li><li><a href=https://www.moonkite.cn/categories/>分类</a></li><li><a rel=alternate type=application/rss+xml href=https://www.moonkite.cn/index.xml><i class="fas fa-rss-square"></i> RSS订阅</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>社群</div><ul class=list-unstyled><li><a href=https://github.com/huzhicheng rel=noopener target=_blank>GitHub</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>友链</div><ul class=list-unstyled><li><a href=https://github.com/huzhicheng rel=noopener target=_blank>关于我</a></li></ul></div><div class="col-xs-12 col-sm-3 col-md-3 col-lg-3"><p class="pull-right text-right"><small><em>Proudly powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo</a></em></small><br><small><em>Theme - <a href=https://github.com/shaform/hugo-theme-den rel=noopener target=_blank>Den</a></em></small><br><small>&copy;
风筝
2023</small></p></div></div><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?e417ddf834c7bb7411207e1fa09815aa",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-C714TFXRD4"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-C714TFXRD4")</script><div class=busuanzi-footer><span id=busuanzi_container_site_pv>本站总访问量<span id=busuanzi_value_site_pv></span>次</span>
<span id=busuanzi_container_site_uv>本站访客数<span id=busuanzi_value_site_uv></span>人次</span></div></div></div><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap_4.1.3_js_bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script>$(document).ready(function(){$("#load_disqus").length&&$(window).scroll(function(){if($("#load_disqus").length){var e=$("#load_disqus").offset().top,t=$(window).scrollTop(),n=t+$(window).height();t<e&&e<n&&load_disqus()}})})</script></body></html>