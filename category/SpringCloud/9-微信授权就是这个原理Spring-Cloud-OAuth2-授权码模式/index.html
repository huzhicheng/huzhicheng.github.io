<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage><head><meta name=generator content="Hugo 0.113.0"><meta charset=utf-8><title>9. 微信授权就是这个原理，Spring Cloud OAuth2 授权码模式 · 古时的风筝</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="上一篇文章Spring Cloud OAuth2 实现单点登录介绍了使用 password 模式进行身份认证和单点登录。本篇介绍 Spring Cloud OAuth2 的另外一种授权模式-授权码模式。 授权码模式的认证"><meta name=keywords content="Hugo,theme,编程,java,ChatGPT,程序员,开发"><link rel=canonical href=https://moonkite.cn/category/SpringCloud/9-%E5%BE%AE%E4%BF%A1%E6%8E%88%E6%9D%83%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B8%AA%E5%8E%9F%E7%90%86Spring-Cloud-OAuth2-%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F/><link rel=icon href=https://moonkite.cn/images/photo.png><link rel=stylesheet href=https://cdn.usebootstrap.com/bootstrap/4.1.3/css/bootstrap.min.css><link rel=stylesheet href=https://moonkite.cn/css/den.css><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="9. 微信授权就是这个原理，Spring Cloud OAuth2 授权码模式"><meta property="og:description" content="上一篇文章Spring Cloud OAuth2 实现单点登录介绍了使用 password 模式进行身份认证和单点登录。本篇介绍 Spring Cloud OAuth2 的另外一种授权模式-授权码模式。 授权码模式的认证"><meta property="og:type" content="article"><meta property="og:url" content="https://moonkite.cn/category/SpringCloud/9-%E5%BE%AE%E4%BF%A1%E6%8E%88%E6%9D%83%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B8%AA%E5%8E%9F%E7%90%86Spring-Cloud-OAuth2-%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F/"><meta property="article:section" content="category"><meta property="article:published_time" content="2023-06-02T08:56:23+08:00"><meta property="article:modified_time" content="2023-06-02T08:56:23+08:00"><meta itemprop=name content="9. 微信授权就是这个原理，Spring Cloud OAuth2 授权码模式"><meta itemprop=description content="上一篇文章Spring Cloud OAuth2 实现单点登录介绍了使用 password 模式进行身份认证和单点登录。本篇介绍 Spring Cloud OAuth2 的另外一种授权模式-授权码模式。 授权码模式的认证"><meta itemprop=datePublished content="2023-06-02T08:56:23+08:00"><meta itemprop=dateModified content="2023-06-02T08:56:23+08:00"><meta itemprop=wordCount content="2758"><meta itemprop=keywords content="Java,JDK,Spring Cloud,Spring Cloud OAuth2,OAuth2,用户认证,单点登录,"><meta name=twitter:card content="summary"><meta name=twitter:title content="9. 微信授权就是这个原理，Spring Cloud OAuth2 授权码模式"><meta name=twitter:description content="上一篇文章Spring Cloud OAuth2 实现单点登录介绍了使用 password 模式进行身份认证和单点登录。本篇介绍 Spring Cloud OAuth2 的另外一种授权模式-授权码模式。 授权码模式的认证"></head><body><div class=header-container style=background:linear-gradient(rgba(0,0,0,.2),rgba(0,0,0,.2)),url(https://moonkite.cn/images/background.png);background-position:top;background-size:cover><div class=container><nav class="header-nav navbar navbar-expand-md navbar-dark light-dark"><div class="header-logo navbar-brand"><a class=float-left href=https://moonkite.cn/></a></div><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="nav-menu collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a href=https://moonkite.cn/ class=nav-link><i class="fas fad fa-h-square"></i>主页</a></li><li class=nav-item><a href=https://moonkite.cn/category/notes/ class=nav-link><i class='fas fa-yin-yang'></i>生活随笔</a></li><li class=nav-item><a href=javascript:void(0) class=nav-link><i class='fas fa-laptop-code'></i>技术文章</a><div class=sub-dropdown-menu><a class=sub-nav-link href=https://moonkite.cn/category/java><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"><path fill="#f44336" d="M23.65 24.898c-.998-1.609-1.722-2.943-2.725-5.455C19.229 15.2 31.24 11.366 26.37 3.999c2.111 5.089-7.577 8.235-8.477 12.473-.823 3.898 5.752 8.426 5.757 8.426z"/><path fill="#f44336" d="M23.878 17.27c-.192 2.516 2.229 3.857 2.299 5.695.056 1.496-1.447 2.743-1.447 2.743s2.728-.536 3.579-2.818c.945-2.534-1.834-4.269-1.548-6.298.267-1.938 6.031-5.543 6.031-5.543S24.311 11.611 23.878 17.27z"/><g><path fill="#1565c0" d="M32.084 25.055c1.754-.394 3.233.723 3.233 2.01.0 2.901-4.021 5.643-4.021 5.643s6.225-.742 6.225-5.505c0-3.15-3.057-3.937-5.437-2.148zm-2.955 2.34s1.941-1.383 2.458-1.902c-4.763 1.011-15.638 1.147-15.638.269.0-.809 3.507-1.638 3.507-1.638s-7.773-.112-7.773 2.181C11.683 28.695 21.858 28.866 29.129 27.395z"/><path fill="#1565c0" d="M27.935 29.571c-4.509 1.499-12.814 1.02-10.354-.993-1.198.0-2.974.963-2.974 1.889.0 1.857 8.982 3.291 15.63.572l-2.302-1.468z"/><path fill="#1565c0" d="M18.686 32.739c-1.636.0-2.695 1.054-2.695 1.822.0 2.391 9.76 2.632 13.627.205l-2.458-1.632C24.271 34.404 17.014 34.579 18.686 32.739z"/><path fill="#1565c0" d="M36.281 36.632c0-.936-1.055-1.377-1.433-1.588 2.228 5.373-22.317 4.956-22.317 1.784.0-.721 1.807-1.427 3.477-1.093l-1.42-.839C11.26 34.374 9 35.837 9 37.017 9 42.52 36.281 42.255 36.281 36.632z"/><path fill="#1565c0" d="M39 38.604c-4.146 4.095-14.659 5.587-25.231 3.057C24.341 46.164 38.95 43.628 39 38.604z"/></g></svg>&nbsp;可爱的 Java</a>
<a class=sub-nav-link href=https://moonkite.cn/category/SpringCloud><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48"><path fill="#8bc34a" d="M43.982 23.635c.069-4.261-.891-9.328-2.891-15.273L39.523 3.7l-2.13 4.433c-.114.237-.244.469-.38.698C33.514 5.827 28.974 4 24 4 12.954 4 4 12.954 4 24s8.954 20 20 20 20-8.954 20-20C44 23.877 43.984 23.758 43.982 23.635z"/><path fill="#fff" d="M39.385 32.558C36.262 36.86 30.734 37.091 25.531 37H18.75h-1.938c4.428-1.593 7.063-1.972 9.754-3.4 5.068-2.665 10.078-8.496 11.121-14.562-1.93 5.836-7.779 10.85-13.109 12.889-3.652 1.393-10.248 2.745-10.248 2.745l-.267-.145C9.573 32.268 9.437 22.214 17.6 18.968c3.574-1.423 6.993-.641 10.854-1.593 4.122-1.012 8.89-4.208 10.83-8.375C41.456 15.667 44.07 26.106 39.385 32.558zM15.668 38.445C15.386 38.795 14.955 39 14.505 39c-.823.0-1.495-.677-1.495-1.5s.677-1.5 1.495-1.5c.341.0.677.118.941.336C16.086 36.855 16.186 37.805 15.668 38.445z"/></svg>&nbsp; Spring Cloud 系列</a></div></li><li class=nav-item><a href=https://moonkite.cn/category/network class=nav-link><i class="fas fa-network-wired"></i>轻解计算机网络</a></li><li class=nav-item><a href=https://moonkite.cn/category/product class=nav-link><i class="fas fab fa-medapps"></i>我的产品</a></li></ul></div></nav></div><div class="container header-wrapper"><div class=row><div class=col-lg-12><div class=header-content><h1 class=header-title>9. 微信授权就是这个原理，Spring Cloud OAuth2 授权码模式</h1><p class=header-date>作者：
风筝 /
2023-06-02<div class=header-underline></div><div class=header-date>&nbsp·&nbsp
  <span id=busuanzi_container_page_pv>本文被阅读<span id=busuanzi_value_page_pv></span>次</span></div><div class=clearfix></div><p class="float-right header-tags"><i class="fas fa-tags" aria-hidden=true></i>
<a href=https://moonkite.cn/tag/Java/>Java</a>,
<a href=https://moonkite.cn/tag/JDK/>JDK</a>,
<a href=https://moonkite.cn/tag/OAuth2/>OAuth2</a>,
<a href=https://moonkite.cn/tag/Spring-Cloud/>Spring Cloud</a>,
<a href=https://moonkite.cn/tag/Spring-Cloud-OAuth2/>Spring Cloud OAuth2</a>,
<a href=https://moonkite.cn/tag/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/>单点登录</a>,
<a href=https://moonkite.cn/tag/%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81/>用户认证</a></p></div></div></div></div></div><main><div class="container content"><article><blockquote><p>上一篇文章<a href=https://www.moonkite.cn/category/SpringCloud/8-Spring-Cloud-OAuth2-%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/>Spring Cloud OAuth2 实现单点登录</a>介绍了使用 password 模式进行身份认证和单点登录。本篇介绍 Spring Cloud OAuth2 的另外一种授权模式-授权码模式。</p></blockquote><p>授权码模式的认证过程是这样的：</p><p>1、用户客户端请求认证服务器的认证接口，并附上回调地址；</p><p>2、认证服务接口接收到认证请求后调整到自身的登录界面；</p><p>3、用户输入用户名和密码，点击确认，跳转到授权、拒绝提示页面(也可省略)；</p><p>4、用户点击授权或者默认授权后，跳转到微服务客户端的回调地址，并传入参数 code；</p><p>5、回调地址一般是一个 RESTful 接口，此接口拿到 code 参数后，再次请求认证服务器的 token 获取接口，用来换取 access_token 等信息；</p><p>6、获取到 access_token 后，拿着 token 去请求各个微服务客户端的接口。</p><p>注意上面所说的用户客户端可以理解为浏览器、app 端，微服务客户端就是我们系统中的例如订单服务、用户服务等微服务，认证服务端就是用来做认证授权的服务，相对于认证服务端来说，各个业务微服务也可以称作是它的客户端。</p><h3 id=认证服务端配置>认证服务端配置</h3><p>认证服务端继续用上一篇文章的配置，代码不需要任何改变，只需要在数据库里加一条记录，来支持新加的微服务客户端的认证</p><p>我们要创建的客户端的 client-id 为 code-client，client-secret 为 code-secret-8888，但是同样需要加密，可以用如下代码获取：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=k>new</span> <span class=n>BCryptPasswordEncoder</span><span class=o>().</span><span class=na>encode</span><span class=o>(</span><span class=s>&#34;code-secret-8888&#34;</span><span class=o>));</span>
</span></span></code></pre></div><p>除了以上这两个参数，要将 authorized_grant_types 设置为 authorization_code,refresh_token，web_server_redirect_uri 设置为回调地址，稍后微服务客户端会创建这个接口。</p><p>然后将这条记录组织好插入数据库中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=nf>oauth_client_details</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>client_id</span><span class=p>,</span><span class=w> </span><span class=n>client_secret</span><span class=p>,</span><span class=w> </span><span class=n>scope</span><span class=p>,</span><span class=w> </span><span class=n>authorized_grant_types</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>web_server_redirect_uri</span><span class=p>,</span><span class=w> </span><span class=n>authorities</span><span class=p>,</span><span class=w> </span><span class=n>access_token_validity</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>refresh_token_validity</span><span class=p>,</span><span class=w> </span><span class=n>additional_information</span><span class=p>,</span><span class=w> </span><span class=n>autoapprove</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>VALUES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;code-client&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;$2a$10$jENDQZRtqqdr6sXGQK.L0OBADGIpyhtaRfaRDTeLKI76I/Ir1FDn6&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;all&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;authorization_code,refresh_token&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;http://localhost:6102/client-authcode/login&#39;</span><span class=p>,</span><span class=w> </span><span class=no>null</span><span class=p>,</span><span class=w> </span><span class=mi>3600</span><span class=p>,</span><span class=w> </span><span class=mi>36000</span><span class=p>,</span><span class=w> </span><span class=no>null</span><span class=p>,</span><span class=w> </span><span class=no>true</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><h3 id=创建授权模式的微服务>创建授权模式的微服务</h3><p><strong>引入 maven 包</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-web<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>io.jsonwebtoken<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>jjwt<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>0.9.1<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.squareup.okhttp3<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>okhttp<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>3.14.2<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-thymeleaf<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>引入 okhttp 和 thymeleaf 是因为要做一个简单的页面并模拟正常的认证过程。</p><p><strong>配置文件 application.yml</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>application</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>client-authcode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6102</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>servlet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>context-path</span><span class=p>:</span><span class=w> </span><span class=l>/client-authcode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>security</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>oauth2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>client</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>client-id</span><span class=p>:</span><span class=w> </span><span class=l>code-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>client-secret</span><span class=p>:</span><span class=w> </span><span class=l>code-secret-8888</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>user-authorization-uri</span><span class=p>:</span><span class=w> </span><span class=l>http://localhost:6001/oauth/authorize</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>access-token-uri</span><span class=p>:</span><span class=w> </span><span class=l>http://localhost:6001/oauth/token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>jwt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key-uri</span><span class=p>:</span><span class=w> </span><span class=l>http://localhost:6001/oauth/token_key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key-value</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>authorization</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>check-token-access</span><span class=p>:</span><span class=w> </span><span class=l>http://localhost:6001/oauth/check_token</span><span class=w>
</span></span></span></code></pre></div><p>**创建 resourceConfig **</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=nd>@EnableResourceServer</span>
</span></span><span class=line><span class=cl><span class=nd>@EnableGlobalMethodSecurity</span><span class=o>(</span><span class=n>prePostEnabled</span> <span class=o>=</span> <span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ResourceServerConfig</span> <span class=kd>extends</span> <span class=n>ResourceServerConfigurerAdapter</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>TokenStore</span> <span class=nf>jwtTokenStore</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>JwtTokenStore</span><span class=o>(</span><span class=n>jwtAccessTokenConverter</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>JwtAccessTokenConverter</span> <span class=nf>jwtAccessTokenConverter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>JwtAccessTokenConverter</span> <span class=n>accessTokenConverter</span> <span class=o>=</span> <span class=k>new</span> <span class=n>JwtAccessTokenConverter</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>accessTokenConverter</span><span class=o>.</span><span class=na>setSigningKey</span><span class=o>(</span><span class=s>&#34;dev&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>accessTokenConverter</span><span class=o>.</span><span class=na>setVerifierKey</span><span class=o>(</span><span class=s>&#34;dev&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>accessTokenConverter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>TokenStore</span> <span class=n>jwtTokenStore</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>ResourceServerSecurityConfigurer</span> <span class=n>resources</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>resources</span><span class=o>.</span><span class=na>tokenStore</span><span class=o>(</span><span class=n>jwtTokenStore</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>HttpSecurity</span> <span class=n>http</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>http</span><span class=o>.</span><span class=na>authorizeRequests</span><span class=o>().</span><span class=na>antMatchers</span><span class=o>(</span><span class=s>&#34;/login&#34;</span><span class=o>).</span><span class=na>permitAll</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>使用 jwt 作为 token 的存储，注意允许 <code>/login</code> 接口无授权访问，这个地址是认证的回调地址，会返回 code 参数。</p><p><strong>创建 application.java启动类</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SpringBootApplication</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Application</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>SpringApplication</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>Application</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>到这步可以先停一下了。我们把认证服务端和刚刚创建的认证客户端启动起来，就可以手工测试一下了。回调接口不是还没创建呢吗，没关系，我们权当那个地址现在就是为了接收 code 参数的。
**1、**在浏览器访问 /oauth/authorize 授权接口，接口地址为：</p><pre tabindex=0><code>http://localhost:6001/oauth/authorize?client_id=code-client&amp;response_type=code&amp;redirect_uri=http://localhost:6102/client-authcode/login 
</code></pre><p>注意 response_type 参数设置为 code，redirect_uri 设置为数据库中插入的回调地址。</p><p>**2、**输入上面地址后，会自动跳转到认证服务端的登录页面，输入用户名、密码，这里用户名是 admin，密码是 123456
<img src=https://hexo.moonkite.cn/blog/273364-20191107100706180-194452156.png alt></p><p>**3、**点击确定后，来到授权确认页面，页面上有 Authorize 和 Deny (授权和拒绝)两个按钮。可通过将 autoapprove 字段设置为 0 来取消此页面的展示，默认直接同意授权。
<img src=https://hexo.moonkite.cn/blog/273364-20191107100718252-1368402091.png alt></p><p>**4、**点击同意授权后，跳转到了回调地址，虽然是 404 ，但是我们只是为了拿到 code 参数，注意地址后面的 code 参数。
<img src=https://hexo.moonkite.cn/blog/273364-20191107100737632-1410280038.png alt></p><p>**5、**拿到这个 code 参数是为了向认证服务器 /oauth/token 接口请求 access_token ，继续用 REST Client 发送请求，同样的，你也可以用 postman 等工具测试。</p><p>注意 grant_type 参数设置为 authorization_code，code 就是上一步回调地址中加上的，redirect_uri 仍然要带上，回作为验证条件，如果不带或者与前面设置的不一致，会出现错误。</p><p>请求头 Authorization ，仍然是 Basic + 空格 + base64(client_id:client_secret)，可以通过 <a href=https://www.sojson.com/base64.html>https://www.sojson.com/base64.html</a> 网站在线做 base64 编码。</p><p>code-client:code-secret-8888 通过 base64 编码后结果为 Y29kZS1jbGllbnQ6Y29kZS1zZWNyZXQtODg4OA==</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>POST</span> <span class=s>http://localhost:6001/oauth/token?grant_type=authorization_code&amp;client=code-client&amp;code=BbCE34&amp;redirect_uri=http://localhost:6102/client-authcode/login</span>
</span></span><span class=line><span class=cl><span class=na>Accept</span><span class=o>:</span> <span class=s>*/*</span>
</span></span><span class=line><span class=cl><span class=na>Cache-Control</span><span class=o>:</span> <span class=s>no-cache</span>
</span></span><span class=line><span class=cl><span class=na>Authorization</span><span class=o>:</span> <span class=s>Basic Y29kZS1jbGllbnQ6Y29kZS1zZWNyZXQtODg4OA==</span>
</span></span></code></pre></div><p>发送请求后，返回的 json 内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;access_token&#34;</span><span class=p>:</span> <span class=s2>&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTU3MjYwMTMzMiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9BRE1JTiJdLCJqdGkiOiI2OWRmY2M4Yy1iZmZiLTRiNDItYTZhZi1hN2IzZWUyZjI1ZTMiLCJjbGllbnRfaWQiOiJjb2RlLWNsaWVudCJ9.WlgGnBkNdg2PwKqjbZWo6QmUmq0QluZLgIWJXaZahSU&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;token_type&#34;</span><span class=p>:</span> <span class=s2>&#34;bearer&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;refresh_token&#34;</span><span class=p>:</span> <span class=s2>&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsImp3dC1leHQiOiJKV1Qg5omp5bGV5L-h5oGvIiwic2NvcGUiOlsiYWxsIl0sImF0aSI6IjY5ZGZjYzhjLWJmZmItNGI0Mi1hNmFmLWE3YjNlZTJmMjVlMyIsImV4cCI6MTU3MjYzMzczMiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9BRE1JTiJdLCJqdGkiOiJkNzk2OWRhMS04NTg4LTQ2YzMtYjdlNS1jMGM5NzcxNTM5Y2YiLCJjbGllbnRfaWQiOiJjb2RlLWNsaWVudCJ9.TEz0pQOhST9-ozdoJWm6cf1SoWvPC6W-5JW9yjZJXek&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;expires_in&#34;</span><span class=p>:</span> <span class=mi>3599</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scope&#34;</span><span class=p>:</span> <span class=s2>&#34;all&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jwt-ext&#34;</span><span class=p>:</span> <span class=s2>&#34;JWT 扩展信息&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jti&#34;</span><span class=p>:</span> <span class=s2>&#34;69dfcc8c-bffb-4b42-a6af-a7b3ee2f25e3&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>和上一篇文章 password 模式拿到的 token 内容是一致的，接下来的请求都需要带上 access_token 。</p><p>**6、**把获取到的 access_token 代入到下面的请求中 ${access_token} 的位置，就可以请求微服务中的需要授权访问的接口了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>GET</span> <span class=s>http://localhost:6102/client-authcode/get</span>
</span></span><span class=line><span class=cl><span class=na>Accept</span><span class=o>:</span> <span class=s>*/*</span>
</span></span><span class=line><span class=cl><span class=na>Cache-Control</span><span class=o>:</span> <span class=s>no-cache</span>
</span></span><span class=line><span class=cl><span class=na>Authorization</span><span class=o>:</span> <span class=s>bearer ${access_token}</span>
</span></span></code></pre></div><p>接口内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@org.springframework.web.bind.annotation.ResponseBody</span>
</span></span><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;get&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@PreAuthorize</span><span class=o>(</span><span class=s>&#34;hasAnyRole(&#39;ROLE_ADMIN&#39;)&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Object</span> <span class=nf>get</span><span class=o>(</span><span class=n>Authentication</span> <span class=n>authentication</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>authentication</span><span class=o>.</span><span class=na>getCredentials</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>OAuth2AuthenticationDetails</span> <span class=n>details</span> <span class=o>=</span> <span class=o>(</span><span class=n>OAuth2AuthenticationDetails</span><span class=o>)</span> <span class=n>authentication</span><span class=o>.</span><span class=na>getDetails</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>token</span> <span class=o>=</span> <span class=n>details</span><span class=o>.</span><span class=na>getTokenValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>token</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>经过以上的手工测试，证明此过程是通的，但是还没有达到自动化。如果你集成过微信登录，那你一定知道我们在回调地址中做了什么，拿到返回的 code 参数去 token 接口换取 access_token 对不对，没错，思路都是一样的，我们的回调接口中同样要拿 code 去换取 access_token。</p><p>为此，我做了一个简单的页面，并且在回调接口中请求获取 token 的接口。</p><p><strong>创建简单的登录页面</strong></p><p>在 resources 目录下创建 templates 目录，用来存放 thymeleaf 的模板，不做样式，只做最简单的演示，创建 index.html 模板，内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span> <span class=na>xmlns:th</span><span class=o>=</span><span class=s>&#34;http://www.thymeleaf.org&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>古时的风筝-OAuth2 Client<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;http://localhost:6001/oauth/authorize?client_id=code-client&amp;response_type=code&amp;redirect_uri=http://localhost:6102/client-authcode/login&#34;</span><span class=p>&gt;</span>登录<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>span</span> <span class=na>th:text</span><span class=o>=</span><span class=s>&#34;&#39;当前认证用户：&#39; + ${username}&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>span</span> <span class=na>th:text</span><span class=o>=</span><span class=s>&#34;${accessToken}&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></div><p><strong>回调接口及其他接口</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@Controller</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CodeClientController</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 用来展示index.html 模板
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>  	
</span></span><span class=line><span class=cl>    <span class=nd>@GetMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;index&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>String</span> <span class=nf>index</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s>&#34;index&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@GetMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;login&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Object</span> <span class=nf>login</span><span class=o>(</span><span class=n>String</span> <span class=n>code</span><span class=o>,</span><span class=n>Model</span> <span class=n>model</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>tokenUrl</span> <span class=o>=</span> <span class=s>&#34;http://localhost:6001/oauth/token&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>OkHttpClient</span> <span class=n>httpClient</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OkHttpClient</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>RequestBody</span> <span class=n>body</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FormBody</span><span class=o>.</span><span class=na>Builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;grant_type&#34;</span><span class=o>,</span> <span class=s>&#34;authorization_code&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;client&#34;</span><span class=o>,</span> <span class=s>&#34;code-client&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;redirect_uri&#34;</span><span class=o>,</span><span class=s>&#34;http://localhost:6102/client-authcode/login&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;code&#34;</span><span class=o>,</span> <span class=n>code</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Request</span> <span class=n>request</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Request</span><span class=o>.</span><span class=na>Builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>url</span><span class=o>(</span><span class=n>tokenUrl</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>post</span><span class=o>(</span><span class=n>body</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>addHeader</span><span class=o>(</span><span class=s>&#34;Authorization&#34;</span><span class=o>,</span> <span class=s>&#34;Basic Y29kZS1jbGllbnQ6Y29kZS1zZWNyZXQtODg4OA==&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Response</span> <span class=n>response</span> <span class=o>=</span> <span class=n>httpClient</span><span class=o>.</span><span class=na>newCall</span><span class=o>(</span><span class=n>request</span><span class=o>).</span><span class=na>execute</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>result</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=na>body</span><span class=o>().</span><span class=na>string</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>ObjectMapper</span> <span class=n>objectMapper</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ObjectMapper</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>Map</span> <span class=n>tokenMap</span> <span class=o>=</span> <span class=n>objectMapper</span><span class=o>.</span><span class=na>readValue</span><span class=o>(</span><span class=n>result</span><span class=o>,</span><span class=n>Map</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>accessToken</span> <span class=o>=</span> <span class=n>tokenMap</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;access_token&#34;</span><span class=o>).</span><span class=na>toString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>Claims</span> <span class=n>claims</span> <span class=o>=</span> <span class=n>Jwts</span><span class=o>.</span><span class=na>parser</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>setSigningKey</span><span class=o>(</span><span class=s>&#34;dev&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>(</span><span class=n>StandardCharsets</span><span class=o>.</span><span class=na>UTF_8</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>parseClaimsJws</span><span class=o>(</span><span class=n>accessToken</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>getBody</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>userName</span> <span class=o>=</span> <span class=n>claims</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;user_name&#34;</span><span class=o>).</span><span class=na>toString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>.</span><span class=na>addAttribute</span><span class=o>(</span><span class=s>&#34;username&#34;</span><span class=o>,</span> <span class=n>userName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>.</span><span class=na>addAttribute</span><span class=o>(</span><span class=s>&#34;accessToken&#34;</span><span class=o>,</span> <span class=n>result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s>&#34;index&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@org.springframework.web.bind.annotation.ResponseBody</span>
</span></span><span class=line><span class=cl>    <span class=nd>@GetMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;get&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nd>@PreAuthorize</span><span class=o>(</span><span class=s>&#34;hasAnyRole(&#39;ROLE_ADMIN&#39;)&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Object</span> <span class=nf>get</span><span class=o>(</span><span class=n>Authentication</span> <span class=n>authentication</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>authentication</span><span class=o>.</span><span class=na>getCredentials</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>OAuth2AuthenticationDetails</span> <span class=n>details</span> <span class=o>=</span> <span class=o>(</span><span class=n>OAuth2AuthenticationDetails</span><span class=o>)</span> <span class=n>authentication</span><span class=o>.</span><span class=na>getDetails</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>token</span> <span class=o>=</span> <span class=n>details</span><span class=o>.</span><span class=na>getTokenValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>token</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>其中 index() 方法是为了展示 thymeleaf 模板，login 方法就是回调接口，这里用了 okhttp3 用作接口请求，请求认证服务端的 /oauth/token 接口来换取 access_token，只是把我们手工测试的步骤自动化了。</p><p><strong>访问 index.html 页面</strong></p><p>我们假设这个页面就是一个网站的首页，未登录的用户会在网站上看到登录按钮，我们访问这个页面：<a href=http://localhost:6102/client-authcode/index>http://localhost:6102/client-authcode/index</a>，看到的页面是这样的
<img src=https://hexo.moonkite.cn/blog/273364-20191107100802479-1544165549.png alt></p><p>接下来，点击登录按钮，通过上面的模板代码看出，点击后其实就是跳转到了我们手工测试第一步访问的那个地址，之后的操作和上面手工测试的是一致的，输入用户名密码、点击同意授权。</p><p>接下来，页面跳转回回调地址&lt;http://localhost:6102/client-authcode/login?code=xxx 的时候，login 方法拿到 code 参数，开始构造 post 请求体，并把 Authorization 加入请求头，然后请求 oauth/token 接口，最后将拿到的 token 和 通过 token 解析后的 username 返回给前端，最后呈现的效果如下：
<img src=https://hexo.moonkite.cn/blog/273364-20191107100813527-883457281.png alt></p><p>最后，拿到 token 后的客户端，就可以将 token 加入到请求头后，去访问需要授权的接口了。</p><p>结合上一篇文章，我们就实现了 password 和 授权码两种模式的 oauth2 认证。</p><p>本篇源码微服务客户端对应的源码地址为: <a href=https://github.com/huzhicheng/spring-cloud-study/tree/master/oauth2/oauth2-client-authorization-code-server>点击查看 github 源码</a></p></article><h4>相关文章</h4><dl class=row><dd class=col-md-9><a href=/category/SpringCloud/8-Spring-Cloud-OAuth2-%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/>8. Spring Cloud OAuth2 实现用户认证及单点登录</a></dd><dd class=col-md-9><a href=/category/SpringCloud/0-Srping-Cloud-%E5%BC%80%E7%AF%87/>0. Spring Cloud 是什么</a></dd><dd class=col-md-9><a href=/category/SpringCloud/1-Spring-Cloud-Eureka-%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0/>1. Spring Cloud Eureka 实现服务注册与发现</a></dd><dd class=col-md-9><a href=/category/SpringCloud/2-Spring-Cloud-Eureka-%E5%AE%9E%E7%8E%B0%E5%AE%89%E5%85%A8%E6%8E%A7%E5%88%B6/>2. Spring Cloud Eureka 实现安全控制</a></dd><dd class=col-md-9><a href=/category/SpringCloud/3-Spring-Cloud-Eureka-%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/>3. Spring Cloud Eureka 实现高可用服务发现注册中心</a></dd></dl><div class=author-card><div class=underline></div><div class=author-box><div class=qr-author-image><a href=https://www.moonkite.cn><img src=/images/person.jpg alt=风筝></a></div><div class=author-content><p class=author-title>作者</p><p class=author-name>风筝</p><p class=author-desc>古时的风筝，一个平庸的程序员，主语言 Java，第二语言 Python，其实学 Python 的时间比 Java 还要早。喜欢写博客，写博客的过程能加深自己对一个知识点的理解，同时还可以分享给他人。喜欢做一些小东西，所以也会一些前端的东西，React、JavaScript、CSS 都会一些，做一些小工具还够用。</p></div></div></div><script src=https://utteranc.es/client.js repo=huzhicheng/blog-comment issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></main><div class="footer gradient-2"><div class="container footer-container"><div class=row><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>网站地图</div><ul class=list-unstyled><li><a href=https://moonkite.cn/tags/>标签</a></li><li><a href=https://moonkite.cn/categories/>分类</a></li><li><a rel=alternate type=application/rss+xml href=https://moonkite.cn/index.xml><i class="fas fa-rss-square"></i> RSS订阅</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>社群</div><ul class=list-unstyled><li><a href=https://github.com/huzhicheng rel=noopener target=_blank>GitHub</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>友链</div><ul class=list-unstyled><li><a href=https://github.com/huzhicheng rel=noopener target=_blank>关于我</a></li></ul></div><div class="col-xs-12 col-sm-3 col-md-3 col-lg-3"><p class="pull-right text-right"><small><em>Proudly powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo</a></em></small><br><small><em>Theme - <a href=https://github.com/shaform/hugo-theme-den rel=noopener target=_blank>Den</a></em></small><br><small>&copy;
风筝
2023</small></p></div></div><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?e417ddf834c7bb7411207e1fa09815aa",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-C714TFXRD4"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-C714TFXRD4")</script><div class=busuanzi-footer><span id=busuanzi_container_site_pv>本站总访问量<span id=busuanzi_value_site_pv></span>次</span>
<span id=busuanzi_container_site_uv>本站访客数<span id=busuanzi_value_site_uv></span>人次</span></div></div></div><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap_4.1.3_js_bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script>$(document).ready(function(){$("#load_disqus").length&&$(window).scroll(function(){if($("#load_disqus").length){var e=$("#load_disqus").offset().top,t=$(window).scrollTop(),n=t+$(window).height();t<e&&e<n&&load_disqus()}})})</script></body></html>