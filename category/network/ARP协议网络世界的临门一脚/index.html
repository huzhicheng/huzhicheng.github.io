<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage><head><meta name=generator content="Hugo 0.119.0"><meta charset=utf-8><title>2. ARP协议：网络世界的临门一脚 · 古时的风筝</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="轻解计算机网络已有高清 PDF 版本可以离线阅读了，全册 65 页，如果有需要离线版的高清 PDF 可以直接下载。 各位同学肯定见过关于网络的面试题，什么TCP协议"><meta name=360-site-verification content="e75339f1cfcde17f66f71aaf8b6983e9"><meta name=keywords content="Hugo,theme,编程,java,ChatGPT,程序员,开发"><meta name=google-site-verification content="google57680cd58c46e2f3.html"><link rel=canonical href=https://www.moonkite.cn/category/network/ARP%E5%8D%8F%E8%AE%AE%E7%BD%91%E7%BB%9C%E4%B8%96%E7%95%8C%E7%9A%84%E4%B8%B4%E9%97%A8%E4%B8%80%E8%84%9A/><link rel=icon href=https://www.moonkite.cn/images/photo.png><link rel=stylesheet href=https://cdn.usebootstrap.com/bootstrap/4.1.3/css/bootstrap.min.css><link rel=stylesheet href=https://www.moonkite.cn/css/den.css><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-tc-webfont@1.0.0/style.css><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="2. ARP协议：网络世界的临门一脚"><meta property="og:description" content="轻解计算机网络已有高清 PDF 版本可以离线阅读了，全册 65 页，如果有需要离线版的高清 PDF 可以直接下载。 各位同学肯定见过关于网络的面试题，什么TCP协议"><meta property="og:type" content="article"><meta property="og:url" content="https://www.moonkite.cn/category/network/ARP%E5%8D%8F%E8%AE%AE%E7%BD%91%E7%BB%9C%E4%B8%96%E7%95%8C%E7%9A%84%E4%B8%B4%E9%97%A8%E4%B8%80%E8%84%9A/"><meta property="article:section" content="category"><meta property="article:published_time" content="2023-02-28T08:56:23+08:00"><meta property="article:modified_time" content="2023-02-28T08:56:23+08:00"><meta itemprop=name content="2. ARP协议：网络世界的临门一脚"><meta itemprop=description content="轻解计算机网络已有高清 PDF 版本可以离线阅读了，全册 65 页，如果有需要离线版的高清 PDF 可以直接下载。 各位同学肯定见过关于网络的面试题，什么TCP协议"><meta itemprop=datePublished content="2023-02-28T08:56:23+08:00"><meta itemprop=dateModified content="2023-02-28T08:56:23+08:00"><meta itemprop=wordCount content="4623"><meta itemprop=keywords content="Java,JDK,计算机网络基础,ARP协议,"><meta name=twitter:card content="summary"><meta name=twitter:title content="2. ARP协议：网络世界的临门一脚"><meta name=twitter:description content="轻解计算机网络已有高清 PDF 版本可以离线阅读了，全册 65 页，如果有需要离线版的高清 PDF 可以直接下载。 各位同学肯定见过关于网络的面试题，什么TCP协议"></head><body><div class=header-container style=background:linear-gradient(rgba(0,0,0,.2),rgba(0,0,0,.2)),url(https://hexo.moonkite.cn/blog/background.png);background-position:top;background-size:cover><div class=container><nav class="header-nav navbar navbar-expand-md navbar-dark light-dark"><div class="header-logo navbar-brand"><a class=float-left href=https://www.moonkite.cn/></a></div><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="nav-menu collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a href=https://www.moonkite.cn/ class=nav-link><i class="fas fad fa-h-square"></i>主页</a></li><li class=nav-item><a href=https://www.moonkite.cn/category/notes class=nav-link><i class='fas fa-yin-yang'></i>生活随笔</a></li><li class=nav-item><a href=javascript:void(0) class=nav-link><i class='fas fa-laptop-code'></i>技术文章</a><div class=sub-dropdown-menu><a class=sub-nav-link href=https://www.moonkite.cn/category/java><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"><path fill="#f44336" d="M23.65 24.898c-.998-1.609-1.722-2.943-2.725-5.455C19.229 15.2 31.24 11.366 26.37 3.999c2.111 5.089-7.577 8.235-8.477 12.473-.823 3.898 5.752 8.426 5.757 8.426z"/><path fill="#f44336" d="M23.878 17.27c-.192 2.516 2.229 3.857 2.299 5.695.056 1.496-1.447 2.743-1.447 2.743s2.728-.536 3.579-2.818c.945-2.534-1.834-4.269-1.548-6.298.267-1.938 6.031-5.543 6.031-5.543S24.311 11.611 23.878 17.27z"/><g><path fill="#1565c0" d="M32.084 25.055c1.754-.394 3.233.723 3.233 2.01.0 2.901-4.021 5.643-4.021 5.643s6.225-.742 6.225-5.505c0-3.15-3.057-3.937-5.437-2.148zm-2.955 2.34s1.941-1.383 2.458-1.902c-4.763 1.011-15.638 1.147-15.638.269.0-.809 3.507-1.638 3.507-1.638s-7.773-.112-7.773 2.181C11.683 28.695 21.858 28.866 29.129 27.395z"/><path fill="#1565c0" d="M27.935 29.571c-4.509 1.499-12.814 1.02-10.354-.993-1.198.0-2.974.963-2.974 1.889.0 1.857 8.982 3.291 15.63.572l-2.302-1.468z"/><path fill="#1565c0" d="M18.686 32.739c-1.636.0-2.695 1.054-2.695 1.822.0 2.391 9.76 2.632 13.627.205l-2.458-1.632C24.271 34.404 17.014 34.579 18.686 32.739z"/><path fill="#1565c0" d="M36.281 36.632c0-.936-1.055-1.377-1.433-1.588 2.228 5.373-22.317 4.956-22.317 1.784.0-.721 1.807-1.427 3.477-1.093l-1.42-.839C11.26 34.374 9 35.837 9 37.017 9 42.52 36.281 42.255 36.281 36.632z"/><path fill="#1565c0" d="M39 38.604c-4.146 4.095-14.659 5.587-25.231 3.057C24.341 46.164 38.95 43.628 39 38.604z"/></g></svg>&nbsp;可爱的 Java</a>
<a class=sub-nav-link href=https://www.moonkite.cn/category/SpringCloud><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48"><path fill="#8bc34a" d="M43.982 23.635c.069-4.261-.891-9.328-2.891-15.273L39.523 3.7l-2.13 4.433c-.114.237-.244.469-.38.698C33.514 5.827 28.974 4 24 4 12.954 4 4 12.954 4 24s8.954 20 20 20 20-8.954 20-20C44 23.877 43.984 23.758 43.982 23.635z"/><path fill="#fff" d="M39.385 32.558C36.262 36.86 30.734 37.091 25.531 37H18.75h-1.938c4.428-1.593 7.063-1.972 9.754-3.4 5.068-2.665 10.078-8.496 11.121-14.562-1.93 5.836-7.779 10.85-13.109 12.889-3.652 1.393-10.248 2.745-10.248 2.745l-.267-.145C9.573 32.268 9.437 22.214 17.6 18.968c3.574-1.423 6.993-.641 10.854-1.593 4.122-1.012 8.89-4.208 10.83-8.375C41.456 15.667 44.07 26.106 39.385 32.558zM15.668 38.445C15.386 38.795 14.955 39 14.505 39c-.823.0-1.495-.677-1.495-1.5s.677-1.5 1.495-1.5c.341.0.677.118.941.336C16.086 36.855 16.186 37.805 15.668 38.445z"/></svg>&nbsp; Spring Cloud 系列</a>
<a class=sub-nav-link href=https://www.moonkite.cn/category/other><img width=20 height=20 src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAADWElEQVR4nO2X30tTYRjH9xd4X2Dsol1EEtJdEFiSF10pldlVaVHEjiFFkKQVQeV0kfSTHdfW1pzKlpZtzXJuzp2pmzPFTdmUTdLJlEAvNKyB8MYzPG/visHZ2jxrnQc+8PCc85zz/e592XkfkUgIIYT4v2OoTVrtVFDTjILaYmgK8YqC2oproalzKZlwKqga3sXTSeFuZts9ykWcNOXnbITcTj67IRQcG1rlE5/dECK3GXcjxC8ADwqMuxGfBMeGVklNaRmZ83z0L3+ZR3ywMBfInJHQqGl07esKAmYjK6hnJoph64Ar/KsOOXmNK6HOTszKtD9uJitGQGSRcQFDiqh1RHAd8nSMWMQSDJgRjLAhrIgxta3lDvaiRlMpxvKvbi3BCNfI+xVRehdRIT2DIUWdejeH65BzMWKd1KO6jqOYLrEE46fp7Bm5bgki0Q0bhhS1t3UM1yHnYuS1XY5Oy0swD8USjPNmQ2aNfO6WO0KjphHgbrc9XNjsirGwdeAY7Vpl65CT15LRYb4VltLHYyzKAwcxgw3Xwr5BQ9D9ll53dz9d+msjfNLfWoO6GstR7/0zCXXBCJMPKxLMl3kkmC9GQsTf706znK3vyKLdhtznL2ISPm5TaqQdro8DeTJxm4EHKDZRGQfy308HtdvAcJY1I3BsII8RpAgwwB41IE9mBAwgR0EcyMlrRcTxB45DgpFUV+RbSIMxuq4kXRFyFl+3VuTeiqBtQYCDqUxqhOyJPCsTjDDCitB5urW8zS2oTSzBxNS7MB3tpeiC4kicO8azCQLJnkB9Me750Xs44b4CmQcjc4SzZwSGHXL42Xy0B6NTHMIDUp36RIJAsmeS2od7vuuKE+4TEUMbDHGZMLLBNrlUV/3u9sYRwH7vkq/nZFmUJaotwfRoK5bk6qoooNRUh9kegOyZkpUtsT3zuvKE+6qev4myKF899nkNTeMTJuWsu6spTBjZ4GzESUv7+R6qmCQ4aeoTZyPDLy4XMTS1xrdo5k/WmDbpflEq4XpJ7XbS1O0+bYvnve7JLNCnkXkZWmrYCfo0Mi9+r7bFA1pAkyjd0Ov1EZVKhQDI034Q3++1mM39H8xmBECeEZV8vNdmtRptAwMojtVqzIjKHH6vEEIIIcrt+AnU4LBcH67z1wAAAABJRU5ErkJggg=="> &nbsp; 杂七杂八</a></div></li><li class=nav-item><a href=https://www.moonkite.cn/category/network class=nav-link><i class="fas fa-network-wired"></i>轻解计算机网络</a></li><li class=nav-item><a href=https://www.moonkite.cn/category/product class=nav-link><i class="fas fab fa-medapps"></i>我的产品</a></li></ul></div></nav></div><div class="container header-wrapper"><div class=row><div class=col-lg-12><div class=header-content><h1 class=header-title>2. ARP协议：网络世界的临门一脚</h1><p class=header-date>作者：
风筝 /
2023-02-28<div class=header-underline></div><div class=header-date>&nbsp·&nbsp
  <span id=busuanzi_container_page_pv>本文被阅读<span id=busuanzi_value_page_pv></span>次</span></div><div class=clearfix></div><p class="float-right header-tags"><i class="fas fa-tags" aria-hidden=true></i>
<a href=https://www.moonkite.cn/tag/ARP%E5%8D%8F%E8%AE%AE/>ARP协议</a>,
<a href=https://www.moonkite.cn/tag/Java/>Java</a>,
<a href=https://www.moonkite.cn/tag/JDK/>JDK</a>,
<a href=https://www.moonkite.cn/tag/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/>计算机网络基础</a></p></div></div></div></div></div><main><div class="container content"><article><p>轻解计算机网络已有高清 PDF 版本可以离线阅读了，全册 65 页，如果有需要离线版的高清 PDF 可以<a href="https://pan.baidu.com/s/10LH_5afGftayMo8Q1Io_gA?pwd=f8hp">直接下载</a>。</p><p>各位同学肯定见过关于网络的面试题，什么TCP协议和UDP的区别啦，IP协议工作在哪层啊等等，这都是网络中定义的各种协议。这些标准化的协议就是网络分层模型标准化的核心部分。要想搞懂网络，必须搞明白其中的几种主要的网络协议。</p><p>今天我们就开始介绍网络世界的协议。介绍的顺序大致是从网络模型由底向上来，包括数据链路层的以太网协议，网络层的 ARP协议、RARP协议、IP协议、ICMP协议，传输层的 TCP协议、UDP 协议，以及应用层的 HTTP/HTTPS协议。</p><p>我们假设数据包都是在以太网传输，所以以太网协议一直是贯穿始终的，因为最终所有的数据包都会被封装成以太网帧，所以其他几种协议的介绍过程中，会穿插这以太网协议，不用单独介绍，自然而然就理解了。</p><p><img src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5a583629e45e41f09ee76a71ee50d8dd~tplv-k3u1fbpfcp-zoom-1.image alt></p><p>今天我们就彻底讲清楚 ARP 协议（地址解析协议）， 我把 ARP 协议比作数据包在网络世界的临门一脚，当数据包到达了一个局域网中，局域网中有那么多机器，踢开哪台机器的大门，就靠 ARP 协议了。为什么这么说，一会儿你就明白了。</p><p><strong>其实 ARP 协议可以简单概括为几句话：</strong></p><ol><li>ARP 工作在局域网内；</li><li>ARP 的作用是根据 IP 地址获取对应的 MAC 地址；</li><li>在网络中最终传输的数据叫做数据帧，是数据链路层最后封装的，而数据帧要根据 MAC 地址找到目的主机，一般是目的主机的某个网卡；</li><li>而一般我们只知道目的主机的 IP，不知道 MAC 地址，所以需要 ARP 协议。</li></ol><p>好的，讲完了。开个玩笑，当然没有，最好还是继续看下边的内容。</p><p>在 OSI 模型中，通常认为 ARP和RARP属于数据链路层协议，因为它们不使用IP协议。而在TCP/IP 协议栈中，将 ARP归于网络层，和IP协议在同一层。</p><p>只要知道对方的 IP 地址或域名，就能将数据发送过去，这是我们常识性的理解。而且在平常的使用过程中也确实是这样的。比如我们开发过程中，建立一个 socket 连接，只要知道目标 IP 和 端口就可以了。</p><p>真实的网络世界中是这样的吗，确实 IP 地址是必不可少的，但是还有另外一种地址也是必不可少的，那就是 MAC 地址。</p><p>最终，在数据到达以太网链路层，会被包装成以太网数据帧，而数据帧中决定最终去向的是就是目标 MAC 地址，注意喽，是 MAC 地址（硬件地址），而不是 IP 地址。</p><p>可以把 IP 比作现实世界中一个房子的标记，比如北京市朝阳区XX路xx小区1号楼1单元801，而 MAC 地址则是这个房子的经纬度（116.354856,39.942009），虽然我们看前面的一串标示更容易理解，但是当我们要导航去那里的时候还是要靠经纬度。</p><p>但是如何在一大群机器中确定目标 IP 对应的 MAC 地址呢，数据已经到了局域网，这么多大门该开哪一扇呢，这就是 ARP 该做的事儿了。</p><p><strong>什么是 MAC 地址</strong></p><p>MAC地址（Media Access Control Address），直译为媒体存取控制位址，也称为局域网地址（LAN Address），以太网地址（Ethernet Address）或物理地址（Physical Address），它是一个用来确认网路设备位置的位址。在OSI模型中，第三层网路层负责IP地址，第二层资料链结层则负责MAC位址。MAC地址用于在网络中唯一标示一个网卡，一台设备若有一或多个网卡，则每个网卡都需要并会有一个唯一的MAC地址。</p><p>MAC 地址长度为6字节，48bit，用16进制的6个元组表示，例如 <code>3c:22:fb:64:4f:1d</code>，其中有一个特殊的地址就是所有比特位都是1的地址 <code>ff:ff:ff:ff:ff:ff</code>，表示是一个广播地址，意思就是指消息要发给局域网中的所有网卡。</p><h2 id=为什么需要-arp-协议>为什么需要 ARP 协议</h2><p>直接的原因就是数据链路层要将数据帧发送到目的端，必须要知道目的端的 MAC 地址，这是由网络模型的架构设计决定的。</p><p>下面这张图是网络 4 层模型以及数据从发送端到接收端的首发过程。发送是从上向下经过层层包装，最后形成一个数据帧（最常用的以太网帧），之后这个数据在纷繁复杂的网络世界中勇往直前，到达接收端，接收端从下向上层层拆包，最后供应用层使用。</p><p><img src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c813b54c07b84c4d85b1736d82fb3af7~tplv-k3u1fbpfcp-zoom-1.image alt></p><blockquote><p>上面这张图很有用的，在学习网络知识（不管是基础概念还是各种协议）的时候可以为我们提供一个宏观的视角。</p></blockquote><p>网络中的设备数以亿计，一个发送终端怎么可能知道每一台接收终端的 MAC 地址呢，显然，这是不可能的。但是 IP 是知道的，比如我们访问 github，github 每一台服务器的 MAC 地址（准确的说是一个网卡的 MAC 地址，因为一台机器上可能有多个网卡）我们是不知道的，但是它的域名我们都知道，通过域名得到 IP 地址，这是 DNS 的功能，大多数同学都很清楚，所以间接的也就相当于我们知道了 github 的IP。</p><p>但是，为什么我们在做应用层开发的时候不需要关注 MAC 地址。</p><p>根本没有什么岁月静好，只是有人在替我们负重前行罢了。在这里帮我们负重前行的就是 ARP 协议。</p><p>这里面有一个关键点，最终在网络上传输的包，必定是一个数据帧，最常用的就是以太网帧。</p><p>如果我们完全将这一过程当做一个黑盒，可以对照理解为一个程序中封装好的方法，例如 <code>getMacAddressByIP(Long ip) </code>，当我们需要得到 MAC 地址时，直接调用这个方法就可以了。</p><p>ARP 协议全称地址解析协议，用来将 IP 地址解析出 MAC 地址，还有一个与之相对的协议 RARP，全称叫做逆地址解析协议，用来将 MAC 地址解析出 IP 地址。</p><p><img src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aba2b76b0ca84a9c8e91aa685af5cee9~tplv-k3u1fbpfcp-zoom-1.image alt></p><h2 id=arp-的工作过程>ARP 的工作过程</h2><p>ARP 就是工作在一个局域网中的，</p><p>当一台路由器或者一个具有路由转发功能的主机想要通过一个 IP 地址得到对应的 MAC 地址时，就可以使用 ARP 协议了，这个设备向它所在的目标子网中发送一个广播的 ARP 请求，请求中带着这个 IP 地址，意思是说，在这个网络中的各位，谁的 IP 是这个，请回复我一下，并告诉我你的 MAC 地址。收到这个请求的主机对这个 ARP 包进行解析，如果发现携带的 IP 正好是自己的，就返回一个 ARP 回复，回复中带上自己的 MAC 地址。</p><p><img src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/30eac5cf80314eca89b537cbdc9fe504~tplv-k3u1fbpfcp-zoom-1.image alt></p><p>使用 ARP 协议后，目的主机将自己的 IP 地址和 MAC 地址返回给源主机，源主机将 MAC 地址加到以太网帧中，构造成完整的帧格式，再将数据帧通过链路层发出。</p><p>最终数据帧到达目的主机，链路层通过数据帧中的目的 MAC 地址判断数据帧是不是发给自己的，如果是的话，则接收数据帧，并经过层层解析，最终交给应用层对应的程序处理。</p><h2 id=先说说以太网数据帧格式>先说说以太网数据帧格式</h2><p><img src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/982fd7a2e5184f159876bcc2be97d8cf~tplv-k3u1fbpfcp-zoom-1.image alt></p><p><strong>以太网目的地址</strong>：目的端 MAC 地址，6字节。</p><p><strong>以太网源地址</strong>：发送端的 MAC 地址，6字节。</p><p><strong>帧类型</strong>：标记数据部分的类型，如果是 IP 数据报，值为 0x0800，如果是 ARP 数据报，值为 0x0806，2字节。</p><p><strong>数据</strong>：以太帧搭载的数据。只要是在以太网上发送数据，最终都会被链路层封装成以太网数据帧，所以数据部分即可以是 IP 数据报、ARP 协议包、ICMP 数据包等，以太网数据帧数据部分最小长度是 46 字节，最大长度由 MTU 决定，是 1500 字节。</p><p><strong>CRC</strong>：数据检验码，用来在接收端检验接收的数据是不是无差错的，4字节。</p><p>既然大家都是程序员，我们将这个数据帧抽象成一个实体类表示，帮助我们理解。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>EthernetFrame</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 目的 MAC 地址，6字节，48bit
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Byte</span><span class=o>[]</span> <span class=n>destinationMacAddress</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Byte</span><span class=o>[</span><span class=mi>6</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 源 MAC 地址，6字节，48bit
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Byte</span><span class=o>[]</span> <span class=n>sourceMacAddress</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Byte</span><span class=o>[</span><span class=mi>6</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 标记搭载的数据类型,
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果是 IP  数据报，值为 0x0800
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果是 ARP 数据报，值为 0x0806
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Byte</span><span class=o>[]</span> <span class=n>type</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Byte</span><span class=o>[</span><span class=mi>2</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 数据
</span></span></span><span class=line><span class=cl><span class=cm>     * 以太网的数据长度为 46~1500字节。
</span></span></span><span class=line><span class=cl><span class=cm>     * 最短 46   字节，不够的要填充(pad)
</span></span></span><span class=line><span class=cl><span class=cm>     * 最长 1500 字节，以太网的 MTU 决定的
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Byte</span><span class=o>[]</span> <span class=n>data</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Byte</span><span class=o>[</span><span class=mi>46</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 检验码 4 字节，在帧尾部
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Byte</span><span class=o>[]</span> <span class=n>crc</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Byte</span><span class=o>[</span><span class=mi>4</span><span class=o>];</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=arp-协议格式>ARP 协议格式</h2><p>以下是 ARP 协议的格式，以及一对完整的 ARP 请求数据帧和应答数据帧。</p><p><img src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f1b59aafe469487796a9f2301d07c4d6~tplv-k3u1fbpfcp-zoom-1.image alt></p><p><strong>硬件类型</strong>：2字节，用来表示硬件地址的类型，为 1 表示以太网地址。</p><p><strong>协议类型</strong>：2字节，用来表示要映射的协议地址类型。ARP 不仅可以表示要将 IP 转换为 MAC ，还允许其他的转换关系，例如将另外一种非 IP 地址转换为 MAC 地址。当它的值为<code>0x0800</code>表示 IP 地址，与包含IP数据报的以太网数据帧中的类型字段的值相同。</p><p><strong>硬件地址长度</strong>：1字节，用来表示硬件地址的长度，单位是字节。在以太网中就是 MAC 地址的长度，值为6，也就表示 MAC 地址长度为 6 字节。</p><p><strong>协议地址长度</strong>：1字节，用来表示协议地址的长度，单位是字节。在以太网中，如果协议类型是 IP，也就是要将 IP 转换为 MAC 时，它的值是 4 ，也就是4字节，表示 IP 地址的长度是 4 字节。</p><p><strong>操作字段</strong>：2字节，用来表示当前操作的类型。值为1，表示 ARP 请求；值为2，表示 ARP 应答；值为3，表示 RARP 请求；值为4，表示 RARP 应答。此字段是用来区分请求和应答的必需字段。</p><p><strong>发送端以太网地址</strong>：6字节，用来表示发送端的以太网 MAC 地址。</p><p><strong>发送端 IP 地址</strong>：4字节，用来表示发送端的 IP 地址。</p><p><strong>目的以太网地址</strong>：6字节，用来表示目的端的 MAC 地址。</p><p><strong>目的 IP 地址</strong>：4字节，用来表示目的端的 IP 地址。</p><p>整个 ARP 协议部分共 28字节，但是在以太网中，一个以太网数据帧数据最小长度为 46，所以，后面要有18字节的数据填充。</p><p>操作字段为1表示这是一个 ARP 请求，ARP 请求是个广播消息，请求数据中没有目的 MAC 地址，因为还不知道嘛，我们要找的就是它。之后，ARP 应答消息（操作字段是2）将本机的 MAC 地址放到源MAC地址中，并且将 ARP 请求中的MAC地址替换为目的 MAC 地址，用来告知 ARP 发送端。</p><p>还是用一个实现类来表示 ARP 协议中的各个字段。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Arp</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 硬件类型，2字节，值为1表示以太网
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Byte</span><span class=o>[]</span> <span class=n>hardwareType</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Byte</span><span class=o>[</span><span class=mi>2</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 协议类型，2字节，要映射的协议地址类型
</span></span></span><span class=line><span class=cl><span class=cm>     * 0x0800 表示要转换的源协议为 IP 协议
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Byte</span><span class=o>[]</span> <span class=n>protocolType</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Byte</span><span class=o>[</span><span class=mi>2</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 硬件地址长度，1字节，表示硬件地址的长度，单位为字节
</span></span></span><span class=line><span class=cl><span class=cm>     * 硬件地址长度在以太网表示 MAC 地址的长度，值为6，也就是 6 字节
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Byte</span><span class=o>[]</span> <span class=n>hardwareAddressLength</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Byte</span><span class=o>[</span><span class=mi>1</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 协议地址长度，1字节，表示协议地址的长度，单位为字节
</span></span></span><span class=line><span class=cl><span class=cm>     * 在以太网转换 IP 为 MAC 地址时，就表示为 IP 地址的长度，也就是4字节
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Byte</span><span class=o>[]</span> <span class=n>protocolAddressLength</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Byte</span><span class=o>[</span><span class=mi>1</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 操作字段，2字节，表示操作类型
</span></span></span><span class=line><span class=cl><span class=cm>     * 1：ARP 请求
</span></span></span><span class=line><span class=cl><span class=cm>     * 2：ARP 应答
</span></span></span><span class=line><span class=cl><span class=cm>     * 3：RARP 请求
</span></span></span><span class=line><span class=cl><span class=cm>     * 4：RARP 应答
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Byte</span><span class=o>[]</span> <span class=n>op</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Byte</span><span class=o>[</span><span class=mi>2</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 发送端 MAC 地址，6字节
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Byte</span><span class=o>[]</span> <span class=n>sourceMacAddress</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Byte</span><span class=o>[</span><span class=mi>6</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 发送端 IP 地址，4字节
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Byte</span><span class=o>[]</span> <span class=n>sourceIpAddress</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Byte</span><span class=o>[</span><span class=mi>4</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 目的端 MAC 地址，6字节
</span></span></span><span class=line><span class=cl><span class=cm>     * 在 ARP 请求中，这个地址为空
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Byte</span><span class=o>[]</span> <span class=n>destinationMacAddress</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Byte</span><span class=o>[</span><span class=mi>6</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 目的端 IP 地址，4字节
</span></span></span><span class=line><span class=cl><span class=cm>     * 接收 ARP 广播的主机通过 IP 地址判断是否回复 ARP 应答(IP 地址的所有者)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Byte</span><span class=o>[]</span> <span class=n>destinationIpAddress</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Byte</span><span class=o>[</span><span class=mi>4</span><span class=o>];</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=用-wireshark-抓个包>用 Wireshark 抓个包</h2><p>打开 Wireshark ，开始抓包，等待一会儿，然后停止抓包。你电脑中的各个程序会偷偷的发送和应答很多 ARP 包，</p><p><img src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6dfb0ec84b4c487dac7f6d9c44dbe079~tplv-k3u1fbpfcp-zoom-1.image alt></p><p>在 Wireshark 中过滤 <code>arp.opcode == 1</code>的 ARP 请求，然后找到其中一个。用 Wireshark 分析包特别直观，我们用鼠标点击上方的某个字段时，下面会自动将这个字段的值标记出来，这样就可以清楚的看到这个字段在整个数据包中的位置了。例如下图选中了 ARP 包中的 Opcode字段（操作字段），下面的 <code>00 01</code> 被标记了，这是用 16 进制表示的，<code>00</code>表示一个字节，<code>01</code>表示一个字节，表示这个操作字段是2个字节，值是1，也就是ARP 请求。</p><p><img src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8a4fcdcb96664a9ca5eb032eb48e65f5~tplv-k3u1fbpfcp-zoom-1.image alt=image-20220916144713709></p><p><strong>简单分析一下这个包</strong></p><p><img src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/55d8e765164644de8faef8165085d8bf~tplv-k3u1fbpfcp-zoom-1.image alt></p><p>图中 1、2、3 三个部分分别是以太网帧概要信息、以太网数据帧首部、以太网数据帧数据内容。在第一部分概要信息可以看到这个帧的总大小是 60 bytes，以太网数据帧头部的14 字节，加上内容部分最少46字节，刚好是 60 字节，其实还有一个 CRC （数据检验码），只不过本地网卡会自动剥离掉，所以在 Wireshark 中是看不到的。</p><p><strong>以太网数据帧首部</strong></p><p><img src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/800f221f14944670886d88fbb2438811~tplv-k3u1fbpfcp-zoom-1.image alt></p><p>上图是以太网数据帧首部信息。</p><p>1、目的 MAC 地址，都是 <code>ff</code>，表示这是个广播请求，ARP 请求本身就是广播的。</p><p>2、源 MAC 地址，本机的 MAC 地址。</p><p>3、帧类型，ARP 类型。</p><p>4、因为以太网帧数据部分最小是 46 字节，ARP 只有28字节，所以要填充18字节。</p><p><strong>ARP 请求信息</strong></p><p><img src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d25913760b4a42f484d320126d46457e~tplv-k3u1fbpfcp-zoom-1.image alt></p><p>从上到下依次是硬件类型、协议类型、硬件地址长度、协议地址长度（一般就是IP地址）、操作字段、发送端 MAC 地址、发送端 IP 地址、目标 MAC 地址、目标 IP 地址。</p><p>使用 wireshark 的 filter <code>arp.opcode == 2</code> 可过滤出 APR 请求。</p><p>是不是完全听明白了，回头发现，就是我开头总结的那几点内容。</p><p>自己学容易，写出来真难啊，如果对各位有一点点帮助当然最好了。</p></article><div class=toc><h2>文章目录</h2><nav id=TableOfContents><ul><li><a href=#为什么需要-arp-协议>为什么需要 ARP 协议</a></li><li><a href=#arp-的工作过程>ARP 的工作过程</a></li><li><a href=#先说说以太网数据帧格式>先说说以太网数据帧格式</a></li><li><a href=#arp-协议格式>ARP 协议格式</a></li><li><a href=#用-wireshark-抓个包>用 Wireshark 抓个包</a></li></ul></nav></div><script>window.addEventListener("scroll",function(){var e=document.querySelector(".toc"),t=window.pageYOffset||document.documentElement.scrollTop,n=window.innerWidth||document.documentElement.clientWidth;t<360?e.style.top=380-t+"px":e.style.top="20px"})</script><h4>相关文章</h4><dl class=row><dd class=col-md-9><a href=/category/network/%E9%87%8D%E5%AD%A6%E4%BA%86%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%95%A5%E6%9C%89%E5%B0%8F%E6%88%90%E7%BB%8F%E9%AA%8C%E5%85%A8%E9%83%A8%E5%88%86%E4%BA%AB%E5%87%BA%E6%9D%A5/>0. 重学了计算机网络，略有小成，经验全部分享出来</a></dd><dd class=col-md-9><a href=/category/network/%E5%AE%8F%E8%A7%82%E4%B8%8A%E7%90%86%E8%A7%A3%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B-%E5%9C%A8%E7%9B%B4%E5%8D%87%E9%A3%9E%E6%9C%BA%E4%B8%8A%E7%9C%8B%E7%BD%91%E7%BB%9C/>1. 宏观上理解网络模型-在直升飞机上看网络</a></dd><dd class=col-md-9><a href=/category/network/20%E5%BC%A0%E5%9B%BE%E8%AF%B4%E6%B8%85%E6%A5%9A-IP-%E5%8D%8F%E8%AE%AE/>3. 20张图说清楚 IP 协议</a></dd><dd class=col-md-9><a href=/category/network/30%E5%BC%A0%E5%9B%BE%E8%AF%B4%E6%B8%85%E6%A5%9A-TCP-%E5%8D%8F%E8%AE%AE/>4. 30张图说清楚 TCP 协议</a></dd><dd class=col-md-9><a href=/category/network/ICMP/>5. 为什么说 ICMP 协议是网络最强辅助</a></dd></dl><div class=author-card><div class=underline></div><div class=author-box><div class=qr-author-image><a href=/><img src=/images/person.jpg alt=风筝></a></div><div class=author-content><p class=author-title>作者</p><p class=author-name>风筝</p><p class=author-desc>古时的风筝，一个平庸的程序员，主语言 Java，第二语言 Python，其实学 Python 的时间比 Java 还要早。喜欢写博客，写博客的过程能加深自己对一个知识点的理解，同时还可以分享给他人。喜欢做一些小东西，所以也会一些前端的东西，React、JavaScript、CSS 都会一些，做一些小工具还够用。</p></div></div></div><script src=https://utteranc.es/client.js repo=huzhicheng/blog-comment issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></main><div class="footer gradient-2"><div class="container footer-container"><div class=row><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>网站地图</div><ul class=list-unstyled><li><a href=https://www.moonkite.cn/tags/>标签</a></li><li><a href=https://www.moonkite.cn/categories/>分类</a></li><li><a rel=alternate type=application/rss+xml href=https://www.moonkite.cn/index.xml><i class="fas fa-rss-square"></i> RSS订阅</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>社群</div><ul class=list-unstyled><li><a href=https://github.com/huzhicheng rel=noopener target=_blank>GitHub</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>友链</div><ul class=list-unstyled><li><a href=https://github.com/huzhicheng rel=noopener target=_blank>关于我</a></li></ul></div><div class="col-xs-12 col-sm-3 col-md-3 col-lg-3"><p class="pull-right text-right"><small><em>Proudly powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo</a></em></small><br><small><em>Theme - <a href=https://github.com/shaform/hugo-theme-den rel=noopener target=_blank>Den</a></em></small><br><small>&copy;
风筝
2023</small></p></div></div><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?e417ddf834c7bb7411207e1fa09815aa",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-C714TFXRD4"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-C714TFXRD4")</script><div class=busuanzi-footer><span id=busuanzi_container_site_pv>本站总访问量<span id=busuanzi_value_site_pv></span>次</span>
<span id=busuanzi_container_site_uv>本站访客数<span id=busuanzi_value_site_uv></span>人次</span></div></div></div><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap_4.1.3_js_bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script>$(document).ready(function(){$("#load_disqus").length&&$(window).scroll(function(){if($("#load_disqus").length){var e=$("#load_disqus").offset().top,t=$(window).scrollTop(),n=t+$(window).height();t<e&&e<n&&load_disqus()}})})</script></body></html>